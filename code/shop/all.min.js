angular.module("features",[]),angular.module("resources",["ngResource"]),angular.module("shop",["ngResource","features","loaders","ngRoute","shop.resources","notification","shop.controllers","mm.foundation","resources","constants"]).run(["$rootScope",function(a){a.requests=0}]),angular.module("shop.resources",["ngResource"]).factory("Resources",["$resource",function(a){var b=a("/api/features/:id",{id:"@id"},{}),c=a("/api/accounts/:accountId/accountcard",{accountId:"@accountId"},{}),d=a("/api/invoices/:invoiceId",{invoiceId:"@invoiceId"},{put:{method:"PUT"}}),e=a("/api/invoices/:invoiceId/pay",{invoiceId:"@invoiceId"},{});return{Feature:b,AccountCard:c,Invoice:d,StripeCharge:e}}]);var appCtrls=angular.module("shop.controllers",[]);appCtrls.controller("shopController",["$scope","$http","Resources","FEATURES","ACCOUNT_ID","$notification","$AjaxInterceptor","$location","AccountFeature","USER_ID","VENUE_ID",function(a,b,c,d,e,f,g,h,i,j,k){function l(){if(""!=h.path()){var b=h.path().split("/");if(console.log("parts1",b[1],"feature"===b[1]),"feature"===b[1]){var c=Number(b[2]);console.log("got feature id :",c),a.setSelectedFeature(c),$("#featureModal").foundation("reveal","open"),h.path("")}}}function m(){var b=window.sessionStorage.getItem("featureCard");b&&"false"!=b&&(b=angular.fromJson(b),b.card&&(a.setSelectedFeature(b.feature),window.sessionStorage.setItem("featureCard",!1),o(a.selectedFeature.feature,!0)))}function n(){i.query({accountId:e},function(b){a.accountFeatures=b,m(),g.complete(),l()})}function o(b,c){g.start(),i.getPrice({accountId:e,featureId:b.id},function(d){a.price=d,b.contractMonths&&(a.price.contractMonths=b.contractMonths),c?a.showDialog("purchase"):a.dismissAndShowDialog("purchase"),g.complete()})}function p(b){console.log("lenght:",a.PremiumFeatures.length),console.log(a.PremiumFeatures);for(var c=0,d=a.PremiumFeatures.length;d>c;c++){var e=a.PremiumFeatures[c];if(console.log(b,e),e.id===b)return e}}function q(){g.start();var b=a.selectedFeature.feature;i.save({accountId:e,featureId:b.id},function(b){console.log("response:",b),"SUCCESS"===b.status&&(n(),a.showDialog("success")),g.complete()},function(){a.showDialog("trial"),s(),g.complete()})}function r(b){g.start();var f=a.selectedFeature.feature;c.AccountCard.get({accountId:e},function(c){c.token&&null!=c.token&&(console.log("here ho",b.discountCode,j),i.save({accountId:e,featureId:f.id,userId:j,venueId:k,code:b.discountCode},function(b){if(g.complete(),"SUCCESS"===b.status)n(),a.showDialog("success");else{var c=JSON.parse(b.response);a.paymentFailedMessage=c.detail_message,a.showDialog("paymentError")}},function(b){if(g.complete(),412==b.status){var c=b.data.message;c=c.replace("[","").replace("]",""),c=c.split(","),a.featureDepends=[];for(var e=0,f=c.length;f>e;e++){var h=c[e];a.featureDepends.push({id:+h,name:d.filter(function(a){return a.id==h})[0].name})}a.showDialog("depends")}else s()}))},function(b){b.data&&404===b.data.status?a.showDialog("noPayment"):s()})}function s(){noty({type:"error",layout:"topCenter",text:_tr("Sorry, but there's been an error processing your request.")})}g.start(),a.currentScreenshot=0,a.PremiumFeatures=d,a.accountFeatures=[],a.finishedLoading=!1,n(),a.getScreenshot=function(){return a.selectedFeature?a.selectedFeature.feature.promoImgs[a.currentScreenshot]:""},a.showNextScreenshot=function(){a.selectedFeature&&a.selectedFeature.feature.promoImgs.length-1>a.currentScreenshot?a.currentScreenshot++:console.log("else",a.selectedFeature)},a.showPreviousScreenshot=function(){a.currentScreenshot>0&&a.currentScreenshot--},a.setSelectedFeature=function(b){a.currentScreenshot=0,a.selectedFeature={index:b,feature:p(b)},setTimeout(function(){$("html, body").animate({scrollTop:0},"fast")},100)},a.dismissAndShowDialog=function(b){console.log("dismissing"),$("#featureModal").on("closed",function c(){a.showDialog(b),$(this).off("closed",c)}),$("#featureModal").foundation("reveal","close")},a.clickBuy=function(){var b=a.selectedFeature.feature,d=function(){c.AccountCard.get({accountId:e},function(){o(a.selectedFeature.feature)},function(b){b.data&&404===b.data.status?a.dismissAndShowDialog("noPayment"):s()})};if(b.hasOwnProperty("depends")&&b.depends.length){for(var f=[],g=0,h=b.depends.length;h>g;g++){var i=a.accountFeatures.filter(function(a){return a.featureId==b.depends[g]});if(!i||i&&!i.length){var j=p(b.depends[g]);f.push({id:b.depends[g],name:j.name})}}f.length?(a.featureDepends=f,a.dismissAndShowDialog("depends")):d()}else d()},a.clickGetInTouch=function(){document.location.href="mailto:hello@preoday.com?subject=Please contact me regarding Enterprise",$("#featureModal").foundation("reveal","close")},a.showDialog=function(b){var c=a.selectedFeature.feature;console.log(c);var d,e,g=null;switch(b){case"purchase":g={title:c.name,scope:a.price,templateUrl:"purchase.php",showTerm:c.$terms&&c.$terms.purchase?c.$terms.purchase:!1,btnOk:_tr("BUY"),windowClass:"small"},d=r;break;case"trial":g={title:c.name+" - "+c.trialPeriod+_tr(" DAY FREE TRIAL"),showTerm:c.$terms&&c.$terms.trial?c.$terms.trial:!1,btnOk:_tr("START TRIAL"),windowClass:"medium"},d=q;break;case"success":if(c.hasOwnProperty("$link")&&c.$link)window.sessionStorage.setItem("firsttime_feature_"+c.id,1),a.navigateTo(c.$link);else if(g={showTerm:!1,btnCancel:_tr("OK"),btnOk:!1,windowClass:"medium"},c.hasOwnProperty("modal")&&c.modal&&c.modal.hasOwnProperty("success")){var h=c.modal.success;g.title=h.title?h.title:_tr("Your new Premium Feature is now live!"),g.content=h.content instanceof Array?h.content.join("<br />"):h.content}else g.title=_tr("Your new Premium Feature is now live!"),g.content=_tr("You will be contacted shortly by a member of our team. You can manage subscriptions from your <a href='/accountSettings#/subscription'>account settings page.</a>");break;case"paymentError":g={title:_tr("Error"),content:a.paymentFailedMessage,showTerm:!1,btnOk:_tr("PAYMENT METHOD"),windowClass:"medium"},d=function(){a.navigateTo("/accountSettings#/paymentMethod")};break;case"noPayment":g={content:_tr("Please add a payment method to your account in order to subscribe to Premium Features"),showTerm:!1,btnOk:_tr("ADD CARD"),windowClass:"medium"},d=function(){window.sessionStorage.setItem("featureCard",angular.toJson({feature:c.id,card:!1})),a.navigateTo("/accountSettings#/paymentMethod")};break;case"depends":var i=a.featureDepends.map(function(a){return a.name}).join(", ");g={content:_tr("To access this feature you need to have ")+i+_tr(" installed first "),showTerm:!1,btnOk:_tr("BUY ")+i,windowClass:"medium"},d=function(){console.log("clicou ok ",a.featureDepends[0].id,a.featureDepends),a.setSelectedFeature(a.featureDepends[0].id),$("#featureModal").foundation("reveal","open")}}g&&f.confirm(g).then(d,e)},a.navigateTo=function(a){window.location.assign(a)},a.getFeatureStatus=function(b){var c=!1;return b&&a.accountFeatures&&a.accountFeatures.length>0&&angular.forEach(a.accountFeatures,function(a){b.id==a.featureId&&(c=a.status)}),c},a.getExpiryDate=function(b){var c=0;return b&&a.accountFeatures&&a.accountFeatures.length>0&&angular.forEach(a.accountFeatures,function(a){b.id==a.featureId&&null!==a.endDate&&(c=Math.floor((new Date(a.endDate).getTime()-(new Date).getTime())/864e5))}),c}}]),angular.module("notification",["ngSanitize"]).controller("confirmModalController",["$scope","$modalInstance","data","deffered","$http","$templateCache","$compile","$sce","$timeout","AccountFeature","ACCOUNT_ID","VENUE_ID","USER_ID",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n="/code/notification/templates/";if(a.title=c.title||"",a.discountCode="",a.appliedDiscount=!1,c.hasOwnProperty("templateFullUrl")&&c.templateFullUrl)angular.extend(a,c.scope);else if(c.hasOwnProperty("templateUrl")&&c.templateUrl){a.templateUrl=c.templateUrl;var o=function(b){i(function(){angular.element("#contentPartial").html(g(b)(a))})},p=f.get(n+c.templateUrl);p?o(p):e.get(n+c.templateUrl).then(function(a){f.put(n+c.templateUrl,a.data),o(a.data)})}else a.content=c.content||"";c.hasOwnProperty("scope")&&c.scope&&(a=angular.extend(a,c.scope)),a.toTrusted=function(a){return h.trustAsHtml(a||"")},a.showTerm=c.showTerm||!1,a.acceptTerm=!1,a.btnOk=c.btnOk===!1?!1:c.btnOk||_tr("OK"),c.btnCancel===!1?c.btnCancel=!1:a.btnCancel=c.btnCancel||_tr("CANCEL"),a.changeTerm=function(b){a.acceptTerm=b},a.send=function(){b.close();var c={acceptTerm:a.acceptTerm};a.appliedDiscount&&(c.discountCode=a.discountCode),d.resolve(c)},a.cancel=function(){b.close(),d.reject({acceptTerm:a.acceptTerm})},a.validateDiscountCode=function(){a.errorMsg="",a.discountCode||(a.errorMsg=_tr("Please enter a discount code")),j.getPrice({accountId:k,featureId:a.featureId,code:a.discountCode.toUpperCase(),venueId:l,userId:m},function(b){angular.extend(a,b),a.appliedDiscount=!0},function(b){400===b.status&&b.data&&(a.errorMsg=b.data.message)})}}]).service("$notification",["$modal","$q","$sce",function(a,b){var c="/code/notification/templates/",d=function(d){var e=b.defer();d=d||{},d.hasOwnProperty("templateFullUrl")&&d.templateFullUrl&&(d.templateFullUrl=c+d.templateFullUrl);var f=a.open({templateUrl:d.templateFullUrl||"/code/notification/notification.php",windowClass:"modal-preoday "+(d.windowClass||""),controller:"confirmModalController",resolve:{data:function(){return d},deffered:function(){return e}}});return f.opened.then(function(){setTimeout(function(){var a=0;$(".notificationButtons button").each(function(){a=a>$(this).width()?a:$(this).width()}).width(a),$(".modal-preoday").addClass("active")},400)}),e.promise};return{confirm:d}}]),angular.module("loaders",[]).service("$AjaxInterceptor",["$rootScope","$timeout",function(a,b){function c(){var a=document.getElementsByClassName(".loading-content");if(a.length>0){(new Spinner).spin(a[0])}}return{start:function(){++a.requests,c()},complete:function(){b(function(){a.requests>0&&--a.requests},100)},isRequesting:function(){return a.requests>0}}}]),angular.module("resources").factory("AccountFeature",["$resource",function(a){var b=a("/api/accounts/:accountId/features/:featureId",{accountId:"@accountId",featureId:"@featureId"},{save:{method:"POST",params:{accountId:"@accountId",featureId:"@featureId",userId:"@userId",venueId:"@venueId",code:"@code"}},put:{method:"PUT"},getPrice:{method:"GET",url:"/api/accounts/:accountId/features/:featureId/price"}});return b.prototype.getLink=function(){return this.feature&&this.feature.$link?this.feature.$link:!1},b.prototype.isInContractPeriod=function(){if(this.feature&&this.feature.contractMonths){var a=moment(this.startDate),b=a.add(this.feature.contractMonths,"month");if(moment().valueOf()<b.valueOf())return!0}return!1},b.prototype.getContractEnd=function(){var a=moment(this.startDate),b=a.add(this.feature.contractMonths,"month");return b.toDate()},b}]);