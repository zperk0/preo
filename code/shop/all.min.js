angular.module("features",[]),angular.module("shop",["ngResource","features","loaders","ngRoute","shop.resources","notification","shop.controllers","mm.foundation"]).run(["$rootScope",function(a){a.requests=0}]),angular.module("shop.resources",["ngResource"]).factory("Resources",["$resource",function(a){var b=a("/api/features/:id",{id:"@id"},{}),c=a("/api/accounts/:accountId/accountcard",{accountId:"@accountId"},{}),d=a("/api/accounts/:accountId/features/:featureId",{accountId:"@accountId",featureId:"@featureId"},{put:{method:"PUT"},getPrice:{method:"GET",url:"/api/accounts/:accountId/features/:featureId/price"}}),e=a("/api/invoices/:invoiceId",{invoiceId:"@invoiceId"},{put:{method:"PUT"}}),f=a("/api/invoices/:invoiceId/pay",{invoiceId:"@invoiceId"},{});return{Feature:b,AccountCard:c,AccountFeatures:d,Invoice:e,StripeCharge:f}}]);var appCtrls=angular.module("shop.controllers",[]);appCtrls.controller("shopController",["$scope","$http","Resources","FEATURES","ACCOUNT_ID","$notification","$AjaxInterceptor","$location",function(a,b,c,d,e,f,g,h){function i(){if(""!=h.path()){var b=h.path().split("/");if(console.log("parts1",b[1],"feature"===b[1]),"feature"===b[1]){var c=Number(b[2]);console.log("got feature id :",c),a.setSelectedFeature(c),$("#featureModal").foundation("reveal","open"),h.path("")}}}function j(){var b=window.sessionStorage.getItem("featureCard");b&&"false"!=b&&(b=angular.fromJson(b),b.card&&(a.setSelectedFeature(b.feature),window.sessionStorage.setItem("featureCard",!1),l(a.selectedFeature.feature,!0)))}function k(){c.AccountFeatures.query({accountId:e},function(b){a.accountFeatures=b,j(),g.complete(),i()})}function l(b,d){g.start(),c.AccountFeatures.getPrice({accountId:e,featureId:b.id},function(b){a.price=b,d?a.showDialog("purchase"):a.dismissAndShowDialog("purchase"),g.complete()})}function m(b){console.log("lenght:",a.PremiumFeatures.length),console.log(a.PremiumFeatures);for(var c=0;c<=a.PremiumFeatures.length;c++){var d=a.PremiumFeatures[c];if(console.log(b,d),d.id===b)return d}}function n(){g.start();var b=a.selectedFeature.feature;c.AccountFeatures.save({accountId:e,featureId:b.id},function(b){console.log("response:",b),"SUCCESS"===b.status&&(k(),a.showDialog("success")),g.complete()},function(){a.showDialog("trial"),p(),g.complete()})}function o(){g.start();var b=a.selectedFeature.feature;c.AccountCard.get({accountId:e},function(d){d.token&&null!=d.token&&c.AccountFeatures.save({accountId:e,featureId:b.id},function(b){if(g.complete(),"SUCCESS"===b.status)k(),a.showDialog("success");else{var c=JSON.parse(b.response);a.paymentFailedMessage=c.detail_message,a.showDialog("paymentError")}},function(){g.complete(),p()})},function(b){b.data&&404===b.data.status?a.showDialog("noPayment"):p()})}function p(){noty({type:"error",layout:"topCenter",text:_tr("Sorry, but there's been an error processing your request.")})}g.start(),a.currentScreenshot=0,a.PremiumFeatures=d,a.accountFeatures=[],a.finishedLoading=!1,k(),a.getScreenshot=function(){return a.selectedFeature?a.selectedFeature.feature.promoImgs[a.currentScreenshot]:""},a.showNextScreenshot=function(){a.selectedFeature&&a.selectedFeature.feature.promoImgs.length-1>a.currentScreenshot?a.currentScreenshot++:console.log("else",a.selectedFeature)},a.showPreviousScreenshot=function(){a.currentScreenshot>0&&a.currentScreenshot--},a.setSelectedFeature=function(b){a.currentScreenshot=0,a.selectedFeature={index:b,feature:m(b)},setTimeout(function(){$("html, body").animate({scrollTop:0},"fast")},100)},a.dismissAndShowDialog=function(b){console.log("dismissing"),$("#featureModal").on("closed",function c(){a.showDialog(b),$(this).off("closed",c)}),$("#featureModal").foundation("reveal","close")},a.clickBuy=function(){c.AccountCard.get({accountId:e},function(){l(a.selectedFeature.feature)},function(b){b.data&&404===b.data.status?a.dismissAndShowDialog("noPayment"):p()})},a.clickGetInTouch=function(){document.location.href="mailto:hello@preoday.com?subject=Please contact me regarding Enterprise",$("#featureModal").foundation("reveal","close")},a.showDialog=function(b){var c=a.selectedFeature.feature;console.log(c);var d,e,g=null;switch(b){case"purchase":g={title:c.name,scope:a.price,templateUrl:"purchase.htm",showTerm:c.$terms&&c.$terms.purchase?c.$terms.purchase:!1,btnOk:_tr("BUY"),windowClass:"small"},d=o;break;case"trial":g={title:c.name+" - "+c.trialPeriod+_tr(" DAY FREE TRIAL"),showTerm:c.$terms&&c.$terms.trial?c.$terms.trial:!1,btnOk:_tr("START TRIAL"),windowClass:"medium"},d=n;break;case"success":c.hasOwnProperty("$link")&&c.$link?(window.sessionStorage.setItem("firsttime_feature_"+c.id,1),a.navigateTo(c.$link)):g={title:_tr("Your new Premium Feature is now live!"),content:_tr("You will be contacted shortly by a member of our team. You can manage subscriptions from your <a href='/accountSettings#/subscription'>account settings page.</a>"),showTerm:!1,btnCancel:_tr("OK"),btnOk:!1,windowClass:"medium"};break;case"paymentError":g={title:_tr("Error"),content:a.paymentFailedMessage,showTerm:!1,btnOk:_tr("PAYMENT METHOD"),windowClass:"medium"},d=function(){a.navigateTo("/accountSettings#/paymentMethod")};break;case"noPayment":g={content:_tr("Please add a payment method to your account in order to subscribe to Premium Features"),showTerm:!1,btnOk:_tr("ADD CARD"),windowClass:"medium"},d=function(){window.sessionStorage.setItem("featureCard",angular.toJson({feature:c.id,card:!1})),a.navigateTo("/accountSettings#/paymentMethod")}}g&&f.confirm(g).then(d,e)},a.navigateTo=function(a){window.location.assign(a)},a.getFeatureStatus=function(b){var c=!1;return b&&a.accountFeatures&&a.accountFeatures.length>0&&angular.forEach(a.accountFeatures,function(a){b.id==a.featureId&&(c=a.status)}),c},a.getExpiryDate=function(b){var c=0;return b&&a.accountFeatures&&a.accountFeatures.length>0&&angular.forEach(a.accountFeatures,function(a){b.id==a.featureId&&null!==a.endDate&&(c=Math.floor((new Date(a.endDate).getTime()-(new Date).getTime())/864e5))}),c}}]),angular.module("notification",["ngSanitize"]).controller("confirmModalController",["$scope","$modalInstance","data","deffered","$http","$templateCache","$compile","$sce",function(a,b,c,d,e,f,g,h){var i="/code/notification/templates/";if(a.title=c.title||"",c.hasOwnProperty("templateFullUrl")&&c.templateFullUrl)angular.extend(a,c.scope);else if(c.hasOwnProperty("templateUrl")&&c.templateUrl){a.templateUrl=c.templateUrl;var j=function(b){var d=a.$new();angular.extend(d,c.scope),$timeout(function(){angular.element("#contentPartial").html(g(b)(d))})},k=f.get(i+c.templateUrl);k?j(k):e.get(i+c.templateUrl).then(function(a){f.put(i+c.templateUrl,a.data),j(a.data)})}else a.content=c.content||"";c.hasOwnProperty("scope")&&c.scope&&(a=angular.extend(a,c.scope)),a.toTrusted=function(a){return h.trustAsHtml(a||"")},a.showTerm=c.showTerm||!1,a.acceptTerm=!1,a.btnOk=c.btnOk===!1?!1:c.btnOk||_tr("OK"),c.btnCancel===!1?c.btnCancel=!1:a.btnCancel=c.btnCancel||_tr("CANCEL"),a.changeTerm=function(b){a.acceptTerm=b},a.send=function(){b.close(),d.resolve({acceptTerm:a.acceptTerm})},a.cancel=function(){b.close(),d.reject({acceptTerm:a.acceptTerm})}}]).service("$notification",["$modal","$q","$sce",function(a,b){var c="/code/notification/templates/",d=function(d){var e=b.defer();d=d||{},d.hasOwnProperty("templateFullUrl")&&d.templateFullUrl&&(d.templateFullUrl=c+d.templateFullUrl);var f=a.open({templateUrl:d.templateFullUrl||"/code/notification/notification.htm",windowClass:"modal-preoday "+(d.windowClass||""),controller:"confirmModalController",resolve:{data:function(){return d},deffered:function(){return e}}});return f.opened.then(function(){setTimeout(function(){var a=0;$(".notificationButtons button").each(function(){a=a>$(this).width()?a:$(this).width()}).width(a),$(".modal-preoday").addClass("active")},400)}),e.promise};return{confirm:d}}]),angular.module("loaders",[]).service("$AjaxInterceptor",["$rootScope","$timeout",function(a,b){function c(){var a=document.getElementsByClassName(".loading-content");if(a.length>0){(new Spinner).spin(a[0])}}return{start:function(){++a.requests,c()},complete:function(){b(function(){a.requests>0&&--a.requests},100)},isRequesting:function(){return a.requests>0}}}]);