"use strict";angular.module("features",[]),angular.module("kyc.controllers",[]),angular.module("kyc.resources",[]),angular.module("kyc.charts",[]),angular.module("kyc.services",[]),angular.module("kyc.directives",[]),angular.module("kyc.reports",[]),angular.module("kyc",["ngRoute","ngResource","ngSanitize","kyc.directives","kyc.resources","kyc.services","kyc.charts","kyc.controllers","kyc.resources","kyc.filters","kyc.reports","loaders","notification","mm.foundation"]).run(["$rootScope","ACCOUNT_ID","$http",function($rootScope,ACCOUNT_ID,$http){$rootScope.requests=0,$http.get("/api/accounts/"+ACCOUNT_ID+"/features").then(function(result){var found=!1;result&&result.data&&angular.forEach(result.data,function(accountFeature){4!==accountFeature.featureId||"INSTALLED"!==accountFeature.status&&"TRIAL"!==accountFeature.status||(found=!0)}),found||window.location.replace("/shop#/feature/4")})}]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/dashboard",{templateUrl:"/code/kyc/partials/dashboard.php",controller:"DashboardCtrl",resolve:{load:["$route","AllCharts","$AjaxInterceptor",function($route,AllCharts,$AjaxInterceptor){return $AjaxInterceptor.start(),AllCharts.promise}]}}),$routeProvider.when("/stock",{templateUrl:"/code/kyc/partials/stock.php",controller:"StockCtrl",resolve:{load:["$route","OrderService","$AjaxInterceptor",function($route,OrderService,$AjaxInterceptor){return $AjaxInterceptor.start(),OrderService.load()}]}}),$routeProvider.when("/customers",{templateUrl:"/code/kyc/partials/customers.php",controller:"CustomersCtrl",resolve:{load:["$route","OrderService","$AjaxInterceptor",function($route,OrderService,$AjaxInterceptor){return $AjaxInterceptor.start(),OrderService.load()}]}}),$routeProvider.when("/reports",{templateUrl:"/code/kyc/partials/reports.php",controller:"ReportsCtrl",resolve:{load:["$route","AllReports","$AjaxInterceptor",function($route,AllReports,$AjaxInterceptor){return $AjaxInterceptor.start(),AllReports.init()}]}}),$routeProvider.when("/stream",{templateUrl:"/code/kyc/partials/stream.php",controller:"StreamCtrl",resolve:{load:["$route","OrderService","$AjaxInterceptor",function($route,OrderService,$AjaxInterceptor){return $AjaxInterceptor.start(),OrderService.load()}]}}),$routeProvider.otherwise({redirectTo:"/dashboard"})}]),angular.module("notification",["ngSanitize"]).controller("confirmModalController",["$scope","$modalInstance","data","deffered","$http","$templateCache","$compile","$sce",function($scope,$modalInstance,data,deffered,$http,$templateCache,$compile,$sce){var templatePath="/code/notification/templates/";$scope.title=data.title||"",data.hasOwnProperty("templateFullUrl")&&data.templateFullUrl?angular.extend($scope,data.scope):data.hasOwnProperty("templateUrl")&&data.templateUrl?($scope.templateUrl=data.templateUrl,$http.get(templatePath+data.templateUrl).then(function(response){var scopeChild=$scope.$new();angular.extend(scopeChild,data.scope),angular.element("#contentPartial").html($compile(response.data)(scopeChild))})):$scope.content=data.content||"",data.hasOwnProperty("scope")&&data.scope&&($scope=angular.extend($scope,data.scope)),$scope.toTrusted=function(html){return $sce.trustAsHtml(html||"")},$scope.showTerm=data.showTerm||!1,$scope.acceptTerm=!1,$scope.btnOk=data.btnOk===!1?!1:data.btnOk||_tr("OK"),data.btnCancel===!1?data.btnCancel=!1:$scope.btnCancel=data.btnCancel||_tr("CANCEL"),$scope.changeTerm=function(newTerm){$scope.acceptTerm=newTerm},$scope.send=function(){$modalInstance.close(),deffered.resolve({acceptTerm:$scope.acceptTerm})},$scope.cancel=function(){$modalInstance.close(),deffered.reject({acceptTerm:$scope.acceptTerm})}}]).service("$notification",["$modal","$q","$sce",function($modal,$q){var templatePath="/code/notification/templates/",confirm=function(data){var deffered=$q.defer();data=data||{},data.hasOwnProperty("templateFullUrl")&&data.templateFullUrl&&(data.templateFullUrl=templatePath+data.templateFullUrl);var modalCofirm=$modal.open({templateUrl:data.templateFullUrl||"/code/notification/notification.htm",windowClass:"modal-preoday "+(data.windowClass||""),controller:"confirmModalController",resolve:{data:function(){return data},deffered:function(){return deffered}}});return modalCofirm.opened.then(function(){setTimeout(function(){var maxWidth=0;$(".notificationButtons button").each(function(){maxWidth=maxWidth>$(this).width()?maxWidth:$(this).width()}).width(maxWidth),$(".modal-preoday").addClass("active")},400)}),deffered.promise};return{confirm:confirm}}]),angular.module("kyc.services",[]).service("$chartService",["ChartType","$filter","TickInterval",function(ChartType,$filter,TickInterval){var area=function(value){return{options:{chart:{type:"areaspline",height:"250"},exporting:{enabled:!1},plotOptions:{line:{marker:{enabled:!1}},areaspline:{lineWidth:0,fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#523E8A"],[1,"#1AA1DB"]]},marker:{enabled:!1}}}},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",minTickInterval:864e5,labels:{enabled:!1}},yAxis:{gridLineWidth:0,minorGridLineWidth:0,title:{text:""},labels:{enabled:!1}},series:[{showInLegend:!1,enableMouseTracking:!1,name:"",data:value.data}]}},areaModal=function(value){return{options:{chart:{type:"areaspline",height:"250"},exporting:{enabled:!1},plotOptions:{line:{marker:{enabled:!1}},series:{marker:{fillColor:"#126FB2",lineColor:"#126FB2",lineWidth:2}},areaspline:{color:"#E7F1F7",lineColor:"#126FB2",lineWidth:3,marker:{fillColor:"#126FB2",enabled:!1}}},tooltip:{borderWidth:0,backgroundColor:"transparent",shadow:!1,useHTML:!0,positioner:function(boxWidth,boxHeight,point){var substract=20;return value.currency&&(substract=0),{x:point.plotX-substract,y:point.plotY-boxHeight}},formatter:function(){var date;date=this.series.xAxis.tickInterval===TickInterval.MONTH?$filter("date")(new Date(this.x),"MMM yyyy"):this.series.xAxis.tickInterval===TickInterval.WEEK?moment(this.x).startOf("week").format("DD MMM YYYY")+" <br /> - <br />"+moment(this.x).endOf("week").format("DD MMM YYYY"):$filter("date")(new Date(this.x),"dd MMM yyyy");var ui_str='<div style="position:relative;"><div style="background-color: #1576B7; border-radius: 5px; color:#fff;font-family:\'Co Text W01 Light\'; text-align:center; padding:18px 8px;">'+date,tooltipText=1==this.y&&"s"===value.tooltipText[value.tooltipText.length-1].toLowerCase()?value.tooltipText.slice(0,-1):value.tooltipText;return ui_str+="<b style=\"color:#fff;font-size:160%;font-weight:bold;font-family:'Co Text W01 Bold';text-align:center;display:block;margin-top:8px;\">",ui_str+=value.currency?tooltipText+""+this.y.toFixed(2)+"</b></div>":this.y+""+tooltipText+"</b></div>",ui_str+='<span style="position: absolute; left: 42%; bottom: -8px; background:url(/img/arrowBlue.png) left top no-repeat; width: 15px; height: 8px; display: block;" "></span></div>'}}},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",tickInterval:value.tickInterval,min:value.minTimestamp,max:value.maxTimestamp,labels:{style:{color:"#b3b6b8",fontSize:"15px"},formatter:function(){var date;return date=this.axis.tickInterval===TickInterval.MONTH?$filter("date")(new Date(this.value),"MMM"):this.axis.tickInterval===TickInterval.WEEK||this.axis.tickInterval===TickInterval.WEEK_THREE?$filter("date")(new Date(moment(this.value).startOf("day")),"dd.MMM"):$filter("date")(new Date(this.value),"dd.MMM")}}},yAxis:{gridLineWidth:0,minorGridLineWidth:0,title:{text:""},labels:{style:{color:"#b3b6b8",fontSize:"15px"}}},series:[{showInLegend:!1,name:"",data:value.data,marker:{symbol:"url(/img/marker.png)"}}]}},pie=function(value){return{options:{chart:{type:"pie",height:"250",events:{load:function(){setTimeout(function(){$(".highcharts-legend-item rect").attr("rx","20").attr("ry","20").attr("width","16").attr("height","16").css({cursor:"pointer"})},100)}}},tooltip:{hideDelay:0,borderWidth:0,backgroundColor:"#DBDBD9",shadow:!1,useHTML:!0,positioner:function(boxWidth,boxHeight,point){return{x:point.plotX-boxWidth/2+10,y:point.plotY-boxHeight-5}},formatter:function(){return'<div style="position:relative;"><div class="tooltipPie" style="font-size: 14px; font-weight: 600; padding: 5px 7px">'+Highcharts.numberFormat(this.y,1)+'</div> <span style="position: absolute; left: 42%; bottom: -15px; background:url(/img/arrowPie.png) left top no-repeat; width: 15px; height: 9px; display: block;" "></span> </div>'}},exporting:{enabled:!1},plotOptions:{pie:{center:["20%","55%"],borderWidth:0}},legend:{width:50,enabled:!0,layout:"vertical",verticalAlign:"middle",align:"center",borderWidth:0,itemMarginTop:5,itemMarginBottom:5,itemStyle:{width:210,lineHeight:20,fontSize:13},useHTML:!1,labelFormatter:function(){var style="font-family:Co Text W01 Light;";return style+="color:#46545d;",'<div style="'+style+'">'+this.name+"</div>"}}},title:{text:""},yAxis:{title:{text:""}},series:[{data:value.data,size:"80%",innerSize:"65%",showInLegend:!0,dataLabels:{enabled:!1}}]}},column=function(value){return{options:{chart:{height:"250",type:"column"},exporting:{enabled:!1},plotOptions:{column:{borderRadius:5},series:{borderWidth:0,dataLabels:{enabled:!1,format:"{point.y:.1f}"}}},tooltip:{hideDelay:.1,crosshairs:!1,shared:!0,followPointer:!0,borderWidth:0,backgroundColor:"#DBDBD9",shadow:!1,useHTML:!0,positioner:function(boxWidth,boxHeight,point){return{x:point.plotX-boxWidth/2+10,y:point.plotY-boxHeight-5}},formatter:function(){return'<div class="tooltipPie" style="font-size: 14px; font-weight: 600; padding: 5px 7px">'+Highcharts.numberFormat(this.y,1)+"</div>"}}},title:{text:""},xAxis:{type:"category",lineWidth:0,tickWidth:0},yAxis:{gridLineWidth:0,minorGridLineWidth:0,title:{text:""},labels:{enabled:!1}},series:[{pointWidth:200,name:"Customers",showInLegend:!1,colorByPoint:!1,color:{linearGradient:{x1:1,y1:1,x2:0,y2:1},stops:[[0,"#523E8A"],[1,"#1AA1DB"]]},data:value.data}]}},getChart=function(type,value){switch(type){case ChartType.AREA:return area(value);case ChartType.AREA_MODAL:return areaModal(value);case ChartType.PIE:return pie(value);case ChartType.COLUMN:return column(value)}};return{area:area,areaModal:areaModal,pie:pie,column:column,getChart:getChart}}]),angular.module("kyc.services").service("$grid",["ChartType",function(ChartType){var populateItems=function(charts){var values=[],i=1,grid=8,col=1,row=1,$widgets=window.sessionStorage.getItem("widgets");return $widgets&&($widgets=angular.fromJson($widgets)),angular.forEach(charts,function(value){var data={};data.display=!0,data.title=value.title,data.num=i,value.type===ChartType.NUMBER?(data.showChart=!1,data.size_x=2,data.size_y=1,data.value=value.data,data.currency=value.currency):(data.showChart=!0,data.size_x=4,data.size_y=2,data.value=value,data.currency=value.currency),$widgets&&(data.order=$widgets[i].order,data.display=$widgets[i].display),data.row=row,data.col=col,col+data.size_x>grid?(col=1,++row):col+=data.size_x,++i,values.push(data)}),$widgets&&values.sort(function(a,b){return a.order<b.order?-1:a.order>b.order?1:0}),values};return{populateItems:populateItems}}]),angular.module("loaders",[]).service("$AjaxInterceptor",["$rootScope","$timeout",function($rootScope,$timeout){function setSpinner(){var target=document.getElementsByClassName(".loading-content");if(target.length>0){(new Spinner).spin(target[0])}}return{start:function(){++$rootScope.requests,setSpinner()},complete:function(){$timeout(function(){$rootScope.requests>0&&--$rootScope.requests},100)},isRequesting:function(){return $rootScope.requests>0}}}]),angular.module("kyc.services").service("OutletService",["ACCOUNT_ID","Outlet",function(ACCOUNT_ID,Outlet){var outlets=[];this.init=function(callback){outlets=Outlet.query({accountId:ACCOUNT_ID},function(res){callback(res)})},this.getOutlets=function(){return outlets},this.getOutletName=function(outletId){var found=!1;return angular.forEach(outlets,function(outlet){outlet.id==outletId&&(found=outlet.name)}),found}}]),angular.module("kyc.services").factory("pusher",["PUSHER_KEY",function(PUSHER_KEY){Pusher.log=function(message){window.console&&window.console.log&&window.console.log(message)};var pusher,channel;return{bind:function(venueId,outletIds,callback){outletIds.length>0?angular.forEach(outletIds,function(outletId){channel=pusher.subscribe("preoday.order.outlet."+outletId),channel.bind("update",callback)}):(channel=pusher.subscribe("preoday.order.venue."+venueId),channel.bind("update",callback))},reset:function(){if(pusher){var chans=pusher.allChannels();angular.forEach(chans,function(channel){channel.unbind(),pusher.unsubscribe(channel.name)})}else pusher=new Pusher(PUSHER_KEY)},bindConnection:function(event,callback){pusher.connection.bind(event,callback)}}}]),angular.module("kyc.services").service("OrderService",["ACCOUNT_ID","Order",function(ACCOUNT_ID,Order){function getOrders(){return orders}function load(callback,minCreated,maxCreated){return Order.query({accountId:ACCOUNT_ID,maxCreated:maxCreated,minCreated:minCreated},function(res){orders=res,callback&&callback(res)}).$promise}var orders;return{load:load,getOrders:getOrders}}]),angular.module("kyc.services").service("VenueService",["ACCOUNT_ID","Venue","$q",function(ACCOUNT_ID,Venue,$q){function init(){{var defer=$q.defer();new Venue.query({accountId:ACCOUNT_ID},function(result){result&&result.length>0&&(venue=result[0]),defer.resolve(venue)})}return defer.promise}function getCurrency(){return venue?currencyMap[venue.ccy]:currencyMap.GBP}var venue,currencyMap={GBP:{symbol:"%C2%A3",name:"Pound Sterling",symbol_native:"£",decimal_digits:2,rounding:0,code:"GBP",name_plural:"British pounds sterling"},EUR:{symbol:"%E2%82%AC",name:"Euro",symbol_native:"€",decimal_digits:2,rounding:0,code:"EUR",name_plural:"euros"},USD:{symbol:"$",name:"US Dollar",symbol_native:"$",decimal_digits:2,rounding:0,code:"USD",name_plural:"US dollars"}};return{getCurrency:getCurrency,init:init}}]),angular.module("kyc.services").service("UtilsService",[function(){var sliceObject=function(object,begin,end){var i=0,data={},keys=Object.keys(object);keys.length<end&&(end=keys.length);for(var i=begin;end>i;i++){var key=keys[i];data[key]=object[key]}return data},reOrderWidgets=function(element){for(var $charts=$(element).children().find(".flip-container"),objectValues={},i=$charts.length-1;i>=0;i--){var $chart=$($charts[i]),index=$charts.index($chart),scope=$chart.scope();objectValues[scope.value.num]={order:index,display:scope.value.display},scope.value.order=index}window.sessionStorage.setItem("widgets",angular.toJson(objectValues))},dynamicSort=function(property,desc){var sortOrder=1;desc&&(sortOrder=-1);var result=a[property]<b[property]?-1:a[property]>b[property]?1:0;return result*sortOrder},dynamicSortObject=function(obj,property,desc){var sortOrder=1;desc&&(sortOrder=-1);var index=[];return angular.forEach(obj,function(item){index.push(item)}),index.sort(function(a,b){var result=a[property]<b[property]?-1:a[property]>b[property]?1:0;return result*sortOrder}),index};return{sliceObject:sliceObject,reOrderWidgets:reOrderWidgets,dynamicSort:dynamicSort,dynamicSortObject:dynamicSortObject}}]),angular.module("kyc.controllers").controller("DashboardCtrl",["$scope","$http","$compile","ChartType","$grid","AllCharts","$AjaxInterceptor","$timeout","$notification","UtilsService",function($scope,$http,$compile,ChartType,$grid,AllCharts,$AjaxInterceptor,$timeout,$notification,UtilsService){$scope.setLocation("dashboard"),$scope.$parent.showDateFilter=!0;var charts=AllCharts.getPreparedCharts();$scope.changeVisibility=function(value){value.display?(angular.element("#removable_"+value.num).closest(".flip-container").parent().show(),UtilsService.reOrderWidgets(angular.element("#sscontainer"))):setTimeout(function(){angular.element("#removable_"+value.num).triggerHandler("click")},0),angular.element("#sscontainer").trigger("ss-rearrange")},$scope.shapeshifterConfig={gutterX:20,gutterY:20,paddingX:0,paddingY:0,minColumns:2},$scope.values=$grid.populateItems(charts),$timeout(function(){var isFirstTime="1"===window.sessionStorage.getItem("firsttime_feature_4");isFirstTime&&(window.sessionStorage.setItem("firsttime_feature_4",0),$notification.confirm({title:_tr("Welcome to Know Your Customer"),content:_tr("From here you can view detailed reports and analytics about your customers and the transactions they make."),showTerm:!1,btnOk:!1,btnCancel:_tr("GET STARTED"),windowClass:"medium"})),$AjaxInterceptor.complete(),$(window).trigger("resize"),angular.element("#sscontainer").trigger("ss-rearrange")},1e3)}]),angular.module("kyc.controllers").controller("CustomersCtrl",["$scope","OrderService","$AjaxInterceptor","Export","ACCOUNT_ID","UtilsService",function($scope,OrderService,$AjaxInterceptor,Export,ACCOUNT_ID,UtilsService){function prepareExportCsvData(){var prepData=[[$scope.getExportDate()],[title]];return angular.forEach($scope.customers,function(item){("1"===$scope.exportAll||item.selected===!0)&&prepData.push([item.name,item.totalSpent,item.emailAddress])}),{data:prepData}}function prepareExportPdfData(){var prepData={Name:[],"Total Spent":[],"Email Address":[]};return angular.forEach($scope.customers,function(item){("1"===$scope.exportAll||item.selected===!0)&&(prepData.Name.push(item.name),prepData["Total Spent"].push(item.totalSpent),prepData["Email Address"].push(item.emailAddress))}),{title:"Customers",startDate:$scope.form.start_date.valueOf(),endDate:$scope.form.end_date.valueOf(),dataJson:JSON.stringify(prepData)}}function prepareScopeCustomers(){if(allOrders){var minDate=moment($scope.$parent.form.start_date),maxDate=moment($scope.$parent.form.end_date);angular.forEach(allOrders,function(row){var orderData=moment(row.created);if((0===$scope.$parent.getSelectedOutlets().length||$scope.$parent.findOutlet(row.outletId).length>=1)&&orderData>=minDate&&maxDate>=orderData){var customerId=row.userId;void 0===$scope.customers[customerId]?$scope.customers[customerId]={name:row.user.firstName+" "+row.user.lastName,totalSpent:Number(row.total.toFixed(2)),emailAddress:row.user.username,marketing:row.user.optinLoyalty||row.user.optinOffers||row.user.optinOther?_tr("Accepts"):" - "}:$scope.customers[customerId].totalSpent=Number(($scope.customers[customerId].totalSpent+row.total).toFixed(2))}})}$scope.customers=UtilsService.dynamicSortObject($scope.customers,$scope.orderBy,$scope.direction),$scope.customersList=$scope.customers,$scope.totalItems=Object.keys($scope.customers).length,$scope.numPerPage=10,$scope.currentPage=1,$AjaxInterceptor.complete()}$scope.setLocation("customers"),$scope.customers={},$scope.$parent.showDateFilter=!0;var title=_tr("Customers"),allOrders=OrderService.getOrders();prepareScopeCustomers(),$scope.exportAll="1",$scope.selectAll=function(){angular.forEach($scope.customers,function(value){value.selected=$scope.all_options})},$scope.exportPdf=function(){$scope.pdfData=prepareExportPdfData()},$scope.exportCsv=function(){$scope.csvData=prepareExportCsvData()},$scope.setOrderBy=function(orderBy){$scope.customers=UtilsService.dynamicSortObject($scope.customers,orderBy,$scope.direction),loadCustomersByPage()};var loadCustomersByPage=function(){var begin=($scope.currentPage-1)*$scope.numPerPage,end=begin+$scope.numPerPage;$scope.customersList=$scope.customers.slice(begin,end)};$scope.$watch("currentPage + numPerPage",function(){loadCustomersByPage()}),$scope.showOptions=function(){angular.element(".flip-container").addClass("active"),setTimeout(function(){$(".invisibleBack").addClass("visible")},200)},$scope.hideOptions=function(){angular.element(".flip-container").removeClass("active"),setTimeout(function(){$(".invisibleBack").removeClass("visible")},200)}}]),angular.module("kyc.controllers").controller("ReportsCtrl",["$scope","$AjaxInterceptor","OrderService","Export","ACCOUNT_ID","AllReports","UtilsService","$filter",function($scope,$AjaxInterceptor,OrderService,Export,ACCOUNT_ID,AllReports,UtilsService,$filter){function prepareScopeReports(){$scope.reports=AllReports.getReportsList(),$scope.selectReport($scope.reports[0]),$scope.selectedReport&&$scope.selectedReport.data?($scope.reportsList=$scope.selectedReport.data,$scope.totalItems=Object.keys($scope.selectedReport.data).length):($scope.reportsList=[],$scope.totalItems=0),$scope.selectedReport.data=UtilsService.dynamicSortObject($scope.selectedReport.data,$scope.orderBy,$scope.direction),$scope.numPerPage=10,$scope.currentPage=1,$AjaxInterceptor.complete()}function prepareExportPdfData(){var prepData={};return angular.forEach($scope.selectedReport.data,function(item){("1"===$scope.exportAll||item.$selected===!0)&&angular.forEach(item,function(val,prop){if("$"!==prop[0]){var propTitle=$scope.getTitle(prop);void 0===prepData[propTitle]&&(prepData[propTitle]=[]),prepData[propTitle].push(getFilteredProp(val,prop))}})}),console.log("returning:",{title:$scope.selectedReport.title,startDate:$scope.form.start_date.valueOf(),endDate:$scope.form.end_date.valueOf(),dataJson:angular.toJson(prepData)}),{title:$scope.selectedReport.title,startDate:$scope.$parent.form.start_date.valueOf(),endDate:$scope.$parent.form.end_date.valueOf(),dataJson:angular.toJson(prepData)}}function prepareExportCsvData(){var prepData=[[$scope.getExportDate()],[$scope.selectedReport.title],$scope.selectedReport.titles];return angular.forEach($scope.selectedReport.data,function(item){if("1"===$scope.exportAll||item.$selected===!0){var row=[];angular.forEach(item,function(val,prop){"$"!==prop[0]&&row.push(getFilteredProp(val,prop))}),prepData.push(row)}}),{data:prepData}}function getFilteredProp(obj,prop){switch(prop){case"day":case"lastOrder":case"dateJoined":case"dateOfOrder":case"date":return $filter("date")(obj,"dd/MM/yyyy");case"valueSold":case"totalSpent":return obj.toFixed(2);default:return obj}}_tr("Reports");$scope.setLocation("reports"),$scope.exportAll="1",$scope.direction=!1,$scope.selectAll=function(){for(var i=$scope.selectReport.data.length;i--;)$scope.selectReport.data[i].$selected=$scope.all_options},$scope.$watch("currentPage + numPerPage",function(){loadReportsByPage()});var loadReportsByPage=function(){var begin=($scope.currentPage-1)*$scope.numPerPage,end=begin+$scope.numPerPage;$scope.selectedReport&&$scope.selectedReport.data&&($scope.reportsList=$scope.selectedReport.data.slice(begin,end))};$scope.setOrderBy=function(orderBy){$scope.direction=!$scope.direction,$scope.orderBy=orderBy,$scope.selectedReport.data=UtilsService.dynamicSortObject($scope.selectedReport.data,orderBy,$scope.direction),loadReportsByPage()},$scope.selectReport=function(which){if(which)var report=which;else{var report=$scope.reports.filter(function(r){return r.selected===!0});report.length&&(report=report[0])}$scope.selectedReport={data:report.getData(),title:report.getTitle(),titles:report.getTitles()},$scope.totalItems=Object.keys($scope.selectedReport.data).length,$scope.reportsList=UtilsService.sliceObject($scope.selectedReport.data,0,$scope.numPerPage),$scope.currentPage=1,report.orderBy&&($scope.setOrderBy(report.orderBy),$scope.direction=void 0!==report.direction?report.direction:$scope.direction)},$scope.getTitle=function(title){return AllReports.getTitle(title)},$scope.exportPdf=function(){$scope.pdfData=prepareExportPdfData()},$scope.exportCsv=function(){$scope.csvData=prepareExportCsvData()},$scope.showOptions=function(){angular.element(".flip-container").addClass("active"),setTimeout(function(){$(".invisibleBack").addClass("visible")},200)},$scope.hideOptions=function(){angular.element(".flip-container").removeClass("active"),setTimeout(function(){$(".invisibleBack").removeClass("visible")},200)},prepareScopeReports()}]),angular.module("kyc.controllers").controller("StockCtrl",["$scope","$AjaxInterceptor","OrderService","Export","ACCOUNT_ID","UtilsService",function($scope,$AjaxInterceptor,OrderService,Export,ACCOUNT_ID,UtilsService){function prepareExportCsvData(){var prepData=[[$scope.getExportDate()],[title]];return angular.forEach($scope.stock,function(item){("1"===$scope.exportAll||item.selected===!0)&&prepData.push([item.name,item.quantity])}),{data:prepData}}function prepareExportPdfData(){var prepData={Item:[],"Quantity Ordered":[]};return angular.forEach($scope.stock,function(item){("1"===$scope.exportAll||item.selected===!0)&&(prepData.Item.push(item.name),prepData["Quantity Ordered"].push(item.quantity))}),{title:"Stock",startDate:$scope.form.start_date.valueOf(),endDate:$scope.form.end_date.valueOf(),dataJson:JSON.stringify(prepData)}}function prepareScopeStock(){if(allOrders){var minDate=moment($scope.$parent.form.start_date),maxDate=moment($scope.$parent.form.end_date);angular.forEach(allOrders,function(row){var orderData=moment(row.created);console.log("row outletId ",row.outletId),console.log("parent: outletId ",$scope.$parent.outlets),(0===$scope.$parent.getSelectedOutlets().length||$scope.$parent.findOutlet(row.outletId).length>=1)&&orderData>=minDate&&maxDate>=orderData&&angular.forEach(row.items,function(item){var itemId=item.menuItemId;void 0===$scope.stock[itemId]?$scope.stock[itemId]={name:item.name,quantity:item.qty}:$scope.stock[itemId].quantity+=item.qty})})}$scope.stock=UtilsService.dynamicSortObject($scope.stock,$scope.orderBy,$scope.direction),$scope.stocks=$scope.stock,$scope.totalItems=Object.keys($scope.stock).length,$scope.numPerPage=10,$scope.currentPage=1,$AjaxInterceptor.complete()}var title=_tr("Stock");$scope.setLocation("stock"),$scope.$parent.showDateFilter=!0,$scope.stock={},$scope.exportAll="1";var allOrders=OrderService.getOrders();$scope.selectAll=function(){angular.forEach($scope.stock,function(value){value.selected=$scope.all_options})},$scope.exportPdf=function(){$scope.pdfData=prepareExportPdfData()},$scope.exportCsv=function(){$scope.csvData=prepareExportCsvData()},$scope.setOrderBy=function(orderBy){$scope.stock=UtilsService.dynamicSortObject($scope.stock,orderBy,$scope.direction),loadStocksByPage()};var loadStocksByPage=function(){var begin=($scope.currentPage-1)*$scope.numPerPage,end=begin+$scope.numPerPage;$scope.stocks=$scope.stock.slice(begin,end)};$scope.$watch("currentPage + numPerPage",function(){loadStocksByPage()}),prepareScopeStock(),$scope.setPage=function(pageNo){$scope.currentPage=pageNo},$scope.showOptions=function(){angular.element(".flip-container").addClass("active"),setTimeout(function(){$(".invisibleBack").addClass("visible")},200)},$scope.hideOptions=function(){angular.element(".flip-container").removeClass("active"),setTimeout(function(){$(".invisibleBack").removeClass("visible")},100)}}]),angular.module("kyc.controllers").controller("StreamCtrl",["$scope","OrderService","pusher","$AjaxInterceptor","$interval","VENUE_ID",function($scope,OrderService,pusher,$AjaxInterceptor,$interval,VENUE_ID){$scope.$parent.showDateFilter=!1,$scope.setLocation("stream"),$scope.orders=OrderService.getOrders();var onTimeout=!1,pusherUpdateEvent=function(){onTimeout||(onTimeout=!0,OrderService.load(function(orders){$scope.orders=orders}),setTimeout(function(){onTimeout=!1},500))};pusher.reset();var venueId=VENUE_ID,selectedOutlets=$scope.getSelectedOutlets(),outletIds=[];angular.forEach(selectedOutlets,function(outlet){outletIds.push(outlet.id)}),pusher.bind(venueId,outletIds,pusherUpdateEvent),$scope.getStatusName=function(status){var statusMap={PAYMENT_FAILED:"FAILED",NOSHOW:"NO SHOW"};return statusMap[status]?statusMap[status]:status},$scope.getStatusColor=function(status){switch(status){case"PENDING":case"ACCEPTED":case"PREPARING":case"READY":case"DELIVERING":case"COMPLETED":return"good";case"NOSHOW":case"REJECTED":case"CANCELLED":case"PAYMENT_FAILED":default:return"bad"}},$scope.outletFilter=function(order){return outletIds&&0===outletIds.length||outletIds.indexOf(order.outletId)>-1},$scope.showOptions=function(){angular.element(".flip-container").addClass("active")},$scope.hideOptions=function(){angular.element(".flip-container").removeClass("active")},$scope.activeStream=function(stream){var result=$scope.orders.filter(function(item){return item.active===!0});result&&result[0]&&result[0].code!=stream.code&&(result[0].active=!1),stream.active=!stream.active},$scope.getOrderItems=function(order){var items=[];return angular.forEach(order.items,function(item){items.push(item.qty+" x "+item.name)}),items},$AjaxInterceptor.complete()}]),angular.module("kyc.controllers").controller("MenuCtrl",["$scope","OutletService","OrderService","AllCharts","$route","VenueService","$AjaxInterceptor","$location",function($scope,OutletService,OrderService,AllCharts,$route,VenueService,$AjaxInterceptor,$location){$scope.currencySymbol="%C2%A3",$scope.outlets=[],$scope.form={start_date:moment().subtract("month",3),end_date:moment()},$scope.getCurrency=function(){return decodeURI($scope.currencySymbol)},VenueService.init().then(function(venue){$scope.venue=venue,$scope.currencySymbol=VenueService.getCurrency().symbol,OutletService.init(function(){$scope.outlets=OutletService.getOutlets(),AllCharts.init($scope.form.start_date,$scope.form.end_date,$scope.currencySymbol)})}),$scope.update=function(){$AjaxInterceptor.start(),console.log("updating",$scope.form.start_date,$scope.form.end_date),setTimeout(function(){AllCharts.init($scope.form.start_date,$scope.form.end_date,$scope.currencySymbol,$scope.getSelectedOutlets()),$route.reload(),$AjaxInterceptor.complete()},500)},$scope.setLocation=function(newLocation){$scope.currentLocation=newLocation,$location.path()!=="/"+newLocation&&$location.path(newLocation)},$scope.getSelectedOutlets=function(){return $scope.outlets.filter(function(data){return data.selected===!0})},$scope.findOutlet=function(id){return $scope.outlets.filter(function(data){return data.selected===!0&&data.id===id})},$scope.getExportDate=function(){return $scope.form.start_date.format("DD-MMM-YYYY")+" - "+$scope.form.end_date.format("DD-MMM-YYYY")}}]),angular.module("kyc.resources").factory("Export",["$resource",function($resource){var Pdf=$resource("/api/accounts/:accountId/exports/pdf",{accountId:"@accountId"},{table:{method:"POST",url:"/api/accounts/:accountId/exports/pdf/table"},chart:{method:"POST",url:"/api/accounts/:accountId/exports/pdf/table"}}),Csv=$resource("/api/accounts/:accountId/exports/csv",{accountId:"@accountId"},{}),TablePdf=$resource("/api/accounts/:accountId/exports/table/pdf",{accountId:"@accountId"},{});return{Pdf:Pdf,Csv:Csv,TablePdf:TablePdf}}]),angular.module("kyc.resources").factory("Outlet",["$resource",function($resource){var Outlet=$resource("/api/outlets",{},{});return Outlet}]),angular.module("kyc.resources").factory("Order",["$resource",function($resource){var Order=$resource("/api/orders",{},{});return Order}]),angular.module("kyc.resources").factory("Venue",["$resource",function($resource){var Venue=$resource("/api/venues/:id",{},{query:{method:"GET",isArray:!0}});return Venue}]),angular.module("kyc.resources").factory("VenueCustomers",["$resource",function($resource){var VenueCustomers=$resource("/api/venues/:id/customers",{id:"@id"},{});return VenueCustomers}]),angular.module("kyc.resources").factory("Report",["$resource",function($resource){var Report=$resource("/api/reports/:venueId",{venueId:"@venueId"},{items:{method:"GET",isArray:!0,url:"/api/reports/:venueId/items"},orders:{method:"GET",isArray:!0,url:"/api/reports/:venueId/orders"},customerOrders:{method:"GET",isArray:!0,url:"/api/reports/:venueId/customerOrders"}});return Report}]),angular.module("kyc").constant("ChartType",{NUMBER:"NUMBER",COLUMN:"COLUMN",PIE:"PIE",AREA:"AREA",AREA_MODAL:"AREA_MODAL"}),angular.module("kyc").constant("Colors",["#18a4dd","#1576b7","#543b87","#392654","#f5b23e","#8bbf4f","#c0392b","#46545d","#b4b6b8","#dcdddf"]),angular.module("kyc").constant("TickInterval",{DAY:864e5,WEEK:6048e5,WEEK_THREE:18144e5,MONTH:2592e6}),angular.module("kyc.directives").controller("modalCtrl",["$scope","$chartService",function($scope,$chartService){if($scope.optionHasData=function(option){return option.data.length>1&&+option.value>0?1:0},$scope.noData=!1,$scope.chart=angular.copy(ng.chart),ng.chart.value.modal.highcharts){var firstOption=ng.chart.value.modal.options[0];
ng.chart.value.tickInterval=firstOption.tickInterval,ng.chart.value.minTimestamp=moment(firstOption.minTimestamp).valueOf(),ng.chart.value.maxTimestamp=moment(firstOption.maxTimestamp).valueOf();var value=angular.copy(ng.chart.value);value.data=firstOption.data,$scope.chart.highcharts=$chartService.getChart(ng.chart.value.modal.highcharts.type,value)}$scope.showOptions=function(){$(".modal-chart .flip-container").addClass("active"),setTimeout(function(){$(".modal-chart .invisibleBack").addClass("visible")},200)},$scope.hideOptions=function(){$(".modal-chart .flip-container").removeClass("active"),setTimeout(function(){$(".modal-chart .invisibleBack").removeClass("visible")},200)},$scope.cancel=function(){mod.close()},$scope.exportPdf=function(){$scope.pdfData=$scope.chart.value.getPdf()},$scope.exportCsv=function(){$scope.csvData=$scope.chart.value.getCsv()},$scope.title=ng.chart.title,$scope.selectOption=function(option){$scope.noData=!1;var itemActive=$scope.chart.value.modal.options.filter(function(item){return 1==item.active});itemActive&&(itemActive[0].active=!1),option.active=!0,$scope.chart.highcharts=$chartService.getChart(ng.chart.value.modal.highcharts.type,{tooltipText:ng.chart.value.tooltipText,data:option.data,tickInterval:option.tickInterval,minTimestamp:moment(option.minTimestamp).valueOf(),maxTimestamp:moment(option.maxTimestamp).valueOf()})},$scope.setNoData=function(option){$scope.noData=!0;var itemActive=$scope.chart.value.modal.options.filter(function(item){return 1==item.active});itemActive&&(itemActive[0].active=!1),option.active=!0}}]).directive("chart",["$modal","ChartType","$chartService","Export","ACCOUNT_ID","UtilsService",function($modal,ChartType,$chartService,Export,ACCOUNT_ID,UtilsService){return{templateUrl:"/code/kyc/js/directives/chart/chart.php",restrict:"E",replace:!0,scope:{chart:"=element"},link:function(ng,elem){function setNoData(){if(ng.chart.showChart)switch(ng.chart.value.type){case ChartType.PIE:case ChartType.COLUMN:if(0===ng.chart.value.data.length)ng.noData=!0;else{var allZero=!0;angular.forEach(ng.chart.value.data,function(data){data.y>0&&(allZero=!1)}),ng.noData=allZero}break;case ChartType.AREA:ng.chart.value.data.length<=1&&(ng.noData=!0)}else(0===ng.chart.value||"NaN"===ng.chart.value||0/0==ng.chart.value)&&(ng.noData=!0)}function openModal(){if(ng.chart.value.modal){var w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),windowClass=w>1300?"large":"xlarge",mod=$modal.open({templateUrl:modal_url("chart"),windowClass:windowClass+" modal-preoday modal-chart",controller:"modalCtrl"});mod.opened.then(function(){setTimeout(function(){$(".modal-preoday").addClass("active")},1)})}}function refreshChart(){var highchartsConfig=$chartService.getChart(ng.chart.value.type,ng.chart.value);ng.chart.value.items&&(highchartsConfig.options.chart.height=205,elem.parent().addClass("highchartsItem")),ng.chart.value.type===ChartType.AREA&&(highchartsConfig.options.chart.events={click:openModal}),ng.chart.highcharts=highchartsConfig}ng.ACCOUNT_ID=ACCOUNT_ID,ng.chart.display||elem.parent().hide(),ng.noData=!1,setNoData(),ng.ChartType=ChartType;var $flipContainer=(elem.find(".actions-chart"),elem.find(".chart"),elem.closest(".flip-container"));refreshChart(),ng.showOptions=function(){$flipContainer.addClass("active"),setTimeout(function(){elem.find(".invisibleBack").addClass("visible")},200)},ng.hideOptions=function(){$flipContainer.removeClass("active"),setTimeout(function(){elem.find(".invisibleBack").removeClass("visible")},100)},ng.removeGrid=function(chart){chart.display=!1,elem.parent().hide(),UtilsService.reOrderWidgets(elem.closest(".sscontainer"))},ng.changeItem=function(){var items=ng.chart.value.items.filter(function(i){return i.selected===!0});items.length&&(ng.selectedItem=items[0],ng.selectedItem.callback(ng.selectedItem.menuItemId,function(highchart){ng.chart.value=highchart,refreshChart()}))},ng.exportPdf=function(){ng.pdfData=ng.chart.value.getPdf()},ng.exportCsv=function(){ng.csvData=ng.chart.value.getCsv()},ng.getText=function(chart){if("object"==typeof chart.value)var strNum=chart.value.numberLeft;else var strNum=chart.value.toLocaleString();return chart.currency?decodeURI(chart.currency)+strNum:strNum}}}}]),angular.module("kyc.directives").factory("highchartsNGUtils",function(){return{indexOf:function(arr,find,i){void 0===i&&(i=0),0>i&&(i+=arr.length),0>i&&(i=0);for(var n=arr.length;n>i;i++)if(i in arr&&arr[i]===find)return i;return-1},prependMethod:function(obj,method,func){var original=obj[method];obj[method]=function(){var args=Array.prototype.slice.call(arguments);return func.apply(this,args),original?original.apply(this,args):void 0}},deepExtend:function deepExtend(destination,source){if(angular.isArray(source)){destination=angular.isArray(destination)?destination:[];for(var i=0;i<source.length;i++)destination[i]=deepExtend(destination[i]||{},source[i])}else if(angular.isObject(source))for(var property in source)destination[property]=deepExtend(destination[property]||{},source[property]);else destination=source;return destination}}}).directive("highchart",["highchartsNGUtils",function(highchartsNGUtils){var seriesId=0,ensureIds=function(series){var changed=!1;return angular.forEach(series,function(s){angular.isDefined(s.id)||(s.id="series-"+seriesId++,changed=!0)}),changed},axisNames=["xAxis","yAxis"],getMergedOptions=function(scope,element,config){var mergedOptions={},defaultOptions={chart:{events:{}},title:{},subtitle:{},series:[],credits:{},plotOptions:{},navigator:{enabled:!1}};return mergedOptions=config.options?highchartsNGUtils.deepExtend(defaultOptions,config.options):defaultOptions,mergedOptions.chart.renderTo=element[0],angular.forEach(axisNames,function(axisName){angular.isDefined(config[axisName])&&(mergedOptions[axisName]=angular.copy(config[axisName]),(angular.isDefined(config[axisName].currentMin)||angular.isDefined(config[axisName].currentMax))&&(highchartsNGUtils.prependMethod(mergedOptions.chart.events,"selection",function(e){var thisChart=this;scope.$apply(e[axisName]?function(){scope.config[axisName].currentMin=e[axisName][0].min,scope.config[axisName].currentMax=e[axisName][0].max}:function(){scope.config[axisName].currentMin=thisChart[axisName][0].dataMin,scope.config[axisName].currentMax=thisChart[axisName][0].dataMax})}),highchartsNGUtils.prependMethod(mergedOptions.chart.events,"addSeries",function(){scope.config[axisName].currentMin=this[axisName][0].min||scope.config[axisName].currentMin,scope.config[axisName].currentMax=this[axisName][0].max||scope.config[axisName].currentMax})))}),config.title&&(mergedOptions.title=config.title),config.subtitle&&(mergedOptions.subtitle=config.subtitle),config.credits&&(mergedOptions.credits=config.credits),config.size&&(config.size.width&&(mergedOptions.chart.width=config.size.width),config.size.height&&(mergedOptions.chart.height=config.size.height)),mergedOptions},updateZoom=function(axis,modelAxis){var extremes=axis.getExtremes();(modelAxis.currentMin!==extremes.dataMin||modelAxis.currentMax!==extremes.dataMax)&&axis.setExtremes(modelAxis.currentMin,modelAxis.currentMax,!1)},processExtremes=function(chart,axis,axisName){(axis.currentMin||axis.currentMax)&&chart[axisName][0].setExtremes(axis.currentMin,axis.currentMax,!0)},chartOptionsWithoutEasyOptions=function(options){return angular.extend({},options,{data:null,visible:null})};return{restrict:"EAC",replace:!0,template:"<div></div>",scope:{config:"="},link:function(scope,element){var prevSeriesOptions={},processSeries=function(series){var i,ids=[];if(series){var setIds=ensureIds(series);if(setIds)return!1;if(angular.forEach(series,function(s){ids.push(s.id);var chartSeries=chart.get(s.id);chartSeries?angular.equals(prevSeriesOptions[s.id],chartOptionsWithoutEasyOptions(s))?(void 0!==s.visible&&chartSeries.visible!==s.visible&&chartSeries.setVisible(s.visible,!1),chartSeries.setData(angular.copy(s.data),!1)):chartSeries.update(angular.copy(s),!1):chart.addSeries(angular.copy(s),!1),prevSeriesOptions[s.id]=chartOptionsWithoutEasyOptions(s)}),scope.config.noData){var chartContainsData=!1;for(i=0;i<series.length;i++)if(series[i].data&&series[i].data.length>0){chartContainsData=!0;break}chartContainsData?chart.hideLoading():chart.showLoading(scope.config.noData)}}for(i=chart.series.length-1;i>=0;i--){var s=chart.series[i];highchartsNGUtils.indexOf(ids,s.options.id)<0&&s.remove(!1)}return!0},chart=!1,initChart=function(){chart&&chart.destroy(),prevSeriesOptions={};var config=scope.config||{},mergedOptions=getMergedOptions(scope,element,config);chart=config.useHighStocks?new Highcharts.StockChart(mergedOptions):new Highcharts.Chart(mergedOptions);for(var i=0;i<axisNames.length;i++)config[axisNames[i]]&&processExtremes(chart,config[axisNames[i]],axisNames[i]);config.loading&&chart.showLoading()};initChart(),scope.$watch("config.series",function(newSeries){var needsRedraw=processSeries(newSeries);needsRedraw&&chart.redraw()},!0),scope.$watch("config.title",function(newTitle){chart.setTitle(newTitle,!0)},!0),scope.$watch("config.subtitle",function(newSubtitle){chart.setTitle(!0,newSubtitle)},!0),scope.$watch("config.loading",function(loading){loading?chart.showLoading():chart.hideLoading()}),scope.$watch("config.credits.enabled",function(enabled){enabled?chart.credits.show():chart.credits&&chart.credits.hide()}),scope.$watch("config.useHighStocks",function(useHighStocks,oldUseHighStocks){useHighStocks!==oldUseHighStocks&&initChart()}),angular.forEach(axisNames,function(axisName){scope.$watch("config."+axisName,function(newAxes,oldAxes){newAxes!==oldAxes&&newAxes&&(chart[axisName][0].update(newAxes,!1),updateZoom(chart[axisName][0],angular.copy(newAxes)),chart.redraw())},!0)}),scope.$watch("config.options",function(newOptions,oldOptions,scope){newOptions!==oldOptions&&(initChart(),processSeries(scope.config.series),chart.redraw())},!0),scope.$watch("config.size",function(newSize,oldSize){newSize!==oldSize&&newSize&&chart.setSize(newSize.width||void 0,newSize.height||void 0)},!0),scope.$on("highchartsng.reflow",function(){chart.reflow()}),scope.$on("$destroy",function(){chart&&chart.destroy(),element.remove()})}}}]),angular.module("kyc.directives").directive("datepicker",["$parse","$filter",function(){return{restrict:"A",require:"ngModel",scope:{compareStart:"=start",compareEnd:"=end"},link:function(ng,elem,attrs,ngModel){elem.fdatepicker({format:"dd/mm/yyyy",onRender:function(date){if(ng.compareStart){var isBeforeStart=date.valueOf()<ng.compareStart.valueOf()||date.valueOf()>moment().valueOf();return isBeforeStart?"disabled":""}if(ng.compareEnd){var isAfterEnd=date.valueOf()>ng.compareEnd.valueOf();return isAfterEnd?"disabled":""}}}).on("changeDate",function(ev){ng.$apply(function(){ngModel.$setViewValue(ev.date),elem.fdatepicker("setDate",ev.date)})}),ngModel.$parsers.push(function(data){if("string"==typeof data){var dataArr=data.split("/");return moment([dataArr[2],+dataArr[1]-1,+dataArr[0]])}return moment(data)}),ngModel.$formatters.push(function(data){return data.format("DD/MM/YYYY")})}}}]),angular.module("kyc.directives").directive("multiSelect",["$sce","$filter",function($sce){return{restrict:"AE",replace:!0,scope:{inputModel:"=",outputModel:"=",buttonLabel:"@",selectionMode:"@",itemLabel:"@",tickProperty:"@",disableProperty:"@",orientation:"@",defaultLabel:"@",maxLabels:"@",isDisabled:"=",directiveId:"@",helperElements:"@",onOpen:"&",onClose:"&",onBlur:"&",onFocus:"&",onChange:"&"},templateUrl:directive_url("multiselect/multiselect.htm"),link:function($scope,element,attrs){$scope.selectedItems=[],$scope.backUp=[],$scope.varButtonLabel="",$scope.currentButton=null,$scope.scrolled=!1,$scope.displayHelper=function(elementString){if("undefined"==typeof attrs.helperElements)return!0;switch(elementString.toUpperCase()){case"ALL":if(attrs.selectionMode&&"SINGLE"===$scope.selectionMode.toUpperCase())return!1;if(attrs.helperElements&&$scope.helperElements.toUpperCase().indexOf("ALL")>=0)return!0;break;case"NONE":if(attrs.selectionMode&&"SINGLE"===$scope.selectionMode.toUpperCase())return!1;if(attrs.helperElements&&$scope.helperElements.toUpperCase().indexOf("NONE")>=0)return!0;break;case"RESET":if(attrs.helperElements&&$scope.helperElements.toUpperCase().indexOf("RESET")>=0)return!0;break;case"FILTER":if(attrs.helperElements&&$scope.helperElements.toUpperCase().indexOf("FILTER")>=0)return!0}},$scope.syncItems=function(item,e){if(index=$scope.inputModel.indexOf(item),$scope.inputModel[index][$scope.tickProperty]=!$scope.inputModel[index][$scope.tickProperty],attrs.selectionMode&&"SINGLE"===$scope.selectionMode.toUpperCase()){$scope.inputModel[index][$scope.tickProperty]=!0;for(var i=0;i<$scope.inputModel.length;i++)i!==index&&($scope.inputModel[i][$scope.tickProperty]=!1);$scope.toggleCheckboxes(e)}$scope.refreshSelectedItems(),attrs.selectionMode&&"SINGLE"===$scope.selectionMode.toUpperCase()?$scope.toggleCheckboxes(e):e.target.focus(),$scope.onChange()},$scope.refreshSelectedItems=function(){$scope.varButtonLabel="",$scope.selectedItems=[];var ctr=0;if(angular.forEach($scope.inputModel,function(value){"undefined"!=typeof value&&(value[$scope.tickProperty]===!0||"true"===value[$scope.tickProperty])&&$scope.selectedItems.push(value)}),"undefined"!=typeof attrs.outputModel&&($scope.outputModel=angular.copy($scope.selectedItems)),0===$scope.selectedItems.length)$scope.varButtonLabel=$scope.defaultLabel?$scope.defaultLabel:"None selected";else{var tempMaxLabels=$scope.selectedItems.length;"undefined"!=typeof $scope.maxLabels&&""!==$scope.maxLabels&&(tempMaxLabels=$scope.maxLabels),$scope.more=$scope.selectedItems.length>tempMaxLabels?!0:!1,angular.forEach($scope.selectedItems,function(value){"undefined"!=typeof value&&(tempMaxLabels>ctr&&($scope.varButtonLabel+=($scope.varButtonLabel.length>0?", ":"")+$scope.writeLabel(value,"buttonLabel")),ctr++)}),$scope.more===!0&&(tempMaxLabels>0&&($scope.varButtonLabel+=", ... "),$scope.varButtonLabel+="(Total: "+$scope.selectedItems.length+")")}},$scope.itemIsDisabled=function(item){return item[$scope.disableProperty]===!0?!0:$scope.isDisabled===!0?!0:!1},$scope.writeLabel=function(item,type){var label="",temp=$scope[type].split(" ");return angular.forEach(temp,function(value2){"undefined"!=typeof value2&&angular.forEach(item,function(value1,key1){key1==value2&&(label+=" "+value1)})}),$sce.trustAsHtml(label)},$scope.toggleCheckboxes=function(e){e.target&&("BUTTON"!==e.target.tagName.toUpperCase()&&e.target.className.indexOf("multiSelectButton")<0?attrs.selectionMode&&"SINGLE"===$scope.selectionMode.toUpperCase()?"INPUT"===e.target.tagName.toUpperCase()&&(e=$scope.findUpTag(e.target,"div","checkboxLayer"),e=e.previousSibling):e=$scope.findUpTag(e.target,"button","multiSelectButton"):e=e.target),$scope.labelFilter="";for(var multiSelectIndex=-1,checkboxes=document.querySelectorAll(".checkboxLayer"),multiSelectButtons=document.querySelectorAll(".multiSelectButton"),i=0;i<multiSelectButtons.length;i++)if(e===multiSelectButtons[i]){multiSelectIndex=i;break}if(multiSelectIndex>-1){for(var i=0;i<checkboxes.length;i++)i!=multiSelectIndex&&(checkboxes[i].className="multiSelect checkboxLayer hide");"multiSelect checkboxLayer hide"==checkboxes[multiSelectIndex].className?($scope.currentButton=multiSelectButtons[multiSelectIndex],checkboxes[multiSelectIndex].className="multiSelect checkboxLayer dropdown pdDropdown show",$scope.onOpen()):"multiSelect checkboxLayer dropdown pdDropdown show"==checkboxes[multiSelectIndex].className&&(checkboxes[multiSelectIndex].className="multiSelect checkboxLayer hide",$scope.onClose())}},$scope.findUpTag=function(el,tag,className){for(;el.parentNode;)if(el=el.parentNode,"undefined"!=typeof el.tagName&&el.tagName.toUpperCase()===tag.toUpperCase()&&el.className.indexOf(className)>-1)return el;return null},$scope.select=function(type){switch(type.toUpperCase()){case"ALL":angular.forEach($scope.inputModel,function(value){"undefined"!=typeof value&&value[$scope.disableProperty]!==!0&&(value[$scope.tickProperty]=!0)});break;case"NONE":angular.forEach($scope.inputModel,function(value){"undefined"!=typeof value&&value[$scope.disableProperty]!==!0&&(value[$scope.tickProperty]=!1)});break;case"RESET":$scope.inputModel=angular.copy($scope.backUp)}$scope.refreshSelectedItems()};var validate=function(){"inputModel"in attrs||console.log("Multi-select error: input-model is not defined! (ID: "+$scope.directiveId+")"),"buttonLabel"in attrs||console.log("Multi-select error: button-label is not defined! (ID: "+$scope.directiveId+")"),"itemLabel"in attrs||console.log("Multi-select error: item-label is not defined! (ID: "+$scope.directiveId+")"),"tickProperty"in attrs||console.log("Multi-select error: tick-property is not defined! (ID: "+$scope.directiveId+")")},validateProperties=function(arrProperties,arrObject){var notThere=!1;angular.forEach(arrProperties,function(value1){if("undefined"!=typeof value1){var keepGoing=!0;angular.forEach(arrObject,function(value2){if("undefined"!=typeof value2&&keepGoing&&!(value1 in value2)){notThere=!0,keepGoing=!1}})}})};validate(),$scope.refreshSelectedItems(),$scope.$watch("inputModel",function(){"undefined"!==$scope.newVal&&(validateProperties($scope.itemLabel.split(" "),$scope.inputModel),validateProperties(new Array($scope.tickProperty),$scope.inputModel)),$scope.refreshSelectedItems()},!0),$scope.$watch("inputModel",function(){"undefined"!==$scope.newVal&&(validateProperties($scope.itemLabel.split(" "),$scope.inputModel),validateProperties(new Array($scope.tickProperty),$scope.inputModel)),$scope.backUp=angular.copy($scope.inputModel),$scope.refreshSelectedItems()}),$scope.$watch("isDisabled",function(newVal){$scope.isDisabled=newVal}),angular.element(document).bind("touchstart",function(){$scope.$apply(function(){$scope.scrolled=!1})}),angular.element(document).bind("touchmove",function(){$scope.$apply(function(){$scope.scrolled=!0})}),angular.element(document).bind("click touchend",function(e){if("click"===e.type||"touchend"===e.type&&$scope.scrolled===!1){var checkboxes=document.querySelectorAll(".checkboxLayer");if(void 0===e.target.className.indexOf||e.target.className.indexOf("multiSelect")){for(var i=0;i<checkboxes.length;i++)checkboxes[i].className="multiSelect checkboxLayer hide";e.stopPropagation()}}}),Array.prototype.indexOf||(Array.prototype.indexOf=function(what,i){i=i||0;for(var L=this.length;L>i;){if(this[i]===what)return i;++i}return-1})}}}]),angular.module("kyc.directives").directive("shapeshift",["UtilsService","$timeout",function(UtilsService,$timeout){return{restrict:"A",link:function(scope,element,attrs){$timeout(function(){var $shaper=$(element).shapeshift(scope.$eval(attrs.shapeshift));$shaper.on("ss-rearranged",function(){UtilsService.reOrderWidgets(element)})})}}}]),angular.module("kyc.charts").factory("AllCharts",["$q","OrderService","PayingCustomers","OrdersPerCustomer","AverageOrderValue","ItemsOrdered","OrdersByOutlet","MostPopularItems","TimeOfOrdersPlaced","CustomersPie","CustomersBar","Revenue","NumberOfOrders","MenuItemPopularity",function($q,OrderService,PayingCustomers,OrdersPerCustomer,AverageOrderValue,ItemsOrdered,OrdersByOutlet,MostPopularItems,TimeOfOrdersPlaced,CustomersPie,CustomersBar,Revenue,NumberOfOrders,MenuItemPopularity){function init(minDate,maxDate,currencySymbol,selectedOutlets){currency=currencySymbol,initialMinDate=minDate,initialMaxDate=maxDate,OrderService.load(function(orders){prepareCharts(orders,minDate,maxDate,selectedOutlets)})}function findOutlet(selectedOutlets,outletId){var found=!1;return angular.forEach(selectedOutlets,function(outlet){found||outlet.id!=outletId||(found=outlet)}),found}function prepareCharts(orders,minDate,maxDate,selectedOutlets){minDate||(minDate=initialMinDate),maxDate||(maxDate=initialMaxDate),selectedOutlets||(selectedOutlets=[]),angular.forEach(charts,function(chart){chart.clearData()}),angular.forEach(orders,function(order){if(0===selectedOutlets.length||findOutlet(selectedOutlets,order.outletId)){{new Date(order.created).getTime()}angular.forEach(charts,function(chart){chart.setData(order,minDate,maxDate)})}}),angular.forEach(charts,function(chart){chart.onSetDataComplete&&chart.onSetDataComplete(minDate,maxDate,currency)}),defer.resolve(charts)}function getPreparedCharts(){var retCharts=[];return angular.forEach(charts,function(chart){retCharts.push(chart.getHighChart?chart.getHighChart():chart)}),retCharts}var initialMinDate,initialMaxDate,currency,defer=$q.defer(),charts={payingCustomers:PayingCustomers,ordersPerCustomer:OrdersPerCustomer,averageOrderValue:AverageOrderValue,itemsOrdered:ItemsOrdered,ordersByOutlet:OrdersByOutlet,mostPopularItems:MostPopularItems,timeOfOrdersPlaced:TimeOfOrdersPlaced,customersPie:CustomersPie,customersBar:CustomersBar,revenue:Revenue,numberOfOrders:NumberOfOrders,menuItemPopularity:MenuItemPopularity};return{init:init,promise:defer.promise,getPreparedCharts:getPreparedCharts,prepareCharts:prepareCharts}}]),angular.module("kyc.charts").factory("ChartHelper",["$filter","TickInterval",function($filter,TickInterval){function formatDate(timestamp){var date=new Date(timestamp);return $filter("date")(date,"dd-MMM-yyyy")}function getPercentage(data,oldData){var totalData=getPeriodTotal(data),totalOldData=getPeriodTotal(oldData),percentage=100*totalData/totalOldData;return 1/0===percentage?"":percentage.toFixed(2)}function getPeriodTotal(data){var total=0;return angular.forEach(data,function(d){total+=d[1]}),total.toFixed(0)}function getPreparedAreaData(chartData,minTimestamp,maxTimestamp,showDecimal){showDecimal=showDecimal?showDecimal:!1;var previousSpecifiedTimestamp=moment(minTimestamp-(maxTimestamp-minTimestamp)),weekTimestamp=moment().subtract("week",1),lastWeekTimestamp=moment().subtract("week",2),monthTimestamp=moment().subtract("month",1),lastMonthTimestamp=moment().subtract("month",2),threeMonthsTimestamp=moment().subtract("month",3),lastThreeMonthsTimestamp=moment().subtract("month",6),sixMonthsTimestamp=moment().subtract("month",6),lastSixMonthsTimestamp=moment().subtract("month",12),yearTimestamp=moment().subtract("year",1),lastYearTimestamp=moment().subtract("year",2),data=[],dataModal=[],previousSpecifiedData=[],weekData=[],previousWeekData=[],monthData=[],previousMonthData=[],threeMonthsData=[],previousThreeMonthsData=[],sixMonthsData=[],previousSixMonthsData=[],previousYearData=[],total=0,yearData=[],dateType=calculateTickIntervalForString({maxTimestamp:maxTimestamp,minTimestamp:minTimestamp}),functionFilteredDates=null;switch(dateType){case"day":functionFilteredDates=CalculateCharts.day;break;case"week":functionFilteredDates=CalculateCharts.week;break;case"month":functionFilteredDates=CalculateCharts.month}return angular.forEach(chartData,function(dR,key){var orderDate=Number(key),dataRow=[Number(key),Number(dR.toFixed(2))];orderDate>=minTimestamp&&maxTimestamp>=orderDate?(functionFilteredDates(dataModal,dataRow),data.push(dataRow),total+=dR):minTimestamp>orderDate&&orderDate>=previousSpecifiedTimestamp&&previousSpecifiedData.push(dataRow),orderDate>=weekTimestamp&&CalculateCharts.day(weekData,dataRow),orderDate>=lastWeekTimestamp&&weekTimestamp>orderDate&&previousWeekData.push(dataRow),orderDate>=monthTimestamp&&CalculateCharts.day(monthData,dataRow),orderDate>=lastMonthTimestamp&&monthTimestamp>orderDate&&previousMonthData.push(dataRow),orderDate>=threeMonthsTimestamp&&CalculateCharts.week(threeMonthsData,dataRow),orderDate>=lastThreeMonthsTimestamp&&threeMonthsTimestamp>orderDate&&previousThreeMonthsData.push(dataRow),orderDate>=sixMonthsTimestamp&&CalculateCharts.week(sixMonthsData,dataRow),orderDate>=lastSixMonthsTimestamp&&sixMonthsTimestamp>orderDate&&previousSixMonthsData.push(dataRow),orderDate>=yearTimestamp&&CalculateCharts.month(yearData,dataRow),orderDate>=lastYearTimestamp&&yearTimestamp>orderDate&&previousYearData.push(dataRow)}),data.sort(sortData),dataModal.sort(sortData),weekData.sort(sortData),previousWeekData.sort(sortData),monthData.sort(sortData),previousMonthData.sort(sortData),threeMonthsData.sort(sortData),previousThreeMonthsData.sort(sortData),sixMonthsData.sort(sortData),previousSixMonthsData.sort(sortData),yearData.sort(sortData),previousYearData.sort(sortData),showDecimal&&(total=total.toFixed(2)),{data:data,dataModal:dataModal,previousSpecifiedData:previousSpecifiedData,weekData:weekData,previousWeekData:previousWeekData,monthData:monthData,previousMonthData:previousMonthData,threeMonthsData:threeMonthsData,previousThreeMonthsData:previousThreeMonthsData,sixMonthsData:sixMonthsData,previousSixMonthsData:previousSixMonthsData,yearData:yearData,previousYearData:previousYearData,total:total,minTimestamp:minTimestamp,maxTimestamp:maxTimestamp}}function calculateTickInterval(prepData){var daysDiff=moment(prepData.maxTimestamp,"X").diff(moment(prepData.minTimestamp,"X"),"days");switch(!0){case 32>daysDiff:return TickInterval.DAY;case 92>daysDiff:return TickInterval.WEEK;case 183>daysDiff:return TickInterval.WEEK_THREE;default:return TickInterval.MONTH}}function calculateTickIntervalForString(prepData){var daysDiff=moment(prepData.maxTimestamp,"X").diff(moment(prepData.minTimestamp,"X"),"days");switch(!0){case 32>daysDiff:return"day";case 183>daysDiff:return"week";default:return"month"}}function completeEmptyData(data){for(var maxTimeStampForWhile=data.max,minTimestampForWhile=data.min,responseData=angular.copy(data.value);;){var valueOf=maxTimeStampForWhile.valueOf();if(minTimestampForWhile>valueOf)break;var dataFiltered=data.filterData(responseData,valueOf);if(!dataFiltered.length){var valueObject=[valueOf,0];responseData.push(valueObject)}maxTimeStampForWhile=maxTimeStampForWhile.subtract(data.dateType,1)}return responseData.sort(sortData),responseData}function getModalOptions(prepData){return[{name:_tr("Specified Dates"),value:getPeriodTotal(prepData.data),percent:getPercentage(prepData.data,prepData.previousSpecifiedData),active:!0,data:completeEmptyData({max:moment(prepData.maxTimestamp).startOf("day"),min:moment(prepData.minTimestamp).startOf("day").valueOf(),value:prepData.dataModal,dateType:calculateTickIntervalForString(prepData),filterData:function(data,valueOf){switch(this.dateType){case"day":return FilterCharts.day(data,valueOf);case"week":return FilterCharts.week(data,valueOf);case"month":return FilterCharts.month(data,valueOf)}}}),tickInterval:calculateTickInterval(prepData),minTimestamp:prepData.minTimestamp,maxTimestamp:prepData.maxTimestamp},{name:_tr("Week"),value:getPeriodTotal(prepData.weekData),percent:getPercentage(prepData.weekData,prepData.previousWeekData),data:completeEmptyData({max:moment().startOf("day"),min:moment().subtract("week",1).startOf("day").valueOf(),value:prepData.weekData,dateType:"day",filterData:FilterCharts.day}),tickInterval:TickInterval.DAY,minTimestamp:moment().subtract("week",1),maxTimestamp:moment()},{name:_tr("Month"),value:getPeriodTotal(prepData.monthData),percent:getPercentage(prepData.monthData,prepData.previousMonthData),data:completeEmptyData({max:moment().startOf("day"),min:moment().subtract("month",1).startOf("day").valueOf(),value:prepData.monthData,dateType:"day",filterData:FilterCharts.day}),tickInterval:TickInterval.DAY,minTimestamp:moment().subtract("month",1),maxTimestamp:moment()},{name:_tr("3 Months"),value:getPeriodTotal(prepData.threeMonthsData),percent:getPercentage(prepData.threeMonthsData,prepData.previousThreeMonthsData),data:completeEmptyData({max:moment().startOf("day"),min:moment().subtract("month",3).startOf("day").valueOf(),value:prepData.threeMonthsData,dateType:"week",filterData:FilterCharts.week}),tickInterval:TickInterval.WEEK,minTimestamp:moment().subtract("month",3),maxTimestamp:moment()},{name:_tr("6 Months"),value:getPeriodTotal(prepData.sixMonthsData),percent:getPercentage(prepData.sixMonthsData,prepData.previousSixMonthsData),data:completeEmptyData({max:moment().startOf("day"),min:moment().subtract("month",6).startOf("day").valueOf(),value:prepData.sixMonthsData,dateType:"week",filterData:FilterCharts.week}),tickInterval:TickInterval.WEEK_THREE,minTimestamp:moment().subtract("month",6),maxTimestamp:moment()},{name:_tr("Year"),value:getPeriodTotal(prepData.yearData),percent:getPercentage(prepData.yearData,prepData.previousYearData),data:completeEmptyData({max:moment().startOf("day"),min:moment().subtract("year",1).startOf("day").valueOf(),value:prepData.yearData,dateType:"month",filterData:FilterCharts.month}),tickInterval:TickInterval.MONTH,minTimestamp:moment().subtract("year",1),maxTimestamp:moment()}]}function sortData(a,b){return a[0]-b[0]}var FilterCharts={day:function(data,valueOf){return data.filter(function(y){return moment(y[0]).valueOf()===moment(valueOf).valueOf()})},week:function(data,valueOf){return data.filter(function(y){return moment(y[0]).week()===moment(valueOf).week()})},month:function(data,valueOf){return data.filter(function(y){return moment(y[0]).month()==moment(valueOf).month()})}},CalculateCharts={day:function(data,dataRow){var daysFiltered=FilterCharts.day(data,dataRow[0]),dataRowCopied=angular.copy(dataRow);daysFiltered.length?daysFiltered[1]+=+dataRowCopied[1]:(dataRowCopied[0]=moment(dataRowCopied[0]).startOf("day").valueOf(),data.push(dataRowCopied))},week:function(data,dataRow){var weekFiltered=FilterCharts.week(data,dataRow[0]),dataRowCopied=angular.copy(dataRow);weekFiltered.length?data[data.indexOf(weekFiltered[0])][1]+=+dataRowCopied[1]:(dataRowCopied[0]=moment(dataRowCopied[0]).startOf("week").valueOf(),data.push(dataRowCopied))},month:function(data,dataRow){var monthsFiltered=FilterCharts.month(data,dataRow[0]),dataRowCopied=angular.copy(dataRow);monthsFiltered.length?data[data.indexOf(monthsFiltered[0])][1]+=dataRowCopied[1]:(dataRowCopied[0]=moment(dataRowCopied[0]).startOf("month").valueOf(),data.push(dataRowCopied))}};return{formatDate:formatDate,getPercentage:getPercentage,getPeriodTotal:getPeriodTotal,getPreparedAreaData:getPreparedAreaData,getModalOptions:getModalOptions}}]),angular.module("kyc.charts").factory("PayingCustomers",["ChartType",function(ChartType){function clearData(){newCustomers=[],repeatedCustomers=[]}function setData(order,minDate,maxDate){var orderData=moment(order.created);if(orderData>=minDate&&maxDate>=orderData){var customerId=order.userId;-1===newCustomers.indexOf(customerId)?newCustomers.push(customerId):-1===repeatedCustomers.indexOf(customerId)&&repeatedCustomers.push(customerId)}}function getData(){return newCustomers.length}function getType(){return type}function getHighChart(){return{type:type,title:title,data:getData()}}var type=ChartType.NUMBER,newCustomers=[],repeatedCustomers=[],title=_tr("Total Customers");return{getData:getData,getType:getType,setData:setData,getHighChart:getHighChart,clearData:clearData}}]),angular.module("kyc.charts").factory("OrdersPerCustomer",["ChartType",function(ChartType){function clearData(){newCustomers=[],repeatedCustomers=[],orders=0}function setData(order,minDate,maxDate){var orderData=moment(order.created);if(orderData>=minDate&&maxDate>=orderData){orders++;var customerId=order.userId;-1===newCustomers.indexOf(customerId)?newCustomers.push(customerId):-1===repeatedCustomers.indexOf(customerId)&&repeatedCustomers.push(customerId)}}function getData(){return(orders/newCustomers.length).toFixed(2)}function getType(){return type}function getHighChart(){return{type:type,title:title,data:getData()}}var type=ChartType.NUMBER,newCustomers=[],repeatedCustomers=[],orders=0,title=_tr("Orders per Customer");return{getData:getData,getType:getType,setData:setData,getHighChart:getHighChart,clearData:clearData}}]),angular.module("kyc.charts").factory("AverageOrderValue",["ChartType",function(ChartType){function setData(order,minDate,maxDate){var orderData=moment(order.created);orderData>=minDate&&maxDate>=orderData&&(numOfOrders++,ordersTotal+=order.total)}function clearData(){ordersTotal=0,numOfOrders=0}function getData(){return(ordersTotal/numOfOrders).toFixed(2)}function getType(){return type
}function getHighChart(){return{type:type,title:title,data:getData(),currency:"£"}}var type=ChartType.NUMBER,ordersTotal=0,numOfOrders=0,title=_tr("Average Order Value");return{getData:getData,getType:getType,setData:setData,getHighChart:getHighChart,clearData:clearData}}]),angular.module("kyc.charts").factory("ItemsOrdered",["ChartType",function(ChartType){function setData(order,minDate,maxDate){var orderData=moment(order.created);orderData>=minDate&&maxDate>=orderData&&angular.forEach(order.items,function(item){itemsOrdered+=item.qty})}function getData(){return itemsOrdered}function getType(){return type}function getHighChart(){return{type:type,title:title,data:getData()}}function clearData(){itemsOrdered=0}var type=ChartType.NUMBER,itemsOrdered=0,title=_tr("Items Ordered");return{getData:getData,getType:getType,setData:setData,getHighChart:getHighChart,clearData:clearData}}]),angular.module("kyc.charts").factory("OrdersByOutlet",["ChartType","Colors","OutletService","ChartHelper",function(ChartType,Colors,OutletService){function clearData(){colorIndex=0,ordersByOutlet={}}function setData(order,minDate,maxDate){minTimestamp=minDate.valueOf(),maxTimestamp=maxDate.valueOf();var orderData=moment(order.created);if(orderData>=minDate&&maxDate>=orderData){var outletId=order.outletId;void 0===ordersByOutlet[outletId]&&(ordersByOutlet[outletId]={y:0}),ordersByOutlet[outletId].y+=1}}function getData(){colorIndex=0;var ordersByOutletArray=[];return angular.forEach(ordersByOutlet,function(item,outletId){ordersByOutletArray.push({name:OutletService.getOutletName(outletId),color:Colors[colorIndex],y:item.y}),colorIndex++}),ordersByOutletArray}function getType(){return type}function getHighChart(){return{type:type,title:title,data:getData(),getPdf:getPdf,getCsv:getCsv}}function getCsv(){var data=getData(),csvData=[[moment(minTimestamp).format("DD-MMM-YYYY")+" - "+moment(maxTimestamp).format("DD-MMM-YYYY")],[title]];return angular.forEach(data,function(d){csvData.push([d.name,d.y])}),{data:csvData}}function getPdf(){return chartInfo={type:type,title:title,startDate:minTimestamp,endDate:maxTimestamp,dataJson:JSON.stringify(getData()),categories:getCategories()}}function getCategories(){var arr=[];return angular.forEach(ordersByOutlet,function(item,outletId){arr.push(OutletService.getOutletName(outletId))}),arr}var type=ChartType.PIE,ordersByOutlet={},colorIndex=0,title=_tr("Orders By Outlet"),minTimestamp=0,maxTimestamp=0;return{getData:getData,getType:getType,setData:setData,getHighChart:getHighChart,clearData:clearData}}]),angular.module("kyc.charts").factory("MostPopularItems",["ChartType","Colors","ChartHelper",function(ChartType,Colors){function clearData(){items={},top5=[{y:0,color:Colors[0]},{y:0,color:Colors[1]},{y:0,color:Colors[2]},{y:0,color:Colors[3]},{y:0,color:Colors[4]}]}function setData(order,minDate,maxDate){minTimestamp=minDate.valueOf(),maxTimestamp=maxDate.valueOf();var orderData=moment(order.created);orderData>=minDate&&maxDate>=orderData&&angular.forEach(order.items,function(item){void 0!==items[item.menuItemId]?items[item.menuItemId].quantity++:items[item.menuItemId]={name:item.name,quantity:1}})}function onSetDataComplete(){for(var id in items)for(var pos in top5)if(items[id].quantity>top5[pos].y){for(var i=top5.length-1;i>pos;i--)top5[i].y=top5[i-1].y,top5[i].name=top5[i-1].name;top5[pos].y=items[id].quantity,top5[pos].name=items[id].name;break}top5=_.filter(top5,function(row){return void 0!==row.name})}function getData(){return top5}function getType(){return type}function getHighChart(){return{type:type,title:title,data:getData(),getPdf:getPdf,getCsv:getCsv}}function getCsv(){var data=getData(),csvData=[[moment(minTimestamp).format("DD-MMM-YYYY")+" - "+moment(maxTimestamp).format("DD-MMM-YYYY")],[title]];return angular.forEach(data,function(d){csvData.push([d.name,d.y])}),{data:csvData}}function getPdf(){return chartInfo={type:type,title:title,startDate:minTimestamp,endDate:maxTimestamp,dataJson:angular.toJson(getData()),categories:getCategories()}}function getCategories(){var arr=[];return angular.forEach(top5,function(item){arr.push(item.name)}),arr}var type=ChartType.PIE,items={},title=_tr("Most Popular Items"),minTimestamp=0,maxTimestamp=0,top5=[{y:0,color:Colors[0]},{y:0,color:Colors[1]},{y:0,color:Colors[2]},{y:0,color:Colors[3]},{y:0,color:Colors[4]}];return{getData:getData,getType:getType,setData:setData,onSetDataComplete:onSetDataComplete,getHighChart:getHighChart,clearData:clearData}}]),angular.module("kyc.charts").factory("TimeOfOrdersPlaced",["ChartType","Colors","ChartHelper",function(ChartType,Colors){function clearData(){data=[{name:_tr("On the day"),y:0,color:Colors[0]},{name:_tr("In advance"),y:0,color:Colors[1]}],colorIndex=0}function setData(order,minDate,maxDate){minTimestamp=minDate.valueOf(),maxTimestamp=maxDate.valueOf();var orderData=moment(order.created);if(orderData>=minDate&&maxDate>=orderData&&void 0!==order.created&&void 0!==order.pickupTime){var placed=new Date(order.created).setHours(0,0,0,0),pickup=new Date(order.pickupTime).setHours(0,0,0,0);placed===pickup?data[0].y++:data[1].y++}}function onSetDataComplete(){}function getData(){return data}function getType(){return type}function getHighChart(){return{type:type,title:title,data:getData(),getPdf:getPdf,getCsv:getCsv}}function getCsv(){var data=getData(),csvData=[[moment(minTimestamp).format("DD-MMM-YYYY")+" - "+moment(maxTimestamp).format("DD-MMM-YYYY")],[title]];return angular.forEach(data,function(d){csvData.push([d.name,d.y])}),{data:csvData}}function getPdf(){return chartInfo={type:type,title:title,startDate:minTimestamp,endDate:maxTimestamp,dataJson:JSON.stringify(data),categories:[_tr("On the day"),_tr("In advance")]}}var data,type=ChartType.PIE,colorIndex=0,title=_tr("Time of Orders Placed"),minTimestamp=0,maxTimestamp=0;return{getData:getData,getType:getType,setData:setData,onSetDataComplete:onSetDataComplete,getHighChart:getHighChart,clearData:clearData}}]),angular.module("kyc.charts").factory("CustomersPie",["ChartType","Colors","ChartHelper",function(ChartType,Colors){function clearData(){colorIndex=0,data=[{name:_tr("New"),y:0,color:Colors[0]},{name:_tr("Returning"),y:0,color:Colors[1]}],newCustomers=[],repeatedCustomers=[]}function setData(order,minDate,maxDate){minTimestamp=minDate.valueOf(),maxTimestamp=maxDate.valueOf();var orderData=moment(order.created);if(orderData>=minDate&&maxDate>=orderData){var customerId=order.userId;-1===newCustomers.indexOf(customerId)?(newCustomers.push(customerId),data[0].y++):-1===repeatedCustomers.indexOf(customerId)&&(repeatedCustomers.push(customerId),data[1].y++)}}function getData(){return data}function getType(){return type}function getHighChart(){return{type:type,title:title,data:getData(),getPdf:getPdf,getCsv:getCsv}}function getCsv(){var data=getData(),csvData=[[moment(minTimestamp).format("DD-MMM-YYYY")+" - "+moment(maxTimestamp).format("DD-MMM-YYYY")],[title]];return angular.forEach(data,function(d){csvData.push([d.name,d.y])}),{data:csvData}}function getPdf(){return chartInfo={type:type,title:title,startDate:minTimestamp,endDate:maxTimestamp,dataJson:JSON.stringify(data),categories:[data[0].name,data[1].name]}}var type=ChartType.PIE,colorIndex=0,title=_tr("Customers (Pie)"),data=[{name:_tr("New"),y:0,color:Colors[0]},{name:_tr("Returning"),y:0,color:Colors[1]}],newCustomers=[],repeatedCustomers=[],minTimestamp=0,maxTimestamp=0;return{getData:getData,getType:getType,setData:setData,getHighChart:getHighChart,clearData:clearData}}]),angular.module("kyc.charts").factory("CustomersBar",["ChartType","ChartHelper",function(ChartType){function setData(order,minDate,maxDate){minTimestamp=minDate.valueOf(),maxTimestamp=maxDate.valueOf();var orderData=moment(order.created);if(orderData>=minDate&&maxDate>=orderData){var customerId=order.userId;-1===newCustomers.indexOf(customerId)?(newCustomers.push(customerId),data[0].y++):-1===repeatedCustomers.indexOf(customerId)&&(repeatedCustomers.push(customerId),data[1].y++)}}function clearData(){data=[{name:_tr("New"),y:0},{name:_tr("Returning"),y:0}],newCustomers=[],repeatedCustomers=[]}function getData(){return data}function getType(){return type}function getHighChart(){return{type:type,title:title,data:getData(),getPdf:getPdf,getCsv:getCsv}}function getCsv(){var data=getData(),csvData=[[moment(minTimestamp).format("DD-MMM-YYYY")+" - "+moment(maxTimestamp).format("DD-MMM-YYYY")],[title]];return angular.forEach(data,function(d){csvData.push([d.name,d.y])}),{data:csvData}}function getPdf(){return chartInfo={type:type,title:title,startDate:minTimestamp,endDate:maxTimestamp,dataJson:JSON.stringify([data[0].y,data[1].y]),categories:[data[0].name,data[1].name]}}var type=ChartType.COLUMN,title=_tr("Customers (Bar)"),data=[{name:_tr("New"),y:0},{name:_tr("Returning"),y:0}],newCustomers=[],repeatedCustomers=[],minTimestamp=0,maxTimestamp=0;return{getData:getData,getType:getType,setData:setData,getHighChart:getHighChart,clearData:clearData}}]),angular.module("kyc.charts").factory("NumberOfOrders",["ChartType","ChartHelper",function(ChartType,ChartHelper){function setData(order){var timestamp=moment(order.paid).startOf("day").valueOf();dailyOrders[timestamp]?dailyOrders[timestamp]++:dailyOrders[timestamp]=1}function onSetDataComplete(minDate,maxDate){minTimestamp=minDate.valueOf(),maxTimestamp=maxDate.valueOf(),prepData=ChartHelper.getPreparedAreaData(dailyOrders,minDate,maxDate)}function getData(){return prepData.data}function getType(){return type}function getHighChart(){return{type:type,title:title,data:getData(),numberLeft:prepData.total,numberRight:ChartHelper.getPercentage(getData(),prepData.previousSpecifiedData),modal:getModal(),getPdf:getPdf,getCsv:getCsv,tooltipText:_tr(" orders")}}function getPdf(){return chartInfo={type:type,title:title,startDate:minTimestamp,endDate:maxTimestamp,total:prepData.total,currency:"",percentage:ChartHelper.getPercentage(prepData.data,prepData.previousSpecifiedData),dataJson:JSON.stringify(getData())}}function clearData(){prepData={},dailyOrders={}}function getCsv(){var data=getData(),csvData=[[moment(minTimestamp).format("DD-MMM-YYYY")+" - "+moment(maxTimestamp).format("DD-MMM-YYYY")],[title]];return angular.forEach(data,function(d){csvData.push([ChartHelper.formatDate(d[0]),d[1]])}),{data:csvData}}function getModal(){return{highcharts:{type:ChartType.AREA_MODAL},options:ChartHelper.getModalOptions(prepData)}}var type=ChartType.AREA,dailyOrders={},title=_tr("Number of Orders"),minTimestamp=0,maxTimestamp=0,prepData={};return{getData:getData,getType:getType,clearData:clearData,setData:setData,onSetDataComplete:onSetDataComplete,getHighChart:getHighChart}}]),angular.module("kyc.charts").factory("MenuItemPopularity",["ChartType","ChartHelper",function(ChartType,ChartHelper){function setData(order){var timestamp=moment(order.created).startOf("day").valueOf();angular.forEach(order.items,function(item){void 0===menuItems[item.menuItemId]&&(selectedItem=-1==selectedItem?item.menuItemId:selectedItem,items.push({name:item.name,menuItemId:item.menuItemId,callback:selectItem}),menuItems[item.menuItemId]={}),void 0===menuItems[item.menuItemId][timestamp]&&(menuItems[item.menuItemId][timestamp]=0),menuItems[item.menuItemId][timestamp]++})}function selectItem(itemId,cb){clearData(),selectedItem=itemId,onSetDataComplete(minDate,maxDate),cb(getHighChart())}function onSetDataComplete(minDateP,maxDateP){minDate=minDateP,maxDate=maxDateP,prepData=ChartHelper.getPreparedAreaData(menuItems[selectedItem],minDate,maxDate,!1)}function getData(){return prepData.data}function getType(){return type}function getHighChart(){return{type:type,title:title,data:getData(),numberLeft:prepData.total,modal:getModal(),items:items,getPdf:getPdf,getCsv:getCsv,tooltipText:_tr(" orders")}}function getCsv(){var data=getData(),csvData=[[minDate.format("DD-MMM-YYYY")+" - "+maxDate.format("DD-MMM-YYYY")],[getItemName(selectedItem)]];return angular.forEach(data,function(d){csvData.push([ChartHelper.formatDate(d[0]),d[1]])}),{data:csvData}}function getPdf(){return chartInfo={type:type,title:title+" - "+getItemName(selectedItem),startDate:minDate.valueOf(),endDate:maxDate.valueOf(),total:prepData.total,percentage:ChartHelper.getPercentage(prepData.data,prepData.previousSpecifiedData),dataJson:JSON.stringify(getData())}}function clearData(){prepData={}}function getItemName(itemId){var found=!1;return angular.forEach(items,function(item){item.menuItemId==itemId&&(found=item.name)}),found}function getModal(){return{highcharts:{type:ChartType.AREA_MODAL},options:ChartHelper.getModalOptions(prepData)}}var minDate,maxDate,type=ChartType.AREA,title=_tr("Menu Item Popularity"),menuItems={},selectedItem=-1,prepData={},items=[];return{getData:getData,getType:getType,clearData:clearData,setData:setData,onSetDataComplete:onSetDataComplete,getHighChart:getHighChart}}]),angular.module("kyc.charts").factory("Revenue",["ChartType","ChartHelper",function(ChartType,ChartHelper){function setData(order){var timestamp=moment(order.paid).startOf("day").valueOf();dailyRevenue[timestamp]?dailyRevenue[timestamp]+=order.total:dailyRevenue[timestamp]=order.total}function onSetDataComplete(minDate,maxDate,currencySymbol){currency=currencySymbol,minTimestamp=minDate.valueOf(),maxTimestamp=maxDate.valueOf(),prepData=ChartHelper.getPreparedAreaData(dailyRevenue,minDate,maxDate,!0)}function getData(){return prepData.data}function getType(){return type}function getHighChart(){return{type:type,title:title,data:getData(),currency:currency,numberLeft:prepData.total,numberRight:ChartHelper.getPercentage(prepData.data,prepData.previousSpecifiedData),modal:getModal(),getPdf:getPdf,getCsv:getCsv,tooltipText:decodeURI(currency)}}function getCsv(){var data=getData(),csvData=[[moment(minTimestamp).format("DD-MMM-YYYY")+" - "+moment(maxTimestamp).format("DD-MMM-YYYY")],[title]];return angular.forEach(data,function(d){csvData.push([ChartHelper.formatDate(d[0]),d[1]])}),{data:csvData}}function clearData(){dailyRevenue={},prepData={}}function getPdf(){return chartInfo={type:type,title:title,startDate:minTimestamp,endDate:maxTimestamp,total:prepData.total,currency:currency,percentage:ChartHelper.getPercentage(prepData.data,prepData.previousSpecifiedData),dataJson:JSON.stringify(getData())}}function getModal(){return{highcharts:{type:ChartType.AREA_MODAL},options:ChartHelper.getModalOptions(prepData)}}var currency,type=ChartType.AREA,dailyRevenue={},title=_tr("Revenue"),prepData={},minTimestamp=0,maxTimestamp=0;return{getData:getData,getType:getType,clearData:clearData,setData:setData,onSetDataComplete:onSetDataComplete,getHighChart:getHighChart}}]),angular.module("kyc.reports").factory("AllReports",["$q","Report","NewCustomers","ZeroOrdersCustomers","OneTimeBuyers","MostFrequentBuyers","HighestSpendingCustomers","CustomersIncreasingOrders","CustomersIncreasingSpend","CustomersDecreasingOrders","CustomersDecreasingSpend","SleepingCustomers","MostPopularItemsReport","ItemPopularityIncrease","ItemPopularityDecrease","HighestGrossingDays","LowestGrossingDays","HighestOrderDays","LowestOrderDays","HighestOrderHours","HighestGrossingHours","VENUE_ID",function($q,Report,NewCustomers,ZeroOrdersCustomers,OneTimeBuyers,MostFrequentBuyers,HighestSpendingCustomers,CustomersIncreasingOrders,CustomersIncreasingSpend,CustomersDecreasingOrders,CustomersDecreasingSpend,SleepingCustomers,MostPopularItems,ItemPopularityIncrease,ItemPopularityDecrease,HighestGrossingDays,LowestGrossingDays,HighestOrderDays,LowestOrderDays,HighestOrderHours,HighestGrossingHours,VENUE_ID){function setTitles(report){var titles=[],data=report.getData();for(var key in data){angular.forEach(data[key],function(val,prop){"$"!=String(prop[0])&&titles.push(prop)}),report.setTitles(titles);break}}function fetchData(){var now=moment().valueOf(),lastMonthEnd=moment().subtract("month",1).valueOf(),lastMonthBegin=moment().subtract("month",2).valueOf();return $q.all([Report.items({venueId:VENUE_ID}).$promise,Report.orders({venueId:VENUE_ID}).$promise,Report.customerOrders({venueId:VENUE_ID}).$promise,Report.customerOrders({venueId:VENUE_ID,maxDate:now,minDate:lastMonthEnd}).$promise,Report.customerOrders({venueId:VENUE_ID,maxDate:lastMonthEnd,minDate:lastMonthBegin}).$promise])}function initReports(data){console.log("data",data),AllReports.data={items:data[0],orders:prepareOrders(data[1]),customerOrders:prepareCustomerOrders(data[2],data[3],data[4])};var promises=[];return angular.forEach(reportsList,function(report){report.init&&promises.push(report.init())}),$q.all(promises)}function prepareOrders(orders){return angular.forEach(orders,function(order){order.day=moment(order.created).startOf("day").valueOf(),order.hour=moment(order.created).hour()}),orders}function prepareCustomerOrders(customerOrders,thisMonthCustomerOrders,lastMonthCustomerOrders){return console.log(customerOrders.length,thisMonthCustomerOrders.length,lastMonthCustomerOrders.length),angular.forEach(customerOrders,function(customerOrder){var thisMonth,lastMonth;for(var index in thisMonthCustomerOrders)if(thisMonthCustomerOrders[index].id===customerOrder.id){thisMonth=thisMonthCustomerOrders[index];break}for(var index in lastMonthCustomerOrders)if(lastMonthCustomerOrders[index].id===customerOrder.id){lastMonth=lastMonthCustomerOrders[index];break}thisMonth&&thisMonth.orders&&lastMonth&&lastMonth.orders&&(customerOrder.orderPercentage=100*thisMonth.orders/lastMonth.orders,customerOrder.orderPercentage=thisMonth.orders>lastMonth.orders?customerOrder.orderPercentage:-customerOrder.orderPercentage,customerOrder.totalPercentage=100*thisMonth.total/lastMonth.total,customerOrder.totalPercentage=thisMonth.total>lastMonth.total?customerOrder.totalPercentage:-customerOrder.totalPercentage)}),customerOrders}var AllReports=function(){},reportsList=[NewCustomers,ZeroOrdersCustomers,OneTimeBuyers,MostFrequentBuyers,HighestSpendingCustomers,CustomersIncreasingOrders,CustomersIncreasingSpend,CustomersDecreasingOrders,CustomersDecreasingSpend,SleepingCustomers,MostPopularItems,ItemPopularityIncrease,ItemPopularityDecrease,HighestGrossingDays,LowestGrossingDays,HighestOrderDays,LowestOrderDays,HighestOrderHours,HighestGrossingHours],optionsMap={dateJoined:_tr("Date Joined"),name:_tr("Name"),email:_tr("Email Address"),marketing:_tr("Marketing"),dateOfOrder:_tr("Date of Order"),numberOfOrders:_tr("Number of Orders"),totalSpent:_tr("Total Spent"),percentIncrease:_tr("% Increase"),percentDecrease:_tr("% Decrease"),lastOrder:_tr("Last Order"),itemName:_tr("Item Name"),quantitySold:_tr("Quantity Sold"),day:_tr("Day"),date:_tr("Date"),valueSold:_tr("Value Sold")};return AllReports.init=function(){var deferred=$q.defer();return fetchData().then(initReports).then(function(){angular.forEach(reportsList,function(report){report.setData(AllReports.data)}),angular.forEach(reportsList,function(report){report.onSetDataComplete&&report.onSetDataComplete(),setTitles(report),report.title=report.getTitle()}),deferred.resolve()}),deferred.promise},AllReports.getTitle=function(prop){return optionsMap[prop]?optionsMap[prop]:prop},AllReports.getReportsList=function(){return reportsList},AllReports}]),angular.module("kyc.reports").factory("NewCustomers",[function(){var title=_tr("New Customers"),Report={},data={},titles=[],dateRange=moment().subtract("week",2);return Report.setData=function(reportsData){angular.forEach(reportsData.customerOrders,function(customerOrder){var created=moment(customerOrder.created);created>dateRange&&void 0===data[customerOrder.id]&&(data[customerOrder.id]={dateJoined:customerOrder.created,name:customerOrder.firstName+" "+customerOrder.lastName,email:customerOrder.username,marketing:customerOrder.optinLoyalty||customerOrder.optinOffers||customerOrder.optinOther})})},Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("ZeroOrdersCustomers",["VenueCustomers","VENUE_ID",function(VenueCustomers,VENUE_ID){var customers,title=_tr("Customers with zero orders"),titles=[],data={},Report={},customersWithOrders=[];return Report.init=function(){return data={},customersWithOrders=[],customers=VenueCustomers.query({id:VENUE_ID}),customers.$promise},Report.setData=function(reportsData){angular.forEach(reportsData.customerOrders,function(customerOrder){customerOrder.total&&(data[customerOrder.id]={dateJoined:customerOrder.created,name:customerOrder.firstName+" "+customerOrder.lastName,email:customerOrder.username,marketing:customerOrder.optinLoyalty||customerOrder.optinOffers||customerOrder.optinOther})})},Report.onSetDataComplete=function(){},Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("OneTimeBuyers",[function(){var title=_tr("One Time Buyers"),Report={},data={},titles=[];return Report.setData=function(reportsData){angular.forEach(reportsData.customerOrders,function(customerOrder){void 0===data[customerOrder.id]&&1===customerOrder.orders&&(data[customerOrder.id]={dateJoined:customerOrder.created,dateOfOrder:customerOrder.firstOrder,name:customerOrder.firstName+" "+customerOrder.lastName,email:customerOrder.username,marketing:customerOrder.optinLoyalty||customerOrder.optinOffers||customerOrder.optinOther})}),console.log("set data",data)},Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("MostFrequentBuyers",[function(){var title=_tr("Most Frequent Buyers"),Report={},data={},titles=[];return Report.setData=function(reportsData){reportsData.customerOrders.sort(function(a,b){return a.orders-b.orders}),angular.forEach(reportsData.customerOrders,function(customerOrder){moment(customerOrder.created);void 0===data[customerOrder.id]&&(data[customerOrder.id]={numberOfOrders:customerOrder.orders,name:customerOrder.firstName+" "+customerOrder.lastName,email:customerOrder.username,marketing:customerOrder.optinLoyalty||customerOrder.optinOffers||customerOrder.optinOther})})},Report.orderBy="numberOfOrders",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("HighestSpendingCustomers",[function(){var title=_tr("Highest Spending Customers"),Report={},data={},titles=[];return Report.setData=function(reportsData){angular.forEach(reportsData.customerOrders,function(customerOrder){moment(customerOrder.created);void 0===data[customerOrder.id]&&(data[customerOrder.id]={totalSpent:null===customerOrder.total?0:customerOrder.total,name:customerOrder.firstName+" "+customerOrder.lastName,email:customerOrder.username,marketing:customerOrder.optinLoyalty||customerOrder.optinOffers||customerOrder.optinOther})})},Report.orderBy="totalSpent",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("CustomersIncreasingOrders",[function(){var title=_tr("Customers Increasing Orders"),Report={},data={},titles=[];return Report.setData=function(reportsData){console.log(reportsData),angular.forEach(reportsData.customerOrders,function(customerOrder){void 0===data[customerOrder.id]&&!isNaN(customerOrder.orderPercentage)&&customerOrder.orderPercentage>0&&(data[customerOrder.id]={percentIncrease:customerOrder.orderPercentage.toFixed(0),name:customerOrder.firstName+" "+customerOrder.lastName,email:customerOrder.username,marketing:customerOrder.optinLoyalty||customerOrder.optinOffers||customerOrder.optinOther})}),console.log("set data",data)},Report.orderby="percentIncrease",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("CustomersDecreasingOrders",[function(){var title=_tr("Customers Decreasing Orders"),Report={},data={},titles=[];return Report.setData=function(reportsData){console.log(reportsData),angular.forEach(reportsData.customerOrders,function(customerOrder){void 0===data[customerOrder.id]&&!isNaN(customerOrder.orderPercentage)&&customerOrder.orderPercentage<0&&(data[customerOrder.id]={percentDecrease:customerOrder.orderPercentage.toFixed(0),name:customerOrder.firstName+" "+customerOrder.lastName,email:customerOrder.username,marketing:customerOrder.optinLoyalty||customerOrder.optinOffers||customerOrder.optinOther})}),console.log("set data",data)},Report.orderby="percentIncrease",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("CustomersIncreasingSpend",[function(){var title=_tr("Customers Increasing Spend"),Report={},data={},titles=[];return Report.setData=function(reportsData){console.log(reportsData),angular.forEach(reportsData.customerOrders,function(customerOrder){void 0===data[customerOrder.id]&&!isNaN(customerOrder.totalPercentage)&&customerOrder.totalPercentage>0&&(data[customerOrder.id]={percentIncrease:customerOrder.totalPercentage.toFixed(0),name:customerOrder.firstName+" "+customerOrder.lastName,email:customerOrder.username,marketing:customerOrder.optinLoyalty||customerOrder.optinOffers||customerOrder.optinOther})}),console.log("set data",data)},Report.orderby="percentIncrease",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("CustomersDecreasingSpend",[function(){var title=_tr("Customers Increasing Spend"),Report={},data={},titles=[];return Report.setData=function(reportsData){console.log(reportsData),angular.forEach(reportsData.customerOrders,function(customerOrder){void 0===data[customerOrder.id]&&!isNaN(customerOrder.totalPercentage)&&customerOrder.totalPercentage<0&&(data[customerOrder.id]={percentDecrease:customerOrder.totalPercentage.toFixed(0),name:customerOrder.firstName+" "+customerOrder.lastName,email:customerOrder.username,marketing:customerOrder.optinLoyalty||customerOrder.optinOffers||customerOrder.optinOther})}),console.log("set data",data)},Report.orderby="percentIncrease",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("SleepingCustomers",[function(){var title=_tr("Sleeping Customers"),Report={},data={},titles=[],dateRange=moment().subtract("month",3);return Report.setData=function(reportsData){angular.forEach(reportsData.customerOrders,function(customerOrder){void 0===data[customerOrder.id]&&moment(customerOrder.lastOrder).valueOf()>dateRange.valueOf()&&(data[customerOrder.id]={lastOrder:customerOrder.lastOrder,name:customerOrder.firstName+" "+customerOrder.lastName,email:customerOrder.username,marketing:customerOrder.optinLoyalty||customerOrder.optinOffers||customerOrder.optinOther})}),console.log("set data",data)},Report.orderby="lastOrder",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("MostPopularItemsReport",[function(){var title=_tr("Most Popular Items"),Report={},data={},titles=[];return Report.setData=function(reportsData){angular.forEach(reportsData.items,function(item){void 0===data[item.menuItemId]?data[item.menuItemId]={itemName:item.name,quantitySold:item.qty}:data[item.menuItemId].quantitySold+=item.qty})},Report.orderBy="quantitySold",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("ItemPopularityIncrease",[function(){var title=_tr("Item Popularity Increase"),Report={},data={},tempData={},titles=[];return Report.setData=function(reportsData){var thisMonth=moment().subtract("month",1).format("X"),lastMonth=moment().subtract("month",2).format("X");angular.forEach(reportsData.items,function(item){void 0===tempData[item.menuItemId]&&(tempData[item.menuItemId]={name:item.name,$thisMonthQuantitySold:0,$lastMonthQuantitySold:0});var created=moment(item.created).format("X");created>=thisMonth?tempData[item.menuItemId].$thisMonthQuantitySold+=item.qty:created>lastMonth&&(tempData[item.menuItemId].$lastMonthQuantitySold+=item.qty)}),console.log(tempData,"tempData")},Report.onSetDataComplete=function(){angular.forEach(tempData,function(item,key){if(console.log("each item",item),item.$thisMonthQuantitySold>item.$lastMonthQuantitySold){var popularity=100*item.$thisMonthQuantitySold/item.$lastMonthQuantitySold;data[key]={itemName:item.name,quantitySold:item.$thisMonthQuantitySold,percentIncrease:popularity.toFixed(0)}}}),console.log("data",data)},Report.orderBy="",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("ItemPopularityDecrease",[function(){var title=_tr("Item Popularity Decrease"),Report={},data={},tempData={},titles=[];return Report.setData=function(reportsData){var thisMonth=moment().subtract("month",1).format("X"),lastMonth=moment().subtract("month",2).format("X");angular.forEach(reportsData.items,function(item){void 0===tempData[item.menuItemId]&&(tempData[item.menuItemId]={name:item.name,$thisMonthQuantitySold:0,$lastMonthQuantitySold:0});var created=moment(item.created).format("X");created>=thisMonth?tempData[item.menuItemId].$thisMonthQuantitySold+=item.qty:created>lastMonth&&(tempData[item.menuItemId].$lastMonthQuantitySold+=item.qty)}),console.log(tempData,"tempData")},Report.onSetDataComplete=function(){angular.forEach(tempData,function(item,key){if(item.$thisMonthQuantitySold<item.$lastMonthQuantitySold){var popularity=100*item.$thisMonthQuantitySold/item.$lastMonthQuantitySold;data[key]={itemName:item.name,quantitySold:item.$thisMonthQuantitySold,percentDecrease:popularity.toFixed(0)}}}),console.log("data",data)},Report.orderBy="",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("HighestGrossingDays",[function(){var title=_tr("Highest Grossing Days"),Report={},data=[],titles=[],dateRange=moment().subtract("month",1),itemsToShow=10;return Report.setData=function(reportsData){var tempData={},grouped=_.groupBy(reportsData.orders,"day");angular.forEach(grouped,function(day,key){key>dateRange.valueOf()&&angular.forEach(day,function(order){void 0===tempData[key]?tempData[key]={day:order.created,date:order.created,valueSold:order.total}:tempData[key].valueSold+=order.total})}),data=_.sortBy(tempData,function(row){return-row.valueSold}).slice(0,itemsToShow)},Report.orderBy="valueSold",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("LowestGrossingDays",[function(){var title=_tr("Lowest Grossing Days"),Report={},data=[],titles=[],dateRange=moment().subtract("month",1),itemsToShow=10;
return Report.setData=function(reportsData){var tempData={},grouped=_.groupBy(reportsData.orders,"day");angular.forEach(grouped,function(day,key){key>dateRange.valueOf()&&angular.forEach(day,function(order){void 0===tempData[key]?tempData[key]={day:order.created,date:order.created,valueSold:order.total}:tempData[key].valueSold+=order.total})}),data=_.sortBy(tempData,function(row){return row.valueSold}).slice(0,itemsToShow)},Report.orderBy="valueSold",Report.direction=!1,Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("HighestOrderDays",[function(){var title=_tr("Highest Order Days"),Report={},data=[],titles=[],dateRange=moment().subtract("month",1),itemsToShow=10;return Report.setData=function(reportsData){var tempData={},grouped=_.groupBy(reportsData.orders,"day");angular.forEach(grouped,function(day,key){key>dateRange.valueOf()&&angular.forEach(day,function(order){void 0===tempData[key]?tempData[key]={day:order.created,date:order.created,numberOfOrders:1}:tempData[key].numberOfOrders++})}),data=_.sortBy(tempData,function(row){return-row.numberOfOrders}).slice(0,itemsToShow)},Report.orderBy="numberOfOrders",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("LowestOrderDays",[function(){var title=_tr("Lowest Order Days"),Report={},data=[],titles=[],dateRange=moment().subtract("month",1),itemsToShow=10;return Report.setData=function(reportsData){var tempData={},grouped=_.groupBy(reportsData.orders,"day");angular.forEach(grouped,function(day,key){key>dateRange.valueOf()&&angular.forEach(day,function(order){void 0===tempData[key]?tempData[key]={day:order.created,date:order.created,numberOfOrders:1}:tempData[key].numberOfOrders++})}),data=_.sortBy(tempData,function(row){return row.numberOfOrders}).slice(0,itemsToShow)},Report.orderBy="numberOfOrders",Report.direction=!1,Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("HighestGrossingHours",[function(){var title=_tr("Highest Grossing Hours"),Report={},data=[],titles=[],itemsToShow=10;return Report.setData=function(reportsData){var tempData={},grouped=_.groupBy(reportsData.orders,"hour");console.log("grouped",grouped),angular.forEach(grouped,function(day,key){angular.forEach(day,function(order){void 0===tempData[key]?tempData[key]={timeSlot:moment(order.created).format("HH:00"),valueSold:order.total}:tempData[key].valueSold+=order.total})}),console.log("tempData",tempData),data=_.sortBy(tempData,function(row){return row.valueSold}).slice(0,itemsToShow)},Report.orderBy="valueSold",Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.reports").factory("HighestOrderHours",[function(){var title=_tr("Highest Order Hours"),Report={},data=[],titles=[],itemsToShow=10;return Report.setData=function(reportsData){var tempData={},grouped=_.groupBy(reportsData.orders,"hour");console.log("grouped",grouped),angular.forEach(grouped,function(day,key){angular.forEach(day,function(order){void 0===tempData[key]?tempData[key]={timeSlot:moment(order.created).format("HH:00"),numberOfOrders:1}:tempData[key].numberOfOrders++})}),console.log("tempData",tempData),data=_.sortBy(tempData,function(row){return-row.numberOfOrders}).slice(0,itemsToShow)},Report.orderBy="timeSlot",Report.direction=!1,Report.getData=function(){return data},Report.setTitles=function(newTitles){titles=newTitles},Report.getTitles=function(){return titles},Report.getTitle=function(){return title},Report}]),angular.module("kyc.filters",[]).filter("interpolate",["version",function(version){return function(text){return String(text).replace(/\%VERSION\%/gm,version)}}]).filter("orderObjectBy",function(){return function(items,field,reverse){var filtered=[];return angular.forEach(items,function(item){filtered.push(item)}),filtered.sort(function(a,b){return a[field]>b[field]?1:-1}),reverse&&filtered.reverse(),filtered}}).filter("marketing",function(){return function(marketing){return 1===marketing?_tr("Active"):" - "}}).filter("timeAgo",function(){return function(date){"object"!=typeof date&&(date=moment(date));var intervalType,seconds=Math.floor((moment()-date).valueOf()/1e3),interval=Math.floor(seconds/31536e3);return interval>=1?intervalType=_tr(interval>1?"years ago":"year ago"):(interval=Math.floor(seconds/2592e3),interval>=1?intervalType=_tr(interval>1?"months ago":"month ago"):(interval=Math.floor(seconds/86400),interval>=1?interval>1?intervalType=_tr("days ago"):(interval="",intervalType=_tr("yesterday")):(interval=Math.floor(seconds/3600),interval>=1?intervalType=_tr(interval>1?"hours ago":"hour ago"):(interval=Math.floor(seconds/60),interval>=1?intervalType=_tr(interval>1?"minutes ago":"minute ago"):(interval=seconds,intervalType=_tr(interval>1?"seconds ago":"second ago")))))),interval+" "+intervalType}});