"use strict";angular.module("features",[]),angular.module("kyc.controllers",[]),angular.module("kyc.resources",[]),angular.module("kyc.charts",[]),angular.module("kyc.services",[]),angular.module("kyc.directives",[]),angular.module("kyc.reports",[]),angular.module("kyc",["ngRoute","ngResource","ngSanitize","kyc.directives","kyc.resources","kyc.services","kyc.charts","kyc.controllers","kyc.resources","kyc.filters","kyc.reports","loaders","notification","mm.foundation"]).run(["$rootScope","ACCOUNT_ID","$http",function(a,b,c){a.requests=0,c.get("/api/accounts/"+b+"/features").then(function(a){var b=!1;a&&a.data&&angular.forEach(a.data,function(a){4!==a.featureId||"INSTALLED"!==a.status&&"TRIAL"!==a.status&&"UNINSTALLED"!==a.status||(b=!0)}),b||window.location.replace("/shop#/feature/4")})}]).config(["$routeProvider",function(a){a.when("/dashboard",{templateUrl:"/code/kyc/partials/dashboard.php",controller:"DashboardCtrl",resolve:{load:["$route","AllCharts","$AjaxInterceptor",function(a,b,c){return c.start(),b.promise}]}}),a.when("/stock",{templateUrl:"/code/kyc/partials/stock.php",controller:"StockCtrl",resolve:{load:["$route","OrderService","$AjaxInterceptor",function(a,b,c){return c.start(),b.load()}]}}),a.when("/customers",{templateUrl:"/code/kyc/partials/customers.php",controller:"CustomersCtrl",resolve:{load:["$route","OrderService","$AjaxInterceptor",function(a,b,c){return c.start(),b.load()}]}}),a.when("/reports",{templateUrl:"/code/kyc/partials/reports.php",controller:"ReportsCtrl",resolve:{load:["$route","AllReports","$AjaxInterceptor",function(a,b,c){return c.start(),b.init()}]}}),a.when("/stream",{templateUrl:"/code/kyc/partials/stream.php",controller:"StreamCtrl",resolve:{load:["$route","OrderService","$AjaxInterceptor",function(a,b,c){return c.start(),b.load()}]}}),a.otherwise({redirectTo:"/dashboard"})}]),angular.module("notification",["ngSanitize"]).controller("confirmModalController",["$scope","$modalInstance","data","deffered","$http","$templateCache","$compile","$sce","$timeout",function(a,b,c,d,e,f,g,h,i){var j="/code/notification/templates/";if(a.title=c.title||"",c.hasOwnProperty("templateFullUrl")&&c.templateFullUrl)angular.extend(a,c.scope);else if(c.hasOwnProperty("templateUrl")&&c.templateUrl){a.templateUrl=c.templateUrl;var k=function(b){var d=a.$new();angular.extend(d,c.scope),i(function(){angular.element("#contentPartial").html(g(b)(d))})},l=f.get(j+c.templateUrl);l?k(l):e.get(j+c.templateUrl).then(function(a){f.put(j+c.templateUrl,a.data),k(a.data)})}else a.content=c.content||"";c.hasOwnProperty("scope")&&c.scope&&(a=angular.extend(a,c.scope)),a.toTrusted=function(a){return h.trustAsHtml(a||"")},a.showTerm=c.showTerm||!1,a.acceptTerm=!1,a.btnOk=c.btnOk===!1?!1:c.btnOk||_tr("OK"),c.btnCancel===!1?c.btnCancel=!1:a.btnCancel=c.btnCancel||_tr("CANCEL"),a.changeTerm=function(b){a.acceptTerm=b},a.send=function(){b.close(),d.resolve({acceptTerm:a.acceptTerm})},a.cancel=function(){b.close(),d.reject({acceptTerm:a.acceptTerm})}}]).service("$notification",["$modal","$q","$sce",function(a,b){var c="/code/notification/templates/",d=function(d){var e=b.defer();d=d||{},d.hasOwnProperty("templateFullUrl")&&d.templateFullUrl&&(d.templateFullUrl=c+d.templateFullUrl);var f=a.open({templateUrl:d.templateFullUrl||"/code/notification/notification.htm",windowClass:"modal-preoday "+(d.windowClass||""),controller:"confirmModalController",resolve:{data:function(){return d},deffered:function(){return e}}});return f.opened.then(function(){setTimeout(function(){var a=0;$(".notificationButtons button").each(function(){a=a>$(this).width()?a:$(this).width()}).width(a),$(".modal-preoday").addClass("active")},400)}),e.promise};return{confirm:d}}]),angular.module("kyc.services",[]).service("$chartService",["ChartType","$filter","TickInterval",function(a,b,c){var d=function(a){return{options:{chart:{type:"areaspline",height:"250"},exporting:{enabled:!1},plotOptions:{line:{marker:{enabled:!1}},areaspline:{lineWidth:0,fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#523E8A"],[1,"#1AA1DB"]]},marker:{enabled:!1}}}},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",minTickInterval:864e5,labels:{enabled:!1}},yAxis:{gridLineWidth:0,minorGridLineWidth:0,title:{text:""},labels:{enabled:!1}},series:[{showInLegend:!1,enableMouseTracking:!1,name:"",data:a.data}]}},e=function(a){var d=a.data.length;return{options:{chart:{type:"areaspline",height:"250"},exporting:{enabled:!1},plotOptions:{line:{marker:{enabled:!1}},series:{marker:{fillColor:"#126FB2",lineColor:"#126FB2",lineWidth:2}},areaspline:{color:"#E7F1F7",lineColor:"#126FB2",lineWidth:3,marker:{fillColor:"#126FB2",enabled:d>1?!1:!0}}},tooltip:{borderWidth:0,backgroundColor:"transparent",shadow:!1,useHTML:!0,positioner:function(a,b,c){var d=a/2;return d-=this.chart.plotLeft,{x:c.plotX-d,y:c.plotY-b}},formatter:function(){var d;d=this.series.xAxis.tickInterval===c.MONTH?b("date")(new Date(this.x),"MMM yyyy"):this.series.xAxis.tickInterval===c.WEEK||this.series.xAxis.tickInterval===c.WEEK_THREE?moment.utc(this.x).startOf("week").format("DD MMM YYYY")+" <br /> - <br />"+moment.utc(this.x).endOf("week").format("DD MMM YYYY"):b("date")(new Date(this.x),"dd MMM yyyy");var e='<div style="position:relative;"><div style="background-color: #1576B7; border-radius: 5px; color:#fff;font-family:\'Co Text W01 Light\'; text-align:center; padding:18px 8px;">'+d,f=1==this.y&&"s"===a.tooltipText[a.tooltipText.length-1].toLowerCase()?a.tooltipText.slice(0,-1):a.tooltipText;return e+="<b style=\"color:#fff;font-size:160%;font-weight:bold;font-family:'Co Text W01 Bold';text-align:center;display:block;margin-top:8px;\">",e+=a.currency?f+""+this.y.toFixed(2)+"</b></div>":this.y+""+f+"</b></div>",e+='<span style="position: absolute; left: 42%; bottom: -8px; background:url(/img/arrowBlue.png) left top no-repeat; width: 15px; height: 8px; display: block;" "></span></div>'}}},credits:{enabled:!1},title:{text:""},xAxis:{type:"datetime",tickInterval:a.tickInterval,min:a.minTimestamp,max:a.maxTimestamp,labels:{style:{color:"#b3b6b8",fontSize:"15px"},formatter:function(){var a;return a=this.axis.tickInterval===c.MONTH?b("date")(new Date(moment.utc(this.value).startOf("month").add("days",10)),"MMM"):this.axis.tickInterval===c.WEEK||this.axis.tickInterval===c.WEEK_THREE?b("date")(new Date(moment.utc(this.value).startOf("week").add("days",3)),"dd.MMM"):b("date")(new Date(this.value),"dd.MMM")}}},yAxis:{gridLineWidth:0,minorGridLineWidth:0,title:{text:""},labels:{style:{color:"#b3b6b8",fontSize:"15px"}},min:0,minRange:1},series:[{showInLegend:!1,name:"",data:a.data,marker:{symbol:"url(/img/marker.png)"}}]}},f=function(a){return{options:{chart:{type:"pie",height:"250",events:{load:function(){setTimeout(function(){$(".highcharts-legend-item rect").attr("rx","20").attr("ry","20").attr("width","16").attr("height","16").css({cursor:"pointer"})},100)}}},tooltip:{hideDelay:0,borderWidth:0,backgroundColor:"#DBDBD9",shadow:!1,useHTML:!0,positioner:function(a,b,c){return{x:c.plotX-a/2+10,y:c.plotY-b-5}},formatter:function(){return'<div style="position:relative;"><div class="tooltipPie" style="font-size: 14px; font-weight: 600; padding: 5px 7px">'+Highcharts.numberFormat(this.y,this.y%1===0?0:1)+'</div> <span style="position: absolute; left: 42%; bottom: -15px; background:url(/img/arrowPie.png) left top no-repeat; width: 15px; height: 9px; display: block;" "></span> </div>'}},exporting:{enabled:!1},plotOptions:{pie:{center:["20%","55%"],borderWidth:0}},legend:{width:50,enabled:!0,layout:"vertical",verticalAlign:"middle",align:"center",borderWidth:0,itemMarginTop:5,itemMarginBottom:5,itemStyle:{width:210,lineHeight:20,fontSize:13},useHTML:!1,labelFormatter:function(){var a="font-family:Co Text W01 Light;";return a+="color:#46545d;",'<div style="'+a+'">'+this.name+"</div>"}}},title:{text:""},yAxis:{title:{text:""}},series:[{data:a.data,size:"80%",innerSize:"65%",showInLegend:!0,dataLabels:{enabled:!1}}]}},g=function(a){return{options:{chart:{height:"250",type:"column"},exporting:{enabled:!1},plotOptions:{column:{borderRadius:5},series:{borderWidth:0,dataLabels:{enabled:!1,format:"{point.y:.1f}"}}},tooltip:{hideDelay:.1,crosshairs:!1,shared:!0,followPointer:!0,borderWidth:0,backgroundColor:"#DBDBD9",shadow:!1,useHTML:!0,positioner:function(a,b,c){return{x:c.plotX-a/2+10,y:c.plotY-b-5}},formatter:function(){return'<div class="tooltipPie" style="font-size: 14px; font-weight: 600; padding: 5px 7px">'+Highcharts.numberFormat(this.y,this.y%1===0?0:1)+"</div>"}}},title:{text:""},xAxis:{type:"category",lineWidth:0,tickWidth:0},yAxis:{gridLineWidth:0,minorGridLineWidth:0,title:{text:""},labels:{enabled:!1}},series:[{pointWidth:200,name:"Customers",showInLegend:!1,colorByPoint:!1,color:{linearGradient:{x1:1,y1:1,x2:0,y2:1},stops:[[0,"#523E8A"],[1,"#1AA1DB"]]},data:a.data}]}},h=function(b,c){switch(b){case a.AREA:return d(c);case a.AREA_MODAL:return e(c);case a.PIE:return f(c);case a.COLUMN:return g(c)}};return{area:d,areaModal:e,pie:f,column:g,getChart:h}}]),angular.module("kyc.services").service("$grid",["ChartType",function(a){var b=function(b){var c=[],d=1,e=8,f=1,g=1,h=window.sessionStorage.getItem("widgets");return h&&(h=angular.fromJson(h)),angular.forEach(b,function(b){var i={};i.display=!0,i.title=b.title,i.num=d,b.type===a.NUMBER?(i.showChart=!1,i.size_x=2,i.size_y=1,i.value=b.data,i.currency=b.currency):(i.showChart=!0,i.size_x=4,i.size_y=2,i.value=b,i.currency=b.currency),h&&(i.order=h[d].order,i.display=h[d].display),i.row=g,i.col=f,f+i.size_x>e?(f=1,++g):f+=i.size_x,++d,c.push(i)}),h&&c.sort(function(a,b){return a.order<b.order?-1:a.order>b.order?1:0}),c};return{populateItems:b}}]),angular.module("loaders",[]).service("$AjaxInterceptor",["$rootScope","$timeout",function(a,b){function c(){var a=document.getElementsByClassName(".loading-content");if(a.length>0){(new Spinner).spin(a[0])}}return{start:function(){++a.requests,c()},complete:function(){b(function(){a.requests>0&&--a.requests},100)},isRequesting:function(){return a.requests>0}}}]),angular.module("kyc.services").service("OutletService",["ACCOUNT_ID","Outlet",function(a,b){var c=[];this.init=function(d){c=b.query({accountId:a},function(a){d(a)})},this.getOutlets=function(){return c},this.getOutletName=function(a){var b=!1;return angular.forEach(c,function(c){c.id==a&&(b=c.name)}),b}}]),angular.module("kyc.services").factory("pusher",["PUSHER_KEY",function(a){Pusher.log=function(a){window.console&&window.console.log&&window.console.log(a)};var b,c;return{bind:function(a,d,e){d.length>0?angular.forEach(d,function(a){c=b.subscribe("preoday.order.outlet."+a),c.bind("update",e)}):(c=b.subscribe("preoday.order.venue."+a),c.bind("update",e))},reset:function(){if(b){var c=b.allChannels();angular.forEach(c,function(a){a.unbind(),b.unsubscribe(a.name)})}else b=new Pusher(a)},bindConnection:function(a,c){b.connection.bind(a,c)}}}]),angular.module("kyc.services").service("OrderService",["ACCOUNT_ID","Order","INITIAL_DATES",function(a,b){function c(){return f}function d(a){return void 0===a||a.valueOf()>moment.utc().subtract("year",2).valueOf()?moment.utc().subtract("year",2).valueOf():a.startOf("day").valueOf()}function e(c,e){return c=d(c),e=moment.utc().valueOf(),b.query({accountId:a,maxPaid:e,minPaid:c},function(a){f=a}).$promise}var f;return{load:e,getOrders:c}}]),angular.module("kyc.services").service("VenueService",["ACCOUNT_ID","Venue","$q",function(a,b,c){function d(){{var d=c.defer();new b.query({accountId:a},function(a){a&&a.length>0&&(f=a[0]),d.resolve(f)})}return d.promise}function e(){return f?g[f.ccy]:g.GBP}var f,g={GBP:{symbol:"%C2%A3",name:"Pound Sterling",symbol_native:"£",decimal_digits:2,rounding:0,code:"GBP",name_plural:"British pounds sterling"},EUR:{symbol:"%E2%82%AC",name:"Euro",symbol_native:"€",decimal_digits:2,rounding:0,code:"EUR",name_plural:"euros"},USD:{symbol:"$",name:"US Dollar",symbol_native:"$",decimal_digits:2,rounding:0,code:"USD",name_plural:"US dollars"}};return{getCurrency:e,init:d}}]),angular.module("kyc.services").service("UtilsService",[function(){var c=function(a,b,c){var d=0,e={},f=Object.keys(a);f.length<c&&(c=f.length);for(var d=b;c>d;d++){var g=f[d];e[g]=a[g]}return e},d=function(a){for(var b=$(a).children().find(".flip-container"),c={},d=b.length-1;d>=0;d--){var e=$(b[d]),f=b.index(e),g=e.scope();c[g.value.num]={order:f,display:g.value.display},g.value.order=f}window.sessionStorage.setItem("widgets",angular.toJson(c))},e=function(c,d){var e=1;d&&(e=-1);var f=a[c]<b[c]?-1:a[c]>b[c]?1:0;return f*e},f=function(a,b,c){var d=1;c&&(d=-1);var e=[];return angular.forEach(a,function(a){e.push(a)}),e.sort(function(a,c){var e=a[b]<c[b]?-1:a[b]>c[b]?1:0;return e*d}),e};return{sliceObject:c,reOrderWidgets:d,dynamicSort:e,dynamicSortObject:f}}]),angular.module("kyc.controllers").controller("DashboardCtrl",["$scope","$http","$compile","ChartType","$grid","AllCharts","$AjaxInterceptor","$timeout","$notification","UtilsService",function(a,b,c,d,e,f,g,h,i,j){function k(){a.values=e.populateItems(l),h(function(){var a="1"===window.sessionStorage.getItem("firsttime_feature_4");a&&(window.sessionStorage.setItem("firsttime_feature_4",0),i.confirm({title:_tr("Welcome to Know Your Customer"),content:_tr("From here you can view detailed reports and analytics about your customers and the transactions they make."),showTerm:!1,btnOk:!1,btnCancel:_tr("GET STARTED"),windowClass:"medium"})),$(window).trigger("resize"),angular.element("#sscontainer").trigger("ss-rearrange"),g.complete()},1e3)}a.setLocation("dashboard"),a.$parent.showDateFilter=!0;var l=f.getPreparedCharts();a.$on("KYC_RELOAD",function(){l=f.getPreparedCharts(),a.values=e.populateItems(l),k()}),a.changeVisibility=function(a){a.display?(angular.element("#removable_"+a.num).closest(".flip-container").parent().show(),j.reOrderWidgets(angular.element("#sscontainer"))):setTimeout(function(){angular.element("#removable_"+a.num).triggerHandler("click")},0),angular.element("#sscontainer").trigger("ss-rearrange")},a.shapeshifterConfig={gutterX:20,gutterY:20,paddingX:0,paddingY:0,minColumns:2},k()}]),angular.module("kyc.controllers").controller("CustomersCtrl",["$scope","OrderService","$AjaxInterceptor","Export","ACCOUNT_ID","UtilsService",function(a,b,c,d,e,f){function g(){var b=[[a.getExportDate()],[j]];return angular.forEach(a.customers,function(c){("1"===a.exportAll||c.selected===!0)&&b.push([c.name,c.totalSpent,c.emailAddress])}),{data:b}}function h(){var b={Name:[],"Total Spent":[],"Email Address":[],Marketing:[]};return angular.forEach(a.customers,function(c){("1"===a.exportAll||c.selected===!0)&&(b.Name.push(c.name),b["Total Spent"].push(c.totalSpent),b["Email Address"].push(c.emailAddress),b.Marketing.push(c.marketing))}),{title:"Customers",startDate:a.form.start_date.valueOf(),endDate:a.form.end_date.valueOf(),dataJson:JSON.stringify(b)}}function i(){if(a.customers={},k){var b=moment.utc(a.$parent.form.start_date),d=moment.utc(a.$parent.form.end_date);angular.forEach(k,function(c){var e=moment.utc(c.paid);if((0===a.$parent.getSelectedOutlets().length||a.$parent.findOutlet(c.outletId).length>=1)&&e>=b&&d>=e){var f=c.userId;void 0===a.customers[f]?a.customers[f]={name:c.user.firstName+" "+c.user.lastName,totalSpent:Number(c.total.toFixed(2)),emailAddress:c.user.username,marketing:c.user.optinLoyalty||c.user.optinOffers||c.user.optinOther?_tr("Accepts"):" - "}:a.customers[f].totalSpent=Number((a.customers[f].totalSpent+c.total).toFixed(2))}})}a.customers=f.dynamicSortObject(a.customers,a.orderBy,a.direction),a.customersList=a.customers,a.totalItems=Object.keys(a.customers).length,a.numPerPage=20,a.currentPage=1,a.setOrderBy("totalSpent",!0),c.complete()}a.setLocation("customers"),a.$parent.showDateFilter=!0;var j=_tr("Customers"),k=b.getOrders();a.exportAll="1",a.$on("KYC_RELOAD",function(){k=b.getOrders(),i()}),a.selectAll=function(){angular.forEach(a.customers,function(b){b.selected=a.all_options})},a.exportPdf=function(){a.pdfData=h()},a.exportCsv=function(){a.csvData=g()},a.setOrderBy=function(b,c){void 0!==c&&(a.direction=c),a.customers=f.dynamicSortObject(a.customers,b,a.direction),l()};var l=function(){var b=(a.currentPage-1)*a.numPerPage,c=b+a.numPerPage;a.customersList=a.customers.slice(b,c)};i(),a.$watch("currentPage + numPerPage",function(){l()}),a.showOptions=function(){angular.element(".flip-container").addClass("active"),setTimeout(function(){$(".invisibleBack").addClass("visible")},200)},a.hideOptions=function(){angular.element(".flip-container").removeClass("active"),setTimeout(function(){$(".invisibleBack").removeClass("visible")},200)}}]),angular.module("kyc.controllers").controller("ReportsCtrl",["$scope","$AjaxInterceptor","OrderService","Export","ACCOUNT_ID","AllReports","UtilsService","$filter",function(a,b,c,d,e,f,g,h){function i(){a.reports=f.getReportsList(),a.selectReport(a.reports[0]),a.selectedReport&&a.selectedReport.data?(a.reportsList=a.selectedReport.data,a.totalItems=Object.keys(a.selectedReport.data).length):(a.reportsList=[],a.totalItems=0),a.selectedReport.data=g.dynamicSortObject(a.selectedReport.data,a.orderBy,a.direction),a.numPerPage=20,a.currentPage=1,console.log(a.selectedReport),b.complete()}function j(){var b={};return angular.forEach(a.selectedReport.data,function(c){("1"===a.exportAll||c.$selected===!0)&&angular.forEach(c,function(c,d){if("$"!==d[0]){var e=a.getTitle(d);void 0===b[e]&&(b[e]=[]),b[e].push(l(c,d))}})}),console.log("returning:",{title:a.selectedReport.title,startDate:a.form.start_date.valueOf(),endDate:a.form.end_date.valueOf(),dataJson:angular.toJson(b)}),{title:a.selectedReport.title,startDate:a.$parent.form.start_date.valueOf(),endDate:a.$parent.form.end_date.valueOf(),dataJson:angular.toJson(b)}}function k(){var b=[[a.getExportDate()],[a.selectedReport.title],a.selectedReport.titles];return angular.forEach(a.selectedReport.data,function(c){if("1"===a.exportAll||c.$selected===!0){var d=[];angular.forEach(c,function(a,b){"$"!==b[0]&&d.push(l(a,b))}),b.push(d)}}),{data:b}}function l(a,b){switch(b){case"day":case"lastOrder":case"dateJoined":case"dateOfOrder":case"date":return h("date")(a,"dd/MM/yyyy");case"valueSold":case"totalSpent":return a.toFixed(2);default:return a}}_tr("Reports");a.setLocation("reports"),a.exportAll="1",a.direction=!0,a.selectAll=function(){for(var b=a.selectReport.data.length;b--;)a.selectReport.data[b].$selected=a.all_options},a.$watch("currentPage + numPerPage",function(){m()});var m=function(){var b=(a.currentPage-1)*a.numPerPage,c=b+a.numPerPage;a.selectedReport&&a.selectedReport.data&&(a.reportsList=a.selectedReport.data.slice(b,c))};a.setOrderBy=function(b,c){a.direction=void 0!==c?c:!a.direction,console.log("set order by",b,a.direction),a.orderBy=b,a.selectedReport.data=g.dynamicSortObject(a.selectedReport.data,b,a.direction),m()},a.selectReport=function(b){if(b)var c=b;else{var c=a.reports.filter(function(a){return a.selected===!0});c.length&&(c=c[0])}a.selectedReport={data:c.getData(),title:c.getTitle(),titles:c.getTitles(),description:c.description},a.totalItems=Object.keys(a.selectedReport.data).length,a.reportsList=g.sliceObject(a.selectedReport.data,0,a.numPerPage),a.currentPage=1,a.setOrderBy(c.orderBy||a.selectedReport.titles[0]),a.direction=void 0!==c.direction?c.direction:a.direction},a.getTitle=function(a){return f.getTitle(a)},a.exportPdf=function(){a.pdfData=j()},a.exportCsv=function(){a.csvData=k()},a.showOptions=function(){angular.element(".flip-container").addClass("active"),setTimeout(function(){$(".invisibleBack").addClass("visible")},200)},a.hideOptions=function(){angular.element(".flip-container").removeClass("active"),setTimeout(function(){$(".invisibleBack").removeClass("visible")},200)},i()}]),angular.module("kyc.controllers").controller("StockCtrl",["$scope","$AjaxInterceptor","OrderService","Export","ACCOUNT_ID","UtilsService",function(a,b,c,d,e,f){function g(){var b=[[a.getExportDate()],[j]];return angular.forEach(a.stock,function(c){("1"===a.exportAll||c.selected===!0)&&b.push([c.name,c.quantity])}),{data:b}}function h(){var b={Item:[],"Quantity Ordered":[]};return angular.forEach(a.stock,function(c){("1"===a.exportAll||c.selected===!0)&&(b.Item.push(c.name),b["Quantity Ordered"].push(c.quantity))}),{title:"Stock",startDate:a.form.start_date.valueOf(),endDate:a.form.end_date.valueOf(),dataJson:JSON.stringify(b)}}function i(){if(a.stock={},k){var c=a.$parent.form.start_date,d=a.$parent.form.end_date;angular.forEach(k,function(b){var e=moment.utc(b.paid);(0===a.$parent.getSelectedOutlets().length||a.$parent.findOutlet(b.outletId).length>=1)&&e>=c&&d>=e&&angular.forEach(b.items,function(b){var c=b.menuItemId;void 0===a.stock[c]?a.stock[c]={name:b.name,quantity:b.qty}:a.stock[c].quantity+=b.qty})})}a.stock=f.dynamicSortObject(a.stock,a.orderBy,a.direction),a.stocks=a.stock,a.totalItems=Object.keys(a.stock).length,a.currentPage=1,a.setOrderBy("quantity",!0),b.complete()}var j=_tr("Stock");a.setLocation("stock"),a.$parent.showDateFilter=!0,a.exportAll="1",a.numPerPage=20,a.$on("KYC_RELOAD",function(){k=c.getOrders(),i()});var k=c.getOrders();a.selectAll=function(){angular.forEach(a.stock,function(b){b.selected=a.all_options})},a.exportPdf=function(){a.pdfData=h()},a.exportCsv=function(){a.csvData=g()},a.setOrderBy=function(b,c){void 0!==c&&(a.direction=c),a.stock=f.dynamicSortObject(a.stock,b,a.direction),l()};var l=function(){var b=(a.currentPage-1)*a.numPerPage,c=b+a.numPerPage;a.stocks=a.stock.slice(b,c)};a.$watch("currentPage + numPerPage",function(){l()}),i(),a.setPage=function(b){a.currentPage=b},a.showOptions=function(){angular.element(".flip-container").addClass("active"),setTimeout(function(){$(".invisibleBack").addClass("visible")},200)},a.hideOptions=function(){angular.element(".flip-container").removeClass("active"),setTimeout(function(){$(".invisibleBack").removeClass("visible")},100)}}]),angular.module("kyc.controllers").controller("StreamCtrl",["$scope","OrderService","pusher","$AjaxInterceptor","$interval","VENUE_ID",function(a,b,c,d,e,f){a.$parent.showDateFilter=!1,a.setLocation("stream"),a.orders=b.getOrders();var g=!1,h=function(){g||(g=!0,b.load(function(b){a.orders=b}),setTimeout(function(){g=!1},500))};c.reset();var i=f,j=a.getSelectedOutlets(),k=[];angular.forEach(j,function(a){k.push(a.id)}),c.bind(i,k,h),a.getStatusName=function(a){var b={PAYMENT_FAILED:"FAILED",NOSHOW:"NO SHOW"};return b[a]?b[a]:a},a.getStatusColor=function(a){switch(a){case"PENDING":case"ACCEPTED":case"PREPARING":case"READY":case"DELIVERING":case"COMPLETED":return"good";case"NOSHOW":case"REJECTED":case"CANCELLED":case"PAYMENT_FAILED":default:return"bad"}},a.outletFilter=function(a){return k&&0===k.length||k.indexOf(a.outletId)>-1},a.showOptions=function(){angular.element(".flip-container").addClass("active")},a.hideOptions=function(){angular.element(".flip-container").removeClass("active")},a.activeStream=function(b){var c=a.orders.filter(function(a){return a.active===!0});c&&c[0]&&c[0].code!=b.code&&(c[0].active=!1),b.active=!b.active},a.getOrderItems=function(a){var b=[];return angular.forEach(a.items,function(a){b.push(a.qty+" x "+a.name)}),b},d.complete()}]),angular.module("kyc.controllers").controller("MenuCtrl",["$scope","OutletService","OrderService","AllCharts","$route","VenueService","$AjaxInterceptor","$location","INITIAL_DATES",function(a,b,c,d,e,f,g,h,i){a.currencySymbol="%C2%A3",a.outlets=[],a.form={start_date:moment.utc(i.start).startOf("day"),end_date:moment.utc(i.end).endOf("day")},a.getCurrency=function(){return decodeURI(a.currencySymbol)},f.init().then(function(c){a.venue=c,a.currencySymbol=f.getCurrency().symbol,b.init(function(){a.outlets=b.getOutlets(),d.init(a.form.start_date,a.form.end_date,a.currencySymbol)})}),a.update=function(){g.start(),setTimeout(function(){d.reloadCharts(a.form.start_date,a.form.end_date,a.currencySymbol,a.getSelectedOutlets()).then(function(){a.$broadcast("KYC_RELOAD")})},500)},a.setLocation=function(b){a.currentLocation=b,h.path()!=="/"+b&&h.path(b)},a.getSelectedOutlets=function(){return a.outlets.filter(function(a){return a.selected===!0})},a.findOutlet=function(b){return a.outlets.filter(function(a){return a.selected===!0&&a.id===b})},a.getExportDate=function(){return a.form.start_date.format("DD-MMM-YYYY")+" - "+a.form.end_date.format("DD-MMM-YYYY")}}]),angular.module("kyc.resources").factory("Export",["$resource",function(a){var b=a("/api/accounts/:accountId/exports/pdf",{accountId:"@accountId"},{table:{method:"POST",url:"/api/accounts/:accountId/exports/pdf/table"},chart:{method:"POST",url:"/api/accounts/:accountId/exports/pdf/table"}}),c=a("/api/accounts/:accountId/exports/csv",{accountId:"@accountId"},{}),d=a("/api/accounts/:accountId/exports/table/pdf",{accountId:"@accountId"},{});return{Pdf:b,Csv:c,TablePdf:d}}]),angular.module("kyc.resources").factory("Outlet",["$resource",function(a){var b=a("/api/outlets",{},{});return b}]),angular.module("kyc.resources").factory("Order",["$resource",function(a){var b=a("/api/orders",{},{});return b}]),angular.module("kyc.resources").factory("Venue",["$resource",function(a){var b=a("/api/venues/:id",{},{query:{method:"GET",isArray:!0}});return b}]),angular.module("kyc.resources").factory("VenueCustomers",["$resource",function(a){var b=a("/api/venues/:id/customers",{id:"@id"},{});return b}]),angular.module("kyc.resources").factory("Report",["$resource",function(a){var b=a("/api/reports/:venueId",{venueId:"@venueId"},{items:{method:"GET",isArray:!0,url:"/api/reports/:venueId/items"},orders:{method:"GET",isArray:!0,url:"/api/reports/:venueId/orders"},customerOrders:{method:"GET",isArray:!0,url:"/api/reports/:venueId/customerOrders"}});return b}]),angular.module("kyc").constant("ChartType",{NUMBER:"NUMBER",COLUMN:"COLUMN",PIE:"PIE",AREA:"AREA",AREA_MODAL:"AREA_MODAL"}),angular.module("kyc").constant("Colors",["#18a4dd","#1576b7","#543b87","#392654","#f5b23e","#8bbf4f","#c0392b","#46545d","#b4b6b8","#dcdddf"]),angular.module("kyc").constant("TickInterval",{DAY:864e5,WEEK:6048e5,WEEK_THREE:18144e5,MONTH:2592e6}),angular.module("kyc.directives").directive("chart",["$modal","ChartType","$chartService","Export","ACCOUNT_ID","UtilsService","ChartHelper",function(a,b,c,d,e,f,g){return{templateUrl:"/code/kyc/js/directives/chart/chart.php",restrict:"E",replace:!0,scope:{chart:"=element"},link:function(d,h){function i(){if(d.chart.showChart)switch(d.chart.value.type){case b.PIE:case b.COLUMN:if(0===d.chart.value.data.length)d.noData=!0;else{var a=!0;angular.forEach(d.chart.value.data,function(b){b.y>0&&(a=!1)}),d.noData=a}break;case b.AREA:d.chart.value.data.length<1&&(d.noData=!0)}else(0===d.chart.value||"NaN"===d.chart.value||0/0==d.chart.value)&&(d.noData=!0)}function j(){if(d.chart.value.modal){var b=Math.max(document.documentElement.clientWidth,window.innerWidth||0),f=b>1300?"large":"xlarge",h=a.open({templateUrl:modal_url("chart"),windowClass:f+" modal-preoday modal-chart",controller:["$scope",function(a){if(a.optionHasData=function(a){return a.data.length>1?1:0},a.noData=!1,a.ACCOUNT_ID=e,a.chart=angular.copy(d.chart),d.chart.value.modal.highcharts){var b=d.chart.value.modal.options[0];d.chart.value.tickInterval=b.tickInterval,d.chart.value.minTimestamp=moment.utc(b.minTimestamp).valueOf(),d.chart.value.maxTimestamp=moment.utc(b.maxTimestamp).valueOf();var f=angular.copy(d.chart.value);f.data=b.data,a.selectedData=f,a.chart.highcharts=c.getChart(d.chart.value.modal.highcharts.type,f)}a.exportPdf=function(){var b=d.chart.value.getPdf();b.startDate=a.selectedData.minTimestamp,b.endDate=a.selectedData.maxTimestamp,b.dataJson=JSON.stringify(a.selectedData.data),a.pdfData=b},a.exportCsv=function(){var b=a.selectedData.data,c=[[moment.utc(a.selectedData.minTimestamp).format("DD-MMM-YYYY")+" - "+moment.utc(a.selectedData.maxTimestamp).format("DD-MMM-YYYY")],["Revenue"]];angular.forEach(b,function(a){c.push([g.formatDate(a[0]),a[1]])}),a.csvData={data:c}},a.showOptions=function(){$(".modal-chart .flip-container").addClass("active"),setTimeout(function(){$(".modal-chart .invisibleBack").addClass("visible")},200)},a.hideOptions=function(){$(".modal-chart .flip-container").removeClass("active"),setTimeout(function(){$(".modal-chart .invisibleBack").removeClass("visible")},200)},a.cancel=function(){h.close()},a.title=d.chart.title,a.selectOption=function(b){a.noData=!1;var e=a.chart.value.modal.options.filter(function(a){return 1==a.active});e&&(e[0].active=!1),b.active=!0,a.selectedData=angular.copy(b),a.selectedData.minTimestamp=moment.utc(b.minTimestamp).valueOf(),a.selectedData.maxTimestamp=moment.utc(b.maxTimestamp).valueOf(),a.chart.highcharts=c.getChart(d.chart.value.modal.highcharts.type,{tooltipText:d.chart.value.tooltipText,data:b.data,tickInterval:b.tickInterval,minTimestamp:moment.utc(b.minTimestamp).valueOf(),maxTimestamp:moment.utc(b.maxTimestamp).valueOf()})},a.setNoData=function(b){a.noData=!0;var c=a.chart.value.modal.options.filter(function(a){return 1==a.active});c&&(c[0].active=!1),b.active=!0}}]});h.opened.then(function(){setTimeout(function(){$(".modal-preoday").addClass("active")},1)})}}function k(){var a=c.getChart(d.chart.value.type,d.chart.value);d.chart.value.items&&(a.options.chart.height=205,h.parent().addClass("highchartsItem")),d.chart.value.type===b.AREA&&(a.options.chart.events={click:j}),d.chart.highcharts=a}d.chart.display||h.parent().hide(),d.ACCOUNT_ID=e,d.noData=!1,i(),d.ChartType=b;var l=(h.find(".actions-chart"),h.find(".chart"),h.closest(".flip-container"));k(),d.showOptions=function(){l.addClass("active"),setTimeout(function(){h.find(".invisibleBack").addClass("visible")},200)},d.hideOptions=function(){l.removeClass("active"),setTimeout(function(){h.find(".invisibleBack").removeClass("visible")},100)},d.removeGrid=function(a){a.display=!1,h.parent().hide(),f.reOrderWidgets(h.closest(".sscontainer"))},d.changeItem=function(){var a=d.chart.value.items.filter(function(a){return a.selected===!0});a.length&&(d.selectedItem=a[0],d.selectedItem.callback(d.selectedItem.menuItemId,function(a){d.chart.value=a,k()}))},d.exportPdf=function(){d.pdfData=d.chart.value.getPdf()},d.exportCsv=function(){d.csvData=d.chart.value.getCsv()},d.getText=function(a){if("object"==typeof a.value)var b=a.value.numberLeft;else var b=a.value.toLocaleString();return a.currency?decodeURI(a.currency)+b:b}}}}]),angular.module("kyc.directives").factory("highchartsNGUtils",function(){return{indexOf:function(a,b,c){void 0===c&&(c=0),0>c&&(c+=a.length),0>c&&(c=0);for(var d=a.length;d>c;c++)if(c in a&&a[c]===b)return c;return-1},prependMethod:function(a,b,c){var d=a[b];a[b]=function(){var a=Array.prototype.slice.call(arguments);return c.apply(this,a),d?d.apply(this,a):void 0}},deepExtend:function a(b,c){if(angular.isArray(c)){b=angular.isArray(b)?b:[];for(var d=0;d<c.length;d++)b[d]=a(b[d]||{},c[d])}else if(angular.isObject(c))for(var e in c)b[e]=a(b[e]||{},c[e]);else b=c;return b}}}).directive("highchart",["highchartsNGUtils",function(a){var b=0,c=function(a){var c=!1;return angular.forEach(a,function(a){angular.isDefined(a.id)||(a.id="series-"+b++,c=!0)}),c},d=["xAxis","yAxis"],e=function(b,c,e){var f={},g={chart:{events:{}},title:{},subtitle:{},series:[],credits:{},plotOptions:{},navigator:{enabled:!1}};return f=e.options?a.deepExtend(g,e.options):g,f.chart.renderTo=c[0],angular.forEach(d,function(c){angular.isDefined(e[c])&&(f[c]=angular.copy(e[c]),(angular.isDefined(e[c].currentMin)||angular.isDefined(e[c].currentMax))&&(a.prependMethod(f.chart.events,"selection",function(a){var d=this;b.$apply(a[c]?function(){b.config[c].currentMin=a[c][0].min,b.config[c].currentMax=a[c][0].max}:function(){b.config[c].currentMin=d[c][0].dataMin,b.config[c].currentMax=d[c][0].dataMax})}),a.prependMethod(f.chart.events,"addSeries",function(){b.config[c].currentMin=this[c][0].min||b.config[c].currentMin,b.config[c].currentMax=this[c][0].max||b.config[c].currentMax})))}),e.title&&(f.title=e.title),e.subtitle&&(f.subtitle=e.subtitle),e.credits&&(f.credits=e.credits),e.size&&(e.size.width&&(f.chart.width=e.size.width),e.size.height&&(f.chart.height=e.size.height)),f
},f=function(a,b){var c=a.getExtremes();(b.currentMin!==c.dataMin||b.currentMax!==c.dataMax)&&a.setExtremes(b.currentMin,b.currentMax,!1)},g=function(a,b,c){(b.currentMin||b.currentMax)&&a[c][0].setExtremes(b.currentMin,b.currentMax,!0)},h=function(a){return angular.extend({},a,{data:null,visible:null})};return{restrict:"EAC",replace:!0,template:"<div></div>",scope:{config:"="},link:function(b,i){var j={},k=function(d){var e,f=[];if(d){var g=c(d);if(g)return!1;if(angular.forEach(d,function(a){f.push(a.id);var b=l.get(a.id);b?angular.equals(j[a.id],h(a))?(void 0!==a.visible&&b.visible!==a.visible&&b.setVisible(a.visible,!1),b.setData(angular.copy(a.data),!1)):b.update(angular.copy(a),!1):l.addSeries(angular.copy(a),!1),j[a.id]=h(a)}),b.config.noData){var i=!1;for(e=0;e<d.length;e++)if(d[e].data&&d[e].data.length>0){i=!0;break}i?l.hideLoading():l.showLoading(b.config.noData)}}for(e=l.series.length-1;e>=0;e--){var k=l.series[e];a.indexOf(f,k.options.id)<0&&k.remove(!1)}return!0},l=!1,m=function(){l&&l.destroy(),j={};var a=b.config||{},c=e(b,i,a);l=a.useHighStocks?new Highcharts.StockChart(c):new Highcharts.Chart(c);for(var f=0;f<d.length;f++)a[d[f]]&&g(l,a[d[f]],d[f]);a.loading&&l.showLoading()};m(),b.$watch("config.series",function(a){var b=k(a);b&&l.redraw()},!0),b.$watch("config.title",function(a){l.setTitle(a,!0)},!0),b.$watch("config.subtitle",function(a){l.setTitle(!0,a)},!0),b.$watch("config.loading",function(a){a?l.showLoading():l.hideLoading()}),b.$watch("config.credits.enabled",function(a){a?l.credits.show():l.credits&&l.credits.hide()}),b.$watch("config.useHighStocks",function(a,b){a!==b&&m()}),angular.forEach(d,function(a){b.$watch("config."+a,function(b,c){b!==c&&b&&(l[a][0].update(b,!1),f(l[a][0],angular.copy(b)),l.redraw())},!0)}),b.$watch("config.options",function(a,b,c){a!==b&&(m(),k(c.config.series),l.redraw())},!0),b.$watch("config.size",function(a,b){a!==b&&a&&l.setSize(a.width||void 0,a.height||void 0)},!0),b.$on("highchartsng.reflow",function(){l.reflow()}),b.$on("$destroy",function(){l&&l.destroy(),i.remove()})}}}]),angular.module("kyc.directives").directive("datepicker",["$parse","$filter",function(){return{restrict:"A",require:"ngModel",scope:{compareStart:"=start",compareEnd:"=end"},link:function(a,b,c,d){b.fdatepicker({format:"dd/mm/yyyy",onRender:function(b){if(a.compareStart){var c=b.valueOf()<a.compareStart.valueOf()||b.valueOf()>=moment.utc().endOf("day").valueOf();return c?"disabled":""}if(a.compareEnd){var d=b.valueOf()>moment.utc(a.compareEnd).endOf("day").valueOf();return d?"disabled":""}}}).on("changeDate",function(c){a.$apply(function(){d.$setViewValue(c.date),b.fdatepicker("setDate",c.date)})}),d.$parsers.push(function(a){var b;if("string"==typeof a){var d=a.split("/");b=moment.utc([d[2],+d[1]-1,+d[0]])}else b=moment.utc(a);return void 0!==c.start?b.endOf("day"):b.startOf("day")}),d.$formatters.push(function(a){return a.format("DD/MM/YYYY")})}}}]),angular.module("kyc.directives").directive("multiSelect",["$sce","$filter",function(a){return{restrict:"AE",replace:!0,scope:{inputModel:"=",outputModel:"=",buttonLabel:"@",selectionMode:"@",itemLabel:"@",tickProperty:"@",disableProperty:"@",orientation:"@",defaultLabel:"@",maxLabels:"@",isDisabled:"=",directiveId:"@",helperElements:"@",onOpen:"&",onClose:"&",onBlur:"&",onFocus:"&",onChange:"&"},templateUrl:directive_url("multiselect/multiselect.htm"),link:function(b,c,d){b.selectedItems=[],b.backUp=[],b.varButtonLabel="",b.currentButton=null,b.scrolled=!1,b.displayHelper=function(a){if("undefined"==typeof d.helperElements)return!0;switch(a.toUpperCase()){case"ALL":if(d.selectionMode&&"SINGLE"===b.selectionMode.toUpperCase())return!1;if(d.helperElements&&b.helperElements.toUpperCase().indexOf("ALL")>=0)return!0;break;case"NONE":if(d.selectionMode&&"SINGLE"===b.selectionMode.toUpperCase())return!1;if(d.helperElements&&b.helperElements.toUpperCase().indexOf("NONE")>=0)return!0;break;case"RESET":if(d.helperElements&&b.helperElements.toUpperCase().indexOf("RESET")>=0)return!0;break;case"FILTER":if(d.helperElements&&b.helperElements.toUpperCase().indexOf("FILTER")>=0)return!0}},b.syncItems=function(a,c){var e=b.inputModel.indexOf(a);if(b.inputModel[e][b.tickProperty]=!b.inputModel[e][b.tickProperty],d.selectionMode&&"SINGLE"===b.selectionMode.toUpperCase()){b.inputModel[e][b.tickProperty]=!0;for(var f=0;f<b.inputModel.length;f++)f!==e&&(b.inputModel[f][b.tickProperty]=!1);b.toggleCheckboxes(c)}b.refreshSelectedItems(),b.onChange()},b.refreshSelectedItems=function(){b.varButtonLabel="",b.selectedItems=[];var a=0;if(angular.forEach(b.inputModel,function(a){"undefined"!=typeof a&&(a[b.tickProperty]===!0||"true"===a[b.tickProperty])&&b.selectedItems.push(a)}),"undefined"!=typeof d.outputModel&&(b.outputModel=angular.copy(b.selectedItems)),0===b.selectedItems.length)b.varButtonLabel=b.defaultLabel?b.defaultLabel:"None selected";else{var c=b.selectedItems.length;"undefined"!=typeof b.maxLabels&&""!==b.maxLabels&&(c=b.maxLabels),b.more=b.selectedItems.length>c?!0:!1,angular.forEach(b.selectedItems,function(d){"undefined"!=typeof d&&(c>a&&(b.varButtonLabel+=(b.varButtonLabel.length>0?", ":"")+b.writeLabel(d,"buttonLabel")),a++)}),b.more===!0&&(c>0&&(b.varButtonLabel+=", ... "),b.varButtonLabel+="(Total: "+b.selectedItems.length+")")}},b.itemIsDisabled=function(a){return a[b.disableProperty]===!0?!0:b.isDisabled===!0?!0:!1},b.writeLabel=function(c,d){var e="",f=b[d].split(" ");return angular.forEach(f,function(a){"undefined"!=typeof a&&angular.forEach(c,function(b,c){c==a&&(e+=" "+b)})}),a.trustAsHtml(e)},b.toggleCheckboxes=function(a){a.target&&("BUTTON"!==a.target.tagName.toUpperCase()&&a.target.className.indexOf("multiSelectButton")<0?d.selectionMode&&"SINGLE"===b.selectionMode.toUpperCase()?"INPUT"===a.target.tagName.toUpperCase()&&(a=b.findUpTag(a.target,"div","checkboxLayer"),a=a.previousSibling.previousSibling):a=b.findUpTag(a.target,"button","multiSelectButton"):a=a.target),b.labelFilter="";for(var c=-1,e=document.querySelectorAll(".checkboxLayer"),f=document.querySelectorAll(".multiSelectButton"),g=0;g<f.length;g++)if(a===f[g]){c=g;break}if(c>-1){for(var g=0;g<e.length;g++)g!=c&&(e[g].className="multiSelect checkboxLayer hide");"multiSelect checkboxLayer hide"==e[c].className?(b.currentButton=f[c],e[c].className="multiSelect checkboxLayer dropdown pdDropdown show",b.onOpen()):"multiSelect checkboxLayer dropdown pdDropdown show"==e[c].className&&(e[c].className="multiSelect checkboxLayer hide",b.onClose())}},b.findUpTag=function(a,b,c){for(;a.parentNode;)if(a=a.parentNode,"undefined"!=typeof a.tagName&&a.tagName.toUpperCase()===b.toUpperCase()&&a.className.indexOf(c)>-1)return a;return null},b.select=function(a){switch(a.toUpperCase()){case"ALL":angular.forEach(b.inputModel,function(a){"undefined"!=typeof a&&a[b.disableProperty]!==!0&&(a[b.tickProperty]=!0)});break;case"NONE":angular.forEach(b.inputModel,function(a){"undefined"!=typeof a&&a[b.disableProperty]!==!0&&(a[b.tickProperty]=!1)});break;case"RESET":b.inputModel=angular.copy(b.backUp)}b.refreshSelectedItems()};var e=function(){"inputModel"in d||console.log("Multi-select error: input-model is not defined! (ID: "+b.directiveId+")"),"buttonLabel"in d||console.log("Multi-select error: button-label is not defined! (ID: "+b.directiveId+")"),"itemLabel"in d||console.log("Multi-select error: item-label is not defined! (ID: "+b.directiveId+")"),"tickProperty"in d||console.log("Multi-select error: tick-property is not defined! (ID: "+b.directiveId+")")},f=function(a,b){var c=!1;angular.forEach(a,function(a){if("undefined"!=typeof a){var d=!0;angular.forEach(b,function(b){if("undefined"!=typeof b&&d&&!(a in b)){c=!0,d=!1}})}})};e(),b.refreshSelectedItems(),b.$watch("inputModel",function(){"undefined"!==b.newVal&&(f(b.itemLabel.split(" "),b.inputModel),f(new Array(b.tickProperty),b.inputModel)),b.refreshSelectedItems()},!0),b.$watch("inputModel",function(){"undefined"!==b.newVal&&(f(b.itemLabel.split(" "),b.inputModel),f(new Array(b.tickProperty),b.inputModel)),b.backUp=angular.copy(b.inputModel),b.refreshSelectedItems()}),b.$watch("isDisabled",function(a){b.isDisabled=a}),angular.element(document).bind("touchstart",function(){b.$apply(function(){b.scrolled=!1})}),angular.element(document).bind("touchmove",function(){b.$apply(function(){b.scrolled=!0})}),angular.element(document).bind("click touchend",function(a){if("click"===a.type||"touchend"===a.type&&b.scrolled===!1){var c=document.querySelectorAll(".checkboxLayer");if(void 0===a.target.className.indexOf||a.target.className.indexOf("multiSelect")){for(var d=0;d<c.length;d++)c[d].className="multiSelect checkboxLayer hide";a.stopPropagation()}}}),Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){b=b||0;for(var c=this.length;c>b;){if(this[b]===a)return b;++b}return-1})}}}]),angular.module("kyc.directives").directive("shapeshift",["UtilsService","$timeout",function(a,b){return{restrict:"A",link:function(c,d,e){b(function(){var b=$(d).shapeshift(c.$eval(e.shapeshift));b.on("ss-rearranged",function(){a.reOrderWidgets(d)})})}}}]),angular.module("kyc.charts").factory("AllCharts",["$q","OrderService","PayingCustomers","OrdersPerCustomer","AverageOrderValue","ItemsOrdered","OrdersByOutlet","MostPopularItems","TimeOfOrdersPlaced","CustomersPie","CustomersBar","Revenue","NumberOfOrders","MenuItemPopularity",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(a,c,d,e){t=d,b.load(a,c).then(function(b){r(b,a,c,e)})}function p(c,d,e,f){var g=a.defer();return t=e,b.load(c,d).then(function(a){r(a,c,d,f),g.resolve(v)}),g.promise}function q(a,b){var c=!1;return angular.forEach(a,function(a){c||a.id!=b||(c=a)}),c}function r(a,b,c,d){b=moment.utc(b),c=moment.utc(c),d||(d=[]),angular.forEach(v,function(a){a.clearData()}),angular.forEach(a,function(a){(0===d.length||q(d,a.outletId))&&angular.forEach(v,function(d){d.setData(a,b,c)})}),angular.forEach(v,function(a){a.onSetDataComplete&&a.onSetDataComplete(b,c,t)}),u.resolve(v)}function s(){var a=[];return angular.forEach(v,function(b){a.push(b.getHighChart?b.getHighChart():b)}),a}var t,u=a.defer(),v={payingCustomers:c,ordersPerCustomer:d,averageOrderValue:e,itemsOrdered:f,ordersByOutlet:g,mostPopularItems:h,timeOfOrdersPlaced:i,customersPie:j,customersBar:k,revenue:l,numberOfOrders:m,menuItemPopularity:n};return{init:o,promise:u.promise,getPreparedCharts:s,prepareCharts:r,reloadCharts:p}}]),angular.module("kyc.charts").factory("ChartHelper",["$filter","TickInterval",function(a,b){function c(b){var c=new Date(b);return a("date")(c,"dd-MMM-yyyy")}function d(a,b){var c=e(a),d=e(b),f=100*c/d;return 1/0===f?"":f.toFixed(2)}function e(a){var b=0;return angular.forEach(a,function(a){b+=a[1]}),b.toFixed(0)}function f(a,b,c,d){d=d?d:!1;var e=moment.utc(b-(c-b)),f=moment.utc().subtract("week",1),g=moment.utc().subtract("week",2),j=moment.utc().subtract("month",1),n=moment.utc().subtract("month",2),o=moment.utc().subtract("month",3),p=moment.utc().subtract("month",6),q=moment.utc().subtract("month",6),r=moment.utc().subtract("month",12),s=moment.utc().subtract("year",1),t=moment.utc().subtract("year",2),u=[],v=[],w=[],x=[],y=[],z=[],A=[],B=[],C=[],D=[],E=[],F=[],G=0,H=[],I=h({maxTimestamp:c,minTimestamp:b}),J=null;switch(I){case"day":J=m.day;break;case"week":J=m.week;break;case"month":J=m.month}return angular.forEach(a,function(a,d){var h=Number(d),i=[Number(d),Number(a.toFixed(2))];h>=b&&c>=h?(J(v,i),u.push(i),G+=a):b>h&&h>=e&&w.push(i),h>=f&&m.day(x,i),h>=g&&f>h&&y.push(i),h>=j&&m.day(z,i),h>=n&&j>h&&A.push(i),h>=o&&m.week(B,i),h>=p&&o>h&&C.push(i),h>=q&&m.week(D,i),h>=r&&q>h&&E.push(i),h>=s&&m.month(H,i),h>=t&&s>h&&F.push(i)}),u.sort(k),v.sort(k),x.sort(k),y.sort(k),z.sort(k),A.sort(k),B.sort(k),C.sort(k),D.sort(k),E.sort(k),H.sort(k),F.sort(k),d&&(G=G.toFixed(2)),{data:i({max:moment.utc(c).startOf("day"),min:moment.utc(b).startOf("day").valueOf(),value:v,dateType:h({maxTimestamp:c,minTimestamp:b}),filterData:function(a,b){switch(this.dateType){case"day":return l.day(a,b);case"week":return l.week(a,b);case"month":return l.month(a,b)}}}),dataModal:v,previousSpecifiedData:w,weekData:x,previousWeekData:y,monthData:z,previousMonthData:A,threeMonthsData:B,previousThreeMonthsData:C,sixMonthsData:D,previousSixMonthsData:E,yearData:H,previousYearData:F,total:G,minTimestamp:b,maxTimestamp:c}}function g(a){var c=moment.utc(a.maxTimestamp,"X").diff(moment.utc(a.minTimestamp,"X"),"days");switch(!0){case 32>c:return b.DAY;case 92>c:return b.WEEK;case 183>c:return b.WEEK_THREE;default:return b.MONTH}}function h(a){var b=moment.utc(a.maxTimestamp,"X").diff(moment.utc(a.minTimestamp,"X"),"days");switch(!0){case 32>b:return"day";case 183>b:return"week";default:return"month"}}function i(a){for(var b=a.max,c=a.min,d=angular.copy(a.value);;){var e=b.valueOf();if(c>e)break;var f=a.filterData(d,e);if(!f.length){var g=[e,0];d.push(g)}b=b.subtract(a.dateType,1)}return d.sort(k),d}function j(a){return[{name:_tr("Date Range"),value:e(a.data),percent:d(a.data,a.previousSpecifiedData),active:!0,data:i({max:moment.utc(a.maxTimestamp).startOf("day"),min:moment.utc(a.minTimestamp).startOf("day").valueOf(),value:a.dataModal,dateType:h(a),filterData:function(a,b){switch(this.dateType){case"day":return l.day(a,b);case"week":return l.week(a,b);case"month":return l.month(a,b)}}}),tickInterval:g(a),minTimestamp:a.minTimestamp,maxTimestamp:a.maxTimestamp},{name:_tr("Week"),value:e(a.weekData),percent:d(a.weekData,a.previousWeekData),data:i({max:moment.utc().startOf("day"),min:moment.utc().subtract("week",1).startOf("day").valueOf(),value:a.weekData,dateType:"day",filterData:l.day}),tickInterval:b.DAY,minTimestamp:moment.utc().subtract("week",1),maxTimestamp:moment.utc()},{name:_tr("Month"),value:e(a.monthData),percent:d(a.monthData,a.previousMonthData),data:i({max:moment.utc().startOf("day"),min:moment.utc().subtract("month",1).startOf("day").valueOf(),value:a.monthData,dateType:"day",filterData:l.day}),tickInterval:b.DAY,minTimestamp:moment.utc().subtract("month",1),maxTimestamp:moment.utc()},{name:_tr("3 Months"),value:e(a.threeMonthsData),percent:d(a.threeMonthsData,a.previousThreeMonthsData),data:i({max:moment.utc().startOf("day"),min:moment.utc().subtract("month",3).startOf("day").valueOf(),value:a.threeMonthsData,dateType:"week",filterData:l.week}),tickInterval:b.WEEK,minTimestamp:moment.utc().subtract("month",3),maxTimestamp:moment.utc()},{name:_tr("6 Months"),value:e(a.sixMonthsData),percent:d(a.sixMonthsData,a.previousSixMonthsData),data:i({max:moment.utc().startOf("day"),min:moment.utc().subtract("month",6).startOf("day").valueOf(),value:a.sixMonthsData,dateType:"week",filterData:l.week}),tickInterval:b.WEEK_THREE,minTimestamp:moment.utc().subtract("month",6),maxTimestamp:moment.utc()},{name:_tr("Year"),value:e(a.yearData),percent:d(a.yearData,a.previousYearData),data:i({max:moment.utc().startOf("day"),min:moment.utc().subtract("year",1).startOf("day").valueOf(),value:a.yearData,dateType:"month",filterData:l.month}),tickInterval:b.MONTH,minTimestamp:moment.utc().subtract("year",1),maxTimestamp:moment.utc()}]}function k(a,b){return a[0]-b[0]}var l={day:function(a,b){return a.filter(function(a){return moment.utc(a[0]).valueOf()===moment.utc(b).valueOf()})},week:function(a,b){return a.filter(function(a){return moment.utc(a[0]).week()===moment.utc(b).week()})},month:function(a,b){return a.filter(function(a){return moment.utc(a[0]).month()==moment.utc(b).month()})}},m={day:function(a,b){var c=l.day(a,b[0]),d=angular.copy(b);c.length?c[1]+=+d[1]:(d[0]=moment.utc(d[0]).startOf("day").valueOf(),a.push(d))},week:function(a,b){var c=l.week(a,b[0]),d=angular.copy(b);c.length?a[a.indexOf(c[0])][1]+=+d[1]:(d[0]=moment.utc(d[0]).startOf("week").valueOf(),a.push(d))},month:function(a,b){var c=l.month(a,b[0]),d=angular.copy(b);c.length?a[a.indexOf(c[0])][1]+=d[1]:(d[0]=moment.utc(d[0]).startOf("month").valueOf(),a.push(d))}};return{formatDate:c,getPercentage:d,getPeriodTotal:e,getPreparedAreaData:f,getModalOptions:j}}]),angular.module("kyc.charts").factory("PayingCustomers",["ChartType",function(a){function b(){h=[],i=[]}function c(a,b,c){var d=moment.utc(a.paid).valueOf();if(d>=b.valueOf()&&d<=c.valueOf()){var e=a.userId;-1===h.indexOf(e)?h.push(e):-1===i.indexOf(e)&&i.push(e)}}function d(){return h.length}function e(){return g}function f(){return{type:g,title:j,data:d()}}var g=a.NUMBER,h=[],i=[],j=_tr("Total Customers");return{getData:d,getType:e,setData:c,getHighChart:f,clearData:b}}]),angular.module("kyc.charts").factory("OrdersPerCustomer",["ChartType",function(a){function b(){h=[],i=[],j=0}function c(a,b,c){var d=moment.utc(a.paid);if(d>=b&&c>=d){j++;var e=a.userId;-1===h.indexOf(e)?h.push(e):-1===i.indexOf(e)&&i.push(e)}}function d(){return(j/h.length).toFixed(2)}function e(){return g}function f(){return{type:g,title:k,data:d()}}var g=a.NUMBER,h=[],i=[],j=0,k=_tr("Orders per Customer");return{getData:d,getType:e,setData:c,getHighChart:f,clearData:b}}]),angular.module("kyc.charts").factory("AverageOrderValue",["ChartType",function(a){function b(a,b,c){var d=moment.utc(a.paid);d>=b&&c>=d&&(i++,h+=a.total)}function c(){h=0,i=0}function d(){return(h/i).toFixed(2)}function e(){return g}function f(){return{type:g,title:j,data:d(),currency:"£"}}var g=a.NUMBER,h=0,i=0,j=_tr("Average Order Value");return{getData:d,getType:e,setData:b,getHighChart:f,clearData:c}}]),angular.module("kyc.charts").factory("ItemsOrdered",["ChartType",function(a){function b(a,b,c){var d=moment.utc(a.paid);d>=b&&c>=d&&angular.forEach(a.items,function(a){h+=a.qty})}function c(){return h}function d(){return g}function e(){return{type:g,title:i,data:c()}}function f(){h=0}var g=a.NUMBER,h=0,i=_tr("Items Ordered");return{getData:c,getType:d,setData:b,getHighChart:e,clearData:f}}]),angular.module("kyc.charts").factory("OrdersByOutlet",["ChartType","Colors","OutletService","ChartHelper",function(a,b,c){function d(){n=0,m={}}function e(a,b,c){p=b.valueOf(),q=c.valueOf();var d=moment.utc(a.paid);if(d>=b&&c>=d){var e=a.outletId;void 0===m[e]&&(m[e]={y:0}),m[e].y+=1}}function f(){n=0;var a=[];return angular.forEach(m,function(d,e){a.push({name:c.getOutletName(e),color:b[n],y:d.y}),n++}),a}function g(){return l}function h(){return{type:l,title:o,data:f(),getPdf:j,getCsv:i}}function i(){var a=f(),b=[[moment.utc(p).format("DD-MMM-YYYY")+" - "+moment.utc(q).format("DD-MMM-YYYY")],[o]];return angular.forEach(a,function(a){b.push([a.name,a.y])}),{data:b}}function j(){return{type:l,title:o,startDate:p,endDate:q,dataJson:JSON.stringify(f()),categories:k()}}function k(){var a=[];return angular.forEach(m,function(b,d){a.push(c.getOutletName(d))}),a}var l=a.PIE,m={},n=0,o=_tr("Orders By Outlet"),p=0,q=0;return{getData:f,getType:g,setData:e,getHighChart:h,clearData:d}}]),angular.module("kyc.charts").factory("MostPopularItems",["ChartType","Colors","ChartHelper",function(a,b){function c(){m={},q=[{y:0,color:b[0]},{y:0,color:b[1]},{y:0,color:b[2]},{y:0,color:b[3]},{y:0,color:b[4]}]}function d(a,b,c){o=b.valueOf(),p=c.valueOf();var d=moment.utc(a.paid);d>=b&&c>=d&&angular.forEach(a.items,function(a){void 0!==m[a.menuItemId]?m[a.menuItemId].quantity+=a.qty:m[a.menuItemId]={name:a.name,quantity:a.qty}})}function e(){for(var a in m)for(var b in q)if(m[a].quantity>q[b].y){for(var c=q.length-1;c>b;c--)q[c].y=q[c-1].y,q[c].name=q[c-1].name;q[b].y=m[a].quantity,q[b].name=m[a].name;break}q=_.filter(q,function(a){return void 0!==a.name})}function f(){return q}function g(){return l}function h(){return{type:l,title:n,data:f(),getPdf:j,getCsv:i}}function i(){var a=f(),b=[[moment.utc(o).format("DD-MMM-YYYY")+" - "+moment.utc(p).format("DD-MMM-YYYY")],[n]];return angular.forEach(a,function(a){b.push([a.name,a.y])}),{data:b}}function j(){return{type:l,title:n,startDate:o,endDate:p,dataJson:angular.toJson(f()),categories:k()}}function k(){var a=[];return angular.forEach(q,function(b){a.push(b.name)}),a}var l=a.PIE,m={},n=_tr("Most Popular Items"),o=0,p=0,q=[{y:0,color:b[0]},{y:0,color:b[1]},{y:0,color:b[2]},{y:0,color:b[3]},{y:0,color:b[4]}];return{getData:f,getType:g,setData:d,onSetDataComplete:e,getHighChart:h,clearData:c}}]),angular.module("kyc.charts").factory("TimeOfOrdersPlaced",["ChartType","Colors","ChartHelper",function(a,b){function c(){k=[{name:_tr("On the day"),y:0,color:b[0]},{name:_tr("In advance"),y:0,color:b[1]}],m=0}function d(a,b,c){o=b.valueOf(),p=c.valueOf();var d=moment.utc(a.paid);if(d>=b&&c>=d&&void 0!==a.paid&&void 0!==a.pickupTime){var e=moment.utc(a.paid).startOf("day").valueOf(),f=moment.utc(a.pickupTime).startOf("day").valueOf();e===f?k[0].y++:k[1].y++}}function e(){}function f(){return k}function g(){return l}function h(){return{type:l,title:n,data:f(),getPdf:j,getCsv:i}}function i(){var a=f(),b=[[moment.utc(o).format("DD-MMM-YYYY")+" - "+moment.utc(p).format("DD-MMM-YYYY")],[n]];return angular.forEach(a,function(a){b.push([a.name,a.y])}),{data:b}}function j(){return{type:l,title:n,startDate:o,endDate:p,dataJson:JSON.stringify(k),categories:[_tr("On the day"),_tr("In advance")]}}var k,l=a.PIE,m=0,n=_tr("Time of Orders Placed"),o=0,p=0;return{getData:f,getType:g,setData:d,onSetDataComplete:e,getHighChart:h,clearData:c}}]),angular.module("kyc.charts").factory("CustomersPie",["ChartType","Colors","ChartHelper",function(a,b){function c(){k=0,m=[{name:_tr("New"),y:0,color:b[0]},{name:_tr("Returning"),y:0,color:b[1]}],n=[],o=[]}function d(a,b,c){p=b.valueOf(),q=c.valueOf();var d=moment.utc(a.paid);if(d>=b&&c>=d){var e=a.userId;-1===n.indexOf(e)?(n.push(e),m[0].y++):-1===o.indexOf(e)&&(o.push(e),m[1].y++)}}function e(){return m}function f(){return j}function g(){return{type:j,title:l,data:e(),getPdf:i,getCsv:h}}function h(){var a=e(),b=[[moment.utc(p).format("DD-MMM-YYYY")+" - "+moment.utc(q).format("DD-MMM-YYYY")],[l]];return angular.forEach(a,function(a){b.push([a.name,a.y])}),{data:b}}function i(){return{type:j,title:l,startDate:p,endDate:q,dataJson:JSON.stringify(m),categories:[m[0].name,m[1].name]}}var j=a.PIE,k=0,l=_tr("Customers (Pie)"),m=[{name:_tr("New"),y:0,color:b[0]},{name:_tr("Returning"),y:0,color:b[1]}],n=[],o=[],p=0,q=0;return{getData:e,getType:f,setData:d,getHighChart:g,clearData:c}}]),angular.module("kyc.charts").factory("CustomersBar",["ChartType","ChartHelper",function(a){function b(a,b,c){n=b.valueOf(),o=c.valueOf();var d=moment.utc(a.paid);if(d>=b&&c>=d){var e=a.userId;-1===l.indexOf(e)?(l.push(e),k[0].y++):-1===m.indexOf(e)&&(m.push(e),k[1].y++)}}function c(){k=[{name:_tr("New"),y:0},{name:_tr("Returning"),y:0}],l=[],m=[]}function d(){return k}function e(){return i}function f(){return{type:i,title:j,data:d(),getPdf:h,getCsv:g}}function g(){var a=d(),b=[[moment.utc(n).format("DD-MMM-YYYY")+" - "+moment.utc(o).format("DD-MMM-YYYY")],[j]];return angular.forEach(a,function(a){b.push([a.name,a.y])}),{data:b}}function h(){return{type:i,title:j,startDate:n,endDate:o,dataJson:JSON.stringify([k[0].y,k[1].y]),categories:[k[0].name,k[1].name]}}var i=a.COLUMN,j=_tr("Customers (Bar)"),k=[{name:_tr("New"),y:0},{name:_tr("Returning"),y:0}],l=[],m=[],n=0,o=0;return{getData:d,getType:e,setData:b,getHighChart:f,clearData:c}}]),angular.module("kyc.charts").factory("NumberOfOrders",["ChartType","ChartHelper",function(a,b){function c(a){var b=moment.utc(a.paid).startOf("day").valueOf();m[b]?m[b]++:m[b]=1}function d(a,c){o=a.valueOf(),p=c.valueOf(),q=b.getPreparedAreaData(m,a,c)}function e(){return q.data}function f(){return l}function g(){return{type:l,title:n,data:e(),numberLeft:q.total,numberRight:b.getPercentage(e(),q.previousSpecifiedData),modal:k(),getPdf:h,getCsv:j,tooltipText:_tr(" orders")}}function h(){return{type:l,title:n,startDate:o,endDate:p,total:q.total,currency:"",percentage:b.getPercentage(q.data,q.previousSpecifiedData),dataJson:JSON.stringify(e())}}function i(){q={},m={}}function j(){var a=e(),c=[[moment.utc(o).format("DD-MMM-YYYY")+" - "+moment.utc(p).format("DD-MMM-YYYY")],[n]];return angular.forEach(a,function(a){c.push([b.formatDate(a[0]),a[1]])}),{data:c}}function k(){return{highcharts:{type:a.AREA_MODAL},options:b.getModalOptions(q)}}var l=a.AREA,m={},n=_tr("Number of Orders"),o=0,p=0,q={};return{getData:e,getType:f,clearData:i,setData:c,onSetDataComplete:d,getHighChart:g}}]),angular.module("kyc.charts").factory("MenuItemPopularity",["ChartType","ChartHelper",function(a,b){function c(a){var b=moment.utc(a.paid).startOf("day").valueOf();angular.forEach(a.items,function(a){void 0===r[a.menuItemId]&&(s=null===s?a.menuItemId:Number(s),u.push({name:a.name,menuItemId:a.menuItemId,callback:d}),r[a.menuItemId]={}),void 0===r[a.menuItemId][b]&&(r[a.menuItemId][b]=0),r[a.menuItemId][b]+=a.qty})}function d(a,b){s=a,window.sessionStorage.setItem("KYC_SELECTED_ITEM",a),e(n,o),b(h())}function e(a,c){n=a,o=c,t=b.getPreparedAreaData(r[s],n,o,!1)}function f(){return t.data}function g(){return p}function h(){return{type:p,title:q,selectedItem:l(s),data:f(),numberLeft:t.total,modal:m(),items:u,getPdf:j,getCsv:i,tooltipText:_tr(" orders")}}function i(){var a=f(),c=[[n.format("DD-MMM-YYYY")+" - "+o.format("DD-MMM-YYYY")],[l(s)]];return angular.forEach(a,function(a){c.push([b.formatDate(a[0]),a[1]])}),{data:c}}function j(){return{type:p,title:q+" - "+l(s),startDate:n.valueOf(),endDate:o.valueOf(),total:t.total,percentage:b.getPercentage(t.data,t.previousSpecifiedData),dataJson:JSON.stringify(f())}}function k(){t={},u=[],r={}}function l(a){var b=!1;return angular.forEach(u,function(c){c.menuItemId==a&&(b=c.name)}),b}function m(){return{highcharts:{type:a.AREA_MODAL},options:b.getModalOptions(t)}}var n,o,p=a.AREA,q=_tr("Menu Item Popularity"),r={},s=window.sessionStorage.getItem("KYC_SELECTED_ITEM"),t={},u=[];return{getData:f,getType:g,clearData:k,setData:c,onSetDataComplete:e,getHighChart:h}}]),angular.module("kyc.charts").factory("Revenue",["ChartType","ChartHelper",function(a,b){function c(a){var b=moment.utc(a.paid).endOf("day").valueOf();n[b]?n[b]+=a.total:n[b]=a.total}function d(a,c,d){l=d,q=a.valueOf(),r=c.valueOf(),p=b.getPreparedAreaData(n,a,c,!0)}function e(){return p.data}function f(){return m}function g(){return{type:m,title:o,data:e(),currency:l,numberLeft:p.total,numberRight:b.getPercentage(p.data,p.previousSpecifiedData),modal:k(),getPdf:j,getCsv:h,tooltipText:decodeURI(l)}}function h(){var a=e(),c=[[moment.utc(q).format("DD-MMM-YYYY")+" - "+moment.utc(r).format("DD-MMM-YYYY")],[o]];return angular.forEach(a,function(a){c.push([b.formatDate(a[0]),a[1]])}),{data:c}}function i(){n={},p={}}function j(){return{type:m,title:o,startDate:q,endDate:r,total:p.total,currency:l,percentage:b.getPercentage(p.data,p.previousSpecifiedData),dataJson:JSON.stringify(e())}}function k(){return{highcharts:{type:a.AREA_MODAL},options:b.getModalOptions(p)}}var l,m=a.AREA,n={},o=_tr("Revenue"),p={},q=0,r=0;return{getData:e,getType:f,clearData:i,setData:c,onSetDataComplete:d,getHighChart:g}}]),angular.module("kyc.reports").factory("AllReports",["$q","Report","NewCustomers","ZeroOrdersCustomers","OneTimeBuyers","MostFrequentBuyers","HighestSpendingCustomers","CustomersIncreasingOrders","CustomersIncreasingSpend","CustomersDecreasingOrders","CustomersDecreasingSpend","SleepingCustomers","MostPopularItemsReport","ItemPopularityIncrease","ItemPopularityDecrease","HighestGrossingDays","LowestGrossingDays","HighestOrderDays","LowestOrderDays","HighestOrderHours","HighestGrossingHours","VENUE_ID",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){function w(a){var b=[],c=a.getData();for(var d in c){angular.forEach(c[d],function(a,c){"$"!=String(c[0])&&b.push(c)}),a.setTitles(b);break}}function x(){var c=moment.utc().valueOf(),d=moment.utc().subtract("month",1).valueOf(),e=moment.utc().subtract("month",2).valueOf();return a.all([b.items({venueId:v}).$promise,b.orders({venueId:v}).$promise,b.customerOrders({venueId:v}).$promise,b.customerOrders({venueId:v,maxDate:c,minDate:d}).$promise,b.customerOrders({venueId:v,maxDate:d,minDate:e}).$promise])}function y(b){console.log("data",b),B.data={items:b[0],orders:z(b[1]),customerOrders:A(b[2],b[3],b[4])};var c=[];return angular.forEach(C,function(a){a.init&&c.push(a.init())}),a.all(c)}function z(a){return angular.forEach(a,function(a){a.day=moment.utc(a.paid).startOf("day").valueOf(),a.hour=moment.utc(a.paid).hour()}),a}function A(a,b,c){return console.log(a.length,b.length,c.length),angular.forEach(a,function(a){var d,e;for(var f in b)if(b[f].id===a.id){d=b[f];break}for(var f in c)if(c[f].id===a.id){e=c[f];break}d&&d.orders&&e&&e.orders&&(a.orderPercentage=100*d.orders/e.orders,a.orderPercentage=d.orders>e.orders?a.orderPercentage:-a.orderPercentage,a.totalPercentage=100*d.total/e.total,a.totalPercentage=d.total>e.total?a.totalPercentage:-a.totalPercentage)}),a}var B=function(){},C=[c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u],D={dateJoined:_tr("Date Joined"),name:_tr("Name"),email:_tr("Email Address"),marketing:_tr("Marketing"),dateOfOrder:_tr("Date of Order"),numberOfOrders:_tr("Number of Orders"),totalSpent:_tr("Total Spent"),percentIncrease:_tr("% Increase"),percentDecrease:_tr("% Decrease"),lastOrder:_tr("Last Order"),itemName:_tr("Item Name"),quantitySold:_tr("Quantity Sold"),day:_tr("Day"),date:_tr("Date"),valueSold:_tr("Value Sold")};return B.init=function(){var b=a.defer();return x().then(y).then(function(){angular.forEach(C,function(a){a.setData(B.data)}),angular.forEach(C,function(a){a.onSetDataComplete&&a.onSetDataComplete(),w(a),a.title=a.getTitle()}),b.resolve()}),b.promise},B.getTitle=function(a){return D[a]?D[a]:a},B.getReportsList=function(){return C},B}]),angular.module("kyc.reports").factory("NewCustomers",[function(){var a=_tr("New Customers"),b={},c={},d=[],e=moment.utc().subtract("week",2);return b.setData=function(a){angular.forEach(a.customerOrders,function(a){var b=moment.utc(a.created);(b>e||a.firstOrder>e)&&void 0===c[a.id]&&(c[a.id]={dateJoined:a.created,name:a.firstName+" "+a.lastName,email:a.username,marketing:a.optinLoyalty||a.optinOffers||a.optinOther})})},b.orderBy="dateJoined",b.direction=!1,b.description=_tr("Displays all new customers who have signed up, or had their first order, in the past two weeks."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("ZeroOrdersCustomers",["VenueCustomers","VENUE_ID",function(a,b){var c,d=_tr("Customers with zero orders"),e=[],f={},g={},h=[];return g.init=function(){return f={},h=[],c=a.query({id:b}),c.$promise},g.setData=function(a){angular.forEach(a.customerOrders,function(a){0===a.orders&&(f[a.id]={dateJoined:a.created,name:a.firstName+" "+a.lastName,email:a.username,marketing:a.optinLoyalty||a.optinOffers||a.optinOther})})},g.orderBy="dateJoined",g.direction=!1,g.description=_tr("Displays all customers who have signed up but have not yet placed any orders."),g.onSetDataComplete=function(){},g.getData=function(){return f},g.setTitles=function(a){e=a},g.getTitles=function(){return e},g.getTitle=function(){return d},g}]),angular.module("kyc.reports").factory("OneTimeBuyers",[function(){var a=_tr("One Time Buyers"),b={},c={},d=[];return b.setData=function(a){angular.forEach(a.customerOrders,function(a){void 0===c[a.id]&&1===a.orders&&(c[a.id]={dateJoined:a.created,dateOfOrder:a.firstOrder,name:a.firstName+" "+a.lastName,email:a.username,marketing:a.optinLoyalty||a.optinOffers||a.optinOther})})},b.orderBy="dateOfOrder",b.direction=!1,b.description=_tr("Displays all customers who have placed only one order."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("MostFrequentBuyers",[function(){var a=_tr("Most Frequent Buyers"),b={},c={},d=[];return b.setData=function(a){a.customerOrders.sort(function(a,b){return a.orders-b.orders}),angular.forEach(a.customerOrders,function(a){void 0===c[a.id]&&(c[a.id]={numberOfOrders:a.orders,name:a.firstName+" "+a.lastName,email:a.username,marketing:a.optinLoyalty||a.optinOffers||a.optinOther})})},b.orderBy="numberOfOrders",b.direction=!0,b.description=_tr("Displays top 50 customers who have placed the most number of orders."),b.getData=function(){return c
},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("HighestSpendingCustomers",[function(){var a=_tr("Highest Spending Customers"),b={},c={},d=[];return b.setData=function(a){angular.forEach(a.customerOrders,function(a){moment.utc(a.paid);void 0===c[a.id]&&(c[a.id]={totalSpent:null===a.total?0:a.total,name:a.firstName+" "+a.lastName,email:a.username,marketing:a.optinLoyalty||a.optinOffers||a.optinOther})})},b.orderBy="totalSpent",b.direction=!1,b.description=_tr("Displays top 50 customers who have the highest transactional spend."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("CustomersIncreasingOrders",[function(){var a=_tr("Customers Increasing Orders"),b={},c={},d=[];return b.setData=function(a){console.log(a),angular.forEach(a.customerOrders,function(a){void 0===c[a.id]&&!isNaN(a.orderPercentage)&&a.orderPercentage>0&&(c[a.id]={percentIncrease:a.orderPercentage.toFixed(0),name:a.firstName+" "+a.lastName,email:a.username,marketing:a.optinLoyalty||a.optinOffers||a.optinOther})}),console.log("set data",c)},b.orderby="percentIncrease",b.description=_tr("Displays all customers who placed more orders this month than the previous month."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("CustomersDecreasingOrders",[function(){var a=_tr("Customers Decreasing Orders"),b={},c={},d=[];return b.setData=function(a){angular.forEach(a.customerOrders,function(a){void 0===c[a.id]&&!isNaN(a.orderPercentage)&&a.orderPercentage<0&&(c[a.id]={percentDecrease:a.orderPercentage.toFixed(0),name:a.firstName+" "+a.lastName,email:a.username,marketing:a.optinLoyalty||a.optinOffers||a.optinOther})})},b.orderby="percentDecrease",b.description=_tr("Displays all customers who placed less orders this month than the previous month."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("CustomersIncreasingSpend",[function(){var a=_tr("Customers Increasing Spend"),b={},c={},d=[];return b.setData=function(a){console.log(a),angular.forEach(a.customerOrders,function(a){void 0===c[a.id]&&!isNaN(a.totalPercentage)&&a.totalPercentage>0&&(c[a.id]={percentIncrease:a.totalPercentage.toFixed(0),name:a.firstName+" "+a.lastName,email:a.username,marketing:a.optinLoyalty||a.optinOffers||a.optinOther})}),console.log("set data",c)},b.orderby="percentIncrease",b.description=_tr("Displays all customers who spent more this month than the previous month."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("CustomersDecreasingSpend",[function(){var a=_tr("Customers Decreasing Spend"),b={},c={},d=[];return b.setData=function(a){console.log(a),angular.forEach(a.customerOrders,function(a){void 0===c[a.id]&&!isNaN(a.totalPercentage)&&a.totalPercentage<0&&(c[a.id]={percentDecrease:a.totalPercentage.toFixed(0),name:a.firstName+" "+a.lastName,email:a.username,marketing:a.optinLoyalty||a.optinOffers||a.optinOther})})},b.orderby="percentDecrease",b.description=_tr("Displays all customers who spent less this month than the previous month."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("SleepingCustomers",[function(){var a=_tr("Sleeping Customers"),b={},c={},d=[],e=moment.utc().subtract("month",3);return b.setData=function(a){angular.forEach(a.customerOrders,function(a){void 0===c[a.id]&&moment.utc(a.lastOrder).valueOf()<e.valueOf()&&(c[a.id]={lastOrder:a.lastOrder,name:a.firstName+" "+a.lastName,email:a.username,marketing:a.optinLoyalty||a.optinOffers||a.optinOther})})},b.orderby="lastOrder",b.direction=!0,b.description=_tr("Displays all customers who have previously made at least one order, but haven’t ordered for 3 months."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("MostPopularItemsReport",[function(){var a=_tr("Most Popular Items"),b={},c={},d=[];return b.setData=function(a){angular.forEach(a.items,function(a){void 0===c[a.menuItemId]?c[a.menuItemId]={itemName:a.name,quantitySold:a.qty}:c[a.menuItemId].quantitySold+=a.qty})},b.orderBy="quantitySold",b.description=_tr("Displays top 10 most popular items."),b.direction=!0,b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("ItemPopularityIncrease",[function(){var a=_tr("Item Popularity Increase"),b={},c={},d={},e=[];return b.setData=function(a){var b=moment.utc().subtract("month",1).valueOf(),c=moment.utc().subtract("month",2).valueOf();angular.forEach(a.items,function(a){void 0===d[a.menuItemId]&&(d[a.menuItemId]={name:a.name,$thisMonthQuantitySold:0,$lastMonthQuantitySold:0});var e=moment.utc(a.paid).valueOf();e>=b?d[a.menuItemId].$thisMonthQuantitySold+=a.qty:e>c&&(d[a.menuItemId].$lastMonthQuantitySold+=a.qty)})},b.onSetDataComplete=function(){angular.forEach(d,function(a,b){if(a.$thisMonthQuantitySold>a.$lastMonthQuantitySold){var d=100*a.$thisMonthQuantitySold/a.$lastMonthQuantitySold;1/0===d&&(d=100),c[b]={itemName:a.name,quantitySold:a.$thisMonthQuantitySold,percentIncrease:d.toFixed(0)}}})},b.orderBy="percentIncrease",b.description=_tr("Displays all items that sold more this month than last month."),b.getData=function(){return c},b.setTitles=function(a){e=a},b.getTitles=function(){return e},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("ItemPopularityDecrease",[function(){var a=_tr("Item Popularity Decrease"),b={},c={},d={},e=[];return b.setData=function(a){var b=moment.utc().subtract("month",1).valueOf(),c=moment.utc().subtract("month",2).valueOf();angular.forEach(a.items,function(a){void 0===d[a.menuItemId]&&(d[a.menuItemId]={name:a.name,$thisMonthQuantitySold:0,$lastMonthQuantitySold:0});var e=moment.utc(a.paid).valueOf();e>=b?d[a.menuItemId].$thisMonthQuantitySold+=a.qty:e>c&&(d[a.menuItemId].$lastMonthQuantitySold+=a.qty)})},b.onSetDataComplete=function(){angular.forEach(d,function(a,b){if(a.$thisMonthQuantitySold<a.$lastMonthQuantitySold){var d=100*a.$thisMonthQuantitySold/a.$lastMonthQuantitySold;c[b]={itemName:a.name,quantitySold:a.$thisMonthQuantitySold,percentDecrease:100-d.toFixed(0)}}})},b.orderBy="percentDecrease",b.description=_tr("Displays all items that sold less this month than last month"),b.getData=function(){return c},b.setTitles=function(a){e=a},b.getTitles=function(){return e},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("HighestGrossingDays",[function(){var a=_tr("Highest Grossing Days"),b={},c=[],d=[],e=moment.utc().subtract("month",1),f=10;return b.setData=function(a){var b={},d=_.groupBy(a.orders,"day");angular.forEach(d,function(a,c){c>e.valueOf()&&angular.forEach(a,function(a){void 0===b[c]?b[c]={day:a.paid,date:a.paid,valueSold:a.total}:b[c].valueSold+=a.total})}),c=_.sortBy(b,function(a){return-a.valueSold}).slice(0,f)},b.orderBy="valueSold",b.description=_tr("Display top 10 highest grossing days."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("LowestGrossingDays",[function(){var a=_tr("Lowest Grossing Days"),b={},c=[],d=[],e=moment.utc().subtract("month",1),f=10;return b.setData=function(a){var b={},d=_.groupBy(a.orders,"day");angular.forEach(d,function(a,c){c>e.valueOf()&&angular.forEach(a,function(a){void 0===b[c]?b[c]={day:a.paid,date:a.paid,valueSold:a.total}:b[c].valueSold+=a.total})}),c=_.sortBy(b,function(a){return a.valueSold}).slice(0,f)},b.orderBy="valueSold",b.direction=!1,b.description=_tr("Display top 10 lowest grossing days."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports"),angular.module("kyc.reports").factory("HighestOrderDays",[function(){var a=_tr("Highest Order Days"),b={},c=[],d=[],e=moment.utc().subtract("month",1),f=10;return b.setData=function(a){var b={},d=_.groupBy(a.orders,"day");angular.forEach(d,function(a,c){c>e.valueOf()&&angular.forEach(a,function(a){void 0===b[c]?b[c]={day:a.paid,date:a.paid,numberOfOrders:1}:b[c].numberOfOrders++})}),c=_.sortBy(b,function(a){return-a.numberOfOrders}).slice(0,f)},b.orderBy="numberOfOrders",b.description=_tr("Display top 10 highest order days."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("LowestOrderDays",[function(){var a=_tr("Lowest Order Days"),b={},c=[],d=[],e=moment.utc().subtract("month",1),f=10;return b.setData=function(a){var b={},d=_.groupBy(a.orders,"day");angular.forEach(d,function(a,c){c>e.valueOf()&&angular.forEach(a,function(a){void 0===b[c]?b[c]={day:a.paid,date:a.paid,numberOfOrders:1}:b[c].numberOfOrders++})}),c=_.sortBy(b,function(a){return a.numberOfOrders}).slice(0,f)},b.orderBy="numberOfOrders",b.direction=!1,b.description=_tr("Display top 10 lowest order days."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("HighestGrossingHours",[function(){var a=_tr("Highest Grossing Hours"),b={},c=[],d=[],e=10;return b.setData=function(a){angular.forEach(a.orders,function(a){var b=moment.utc(a.paid).hour();void 0===c[b]&&(c[b]={timeSlot:moment.utc(a.paid).format("HH:00")+" - "+moment.utc(a.paid).format("HH:59"),valueSold:0}),c[b].valueSold+=a.total}),c=_.sortBy(c,function(a){return-a.valueSold}).slice(0,e)},b.orderBy="valueSold",b.description=_tr("Displays the accumulative total spent, broken down by 24 x 1 hour time slots."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.reports").factory("HighestOrderHours",[function(){var a=_tr("Highest Order Hours"),b={},c=[],d=[],e=10;return b.setData=function(a){angular.forEach(a.orders,function(a){var b=moment.utc(a.paid).hour();void 0===c[b]&&(c[b]={timeSlot:moment.utc(a.paid).format("HH:00")+" - "+moment.utc(a.paid).format("HH:59"),numberOfOrders:0}),c[b].numberOfOrders++}),c=_.sortBy(c,function(a){return-a.numberOfOrders}).slice(0,e)},b.orderBy="numberOfOrders",b.description=_tr("Displays the accumulative number of orders, broken down by 24 x 1 hour time slots."),b.getData=function(){return c},b.setTitles=function(a){d=a},b.getTitles=function(){return d},b.getTitle=function(){return a},b}]),angular.module("kyc.filters",[]).filter("interpolate",["version",function(a){return function(b){return String(b).replace(/\%VERSION\%/gm,a)}}]).filter("orderObjectBy",function(){return function(a,b,c){var d=[];return angular.forEach(a,function(a){d.push(a)}),d.sort(function(a,c){return a[b]>c[b]?1:-1}),c&&d.reverse(),d}}).filter("marketing",function(){return function(a){return 1===a?_tr("Active"):" - "}}).filter("timeAgo",function(){return function(a){"object"!=typeof a&&(a=moment.utc(a));var b,c=Math.floor((moment.utc()-a).valueOf()/1e3),d=Math.floor(c/31536e3);return d>=1?b=_tr(d>1?"years ago":"year ago"):(d=Math.floor(c/2592e3),d>=1?b=_tr(d>1?"months ago":"month ago"):(d=Math.floor(c/86400),d>=1?d>1?b=_tr("days ago"):(d="",b=_tr("yesterday")):(d=Math.floor(c/3600),d>=1?b=_tr(d>1?"hours ago":"hour ago"):(d=Math.floor(c/60),d>=1?b=_tr(d>1?"minutes ago":"minute ago"):(d=c,b=_tr(d>1?"seconds ago":"second ago")))))),d+" "+b}});