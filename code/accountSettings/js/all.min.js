angular.module("accountSettings.controllers",[]),angular.module("accountSettings.resources",["ngResource"]),angular.module("resources",["ngResource"]);var app=angular.module("accountSettings",["ngRoute","accountSettings.resources","accountSettings.controllers","loaders","mm.foundation","notification","resources","constants"]).run(["$rootScope",function(a){a.requests=0}]);app.config(["$routeProvider",function(a){console.log("prividing route"),a.when("/profile",{templateUrl:"/code/accountSettings/partials/profile.php",controller:"ProfileCtrl"}).when("/subscription",{templateUrl:"/code/accountSettings/partials/subscription.php",controller:"SubscriptionCtrl"}).when("/paymentMethod",{templateUrl:"/code/accountSettings/partials/payment.php",controller:"PaymentCtrl"}).when("/billingHistory",{templateUrl:"/code/accountSettings/partials/billingHistory.php",controller:"BillingCtrl"}).when("/changePassword",{templateUrl:"/code/accountSettings/partials/password.php",controller:"PasswordCtrl"}).otherwise({redirectTo:HAS_BILLING?"/subscription":"/profile"})}]),angular.module("accountSettings").directive("equals",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){if(d){a.$watch(c.ngModel,function(){e()}),c.$observe("equals",function(){e()});var e=function(){var a=d.$viewValue,b=c.equals;d.$setValidity("equals",a===b)}}}}}),angular.module("accountSettings.resources").factory("User",["$resource",function(a){var b=a("/api/users/:id",{id:"@id"},{put:{method:"PUT"}});return b}]),angular.module("accountSettings.resources").factory("Account",["$resource",function(a){var b=a("/api/accounts/:id",{id:"@id"},{put:{method:"PUT"}});return b}]),angular.module("accountSettings.resources").factory("AccountCard",["$resource",function(a){var b=a("/api/accounts/:accountId/accountcard",{accountId:"@accountId"},{put:{method:"PUT"}});return b}]),angular.module("accountSettings.resources").factory("AccountInvoice",["$resource",function(a){var b=a("/api/accounts/:accountId/invoices/:invoiceId",{accountId:"@accountId",invoiceId:"@invoiceId"},{payPending:{method:"POST",url:"/api/accounts/:accountId/invoices/payPending?isSubscription=0"},getPending:{method:"POST",url:"/api/accounts/:accountId/invoices/getSubscriptionInvoice"}});return b.prototype.getTotal=function(){return(this.vat+this.total).toFixed(2)},b}]),angular.module("accountSettings.resources").factory("AccountPackages",["$resource",function(a){var b=a("/api/accounts/:accountId/packages/:packageId",{accountId:"@accountId",packageId:"@packageId"},{put:{method:"PUT"}});return b}]),angular.module("accountSettings.controllers").controller("BillingCtrl",["$scope","ACCOUNT_ID","AccountInvoice",function(a,b,c){a.setSelected(a.Views.billingHistory),a.invoices=c.query({accountId:b},function(){a.finishLoading()}),a.getExportInvoice=function(a){return"/api/invoices/"+a+"/pdf"}}]),angular.module("accountSettings.controllers").controller("ProfileCtrl",["$scope","$q","$location","ACCOUNT_ID","USER_ID","User","Account",function(a,b,c,d,e,f,g){a.setSelected(a.Views.profile),a.isPosting=!1,a.isEditing=!1;var h;g.get({id:d},function(b){a.account=b}),f.get({id:e},function(b){a.user=b,h={firstName:a.user.firstName,lastName:a.user.lastName,email:a.user.email,name:a.user.name},a.$watch("user.firstName",function(b){a.user.name=b+" "+a.user.lastName}),a.$watch("user.lastName",function(b){a.user.name=a.user.firstName+" "+b}),a.finishLoading()}),a.changePassword=function(){c.path("/changePassword")},a.toggleEditUserDetails=function(b){a.isEditing||b||(h={firstName:a.user.firstName,lastName:a.user.lastName,email:a.user.email,name:a.user.name}),b&&(a.user.firstName=h.firstName,a.user.lastName=h.lastName,a.user.email=h.email,a.user.name=h.name,a.user.firstName=h.firstName),a.isEditing=!a.isEditing},a.saveChanges=function(){return a.isPosting=!0,a.triedSubmit=!0,a.profileForm.$valid?void b.all([a.user.$put(),a.account.$put()]).then(function(){a.isPosting=!1,a.isEditing=!1,noty({type:"success",text:_tr("Settings have been saved!")})},function(){a.isPosting=!1,noty({type:"error",layout:"topCenter",text:_tr("Sorry, but there's been an error processing your request.")})}):(a.isPosting=!1,!1)}}]),angular.module("accountSettings.controllers").controller("PasswordCtrl",["$scope","$q","$http","USER_ID","User","$location",function(a,b,c,d,e,f){function g(){a.triedSubmit&&(a.errorMessage=a.password.password!=a.newPasswordConfirm?_tr("Sorry, these password do not match. Please try again."):""===a.password.password||""===a.newPasswordConfirm||""===a.oldPassword?_tr("All the fields are required."):"")}a.isPosting=!1,a.oldIncorrect=!1,a.newPasswordConfirm="",a.errorMessage="",a.triedSubmit=!1,a.password={oldPassword:"",password:""},e.get({id:d},function(b){a.password.username=b.username,a.finishLoading()}),a.$watch("password.oldPassword",function(){a.oldIncorrect=!1}),a.$watch("user.lastName",g),a.$watch("newPasswordConfirm",g),a.cancel=function(){f.path("/profile")},a.saveChanges=function(){return a.triedSubmit=!0,a.passwordForm.$valid?(a.isPosting=!0,void c.post("/api/users/auth/change",a.password).success(function(){a.isPosting=!1,noty({type:"success",text:_tr("Settings and Password has been saved!<br/>You will need to log in again with your new password to continue.")}),setTimeout(function(){window.location.replace("/logout")},2500)}).error(function(b){a.isPosting=!1,401==b.status&&(a.oldIncorrect=!0,a.errorMessage="Sorry, the old password you entered was incorrect. Please try again!")})):(g(),!1)}}]),angular.module("accountSettings.controllers").controller("PaymentCtrl",["$scope","$q","$http","ACCOUNT_ID","AccountCard","Account","$AjaxInterceptor","AccountInvoice","$notification",function(a,b,c,d,e,f,g,h,i){function j(){c({method:"GET",url:"/api/config/app"}).success(function(a){Stripe.setPublishableKey(a.stripeKey)})}var k;a.setSelected(a.Views.paymentMethod),a.isEditing=!1,a.errorMessage="",e.get({accountId:d},function(b){a.card=b,a.finishLoading()},function(b){b.data&&404===b.data.status?(a.isEditing=!0,a.card=new e,a.finishLoading()):noty({type:"error",layout:"topCenter",text:_tr("Sorry, but there's been an error processing your request.")})});var l=function(){Stripe.card.createToken({name:a.card.name,number:a.card.number,cvc:a.card.ccv,exp_month:a.card.expmonth,exp_year:a.card.expyear},m)};a.startEditing=function(){k=a.card.number,a.card.number="",a.isEditing=!0},a.saveChanges=function(){return a.errorMessage="",a.triedSubmit=!0,a.isPosting=!0,a.paymentForm.$valid?(g.start(),void l()):(a.isPosting=!1,a.errorMessage=_tr("Please fill in all the required fields."),!1)};var m=function(b,c){function e(){a.errorMessage="",a.isEditing=!1,a.isPosting=!1,f.query({accountId:d},function(a){var b=a[0];moment().valueOf()>moment(b.billingDate).valueOf()?h.payPending({accountId:d},function(a){g.complete(),"SUCCESS"===a.status?h.get({accountId:d,invoiceId:a.invoiceId},function(a){i.confirm({title:_tr("Outstanding payment resolved"),scope:a,templateUrl:"subscriptionpayment.php",showTerm:!1,btnOk:!1,btnCancel:_tr("Ok"),windowClass:"small"})},function(){i.confirm({title:_tr("Payment method updated succesfully!"),content:_tr("Your outstand payment has been paid. Your card was charged <b>&pound;")+a.ammount.toFixed(2)+_tr("</b> and your premium features will remain active."),showTerm:!1,btnOk:!1,btnCancel:_tr("OK"),windowClass:"medium"})}):j(a)},j):(g.complete(),l())},j)}function j(b){if(console.log("error",b),noty({type:"error",layout:"topCenter",text:_tr("Sorry, but there's been an error processing your request.")}),a.isPosting=!1,a.isEditing=!0,a.card.number="",void 0!==b.response&&""!==b.response){var c=angular.fromJson(b.response);a.errorMessage=c.detail_message}g.complete()}function k(b){a.isPosting=!1,a.isEditing=!0,a.errorMessage=b.data.message,g.complete()}c.error?(a.isPosting=!1,a.errorMessage=c.error.message,a.$apply(),g.complete()):(a.card.token=c.id,a.card.number=c.card.last4,a.card.type=c.card.type,a.card.$save({accountId:d},e,k));var l=function(){var a=window.sessionStorage.getItem("featureCard");a&&"false"!==a&&(a=angular.fromJson(a),a.card=!0,window.sessionStorage.setItem("featureCard",angular.toJson(a)),window.location.assign("/shop"))}};a.cancelSaving=function(){a.card.number=k,a.isPosting=!1,a.isEditing=!1},j()}]),angular.module("accountSettings.controllers").controller("SubscriptionCtrl",["$scope","$q","$http","ACCOUNT_ID","AccountCard","Account","AccountPackages","$notification","$AjaxInterceptor","AccountInvoice",function(a,b,c,d,e,f,g,h,i,j){function k(c){b.all([g.query({accountId:d}).$promise,f.get({id:d}).$promise,j.getPending({accountId:d}).$promise]).then(function(b){a.accountPackages=b[0],a.account=b[1],a.subscriptionInvoice=b[2],n(),m(),c&&c(),e.get({accountId:d},function(b){a.card=b,a.finishLoading()},function(){a.card=!1,a.finishLoading()})},function(){p()})}function l(){var b=a.currentAccountPackage,c=b.status;b.status="UNINSTALLED",delete b.vat,b.$put({accountId:d,packageId:b.preoPackageId},function(){m()},function(){b.status=c,p()})}function m(){a.activePackagesCount=$.grep(a.accountPackages,function(a){return"CANCELED"!=a.status&&"REMOVED"!=a.status&&"EXPIRED"!=a.status}).length>0}function n(){if(a.account&&a.account.billingDate){var b=new Date(a.account.billingDate),c=new Date;a.diffInDays=b>c?0:14-Math.floor((c-b)/864e5)}else a.diffInDays=0}function o(b){if("CANCELED"===b.status){var c=b.preoPackage,d=1;c.contractMonths&&(d=c.contractMonths);var e=b.subscriptionPrice*d;console.log("subtotal",e);var f=.2*e,g=e+f;console.log("total",g),a.showDialog("resubscribePackage",b,{invoiceItems:[{description:c.name,price:e}],vat:f,total:e})}else a.currentAccountPackage=b,q()}function p(){noty({type:"error",layout:"topCenter",text:_tr("Sorry, but there's been an error processing your request.")})}a.setSelected(a.Views.subscription),a.diffInDays=0,k(),a.isInstalled=function(a){return!("CANCELED"===a.status||"REMOVED"===a.status||"EXPIRED"===a.status||"UNINSTALLED"===a.status)},a.isCanceled=function(a){return"CANCELED"===a.status||"EXPIRED"===a.status},a.isUninstaled=function(a){return"UNINSTALLED"==a.status||"CANCELED"===a.status||"EXPIRED"===a.status},a.showDialog=function(b,c,d){c&&(a.currentAccountPackage=c);var e,f,g;switch(b){case"cancelPackage":g={btnOk:_tr("CONFIRM"),btnCancel:_tr("CANCEL"),contentClass:"cancelPackage",modifyPositionButtons:!0,windowClass:"small"},e=function(){l()},g.content="TRIAL"==c.status?_tr("Your venue will be taken offline but you still be able to log in to your account if you ever want to resubscribe.")+"<br /><br />"+_tr("Are you sure you want to cancel?"):_tr("Your subscription will remain active until the end of the current billing cycle, you will no longer be billed after this date. Your venue will be taken offline but you will still be able to log in to account if you ever want to resubscribe.")+"<br /><br />"+_tr("Are you sure you want to cancel?");break;case"paymentError":g={title:_tr("Error"),content:a.paymentFailedMessage,showTerm:!1,btnOk:_tr("PAYMENT METHOD"),windowClass:"medium"},e=function(){a.navigateTo("/accountSettings#/paymentMethod")};break;case"updatePackage":g={btnOk:!1,btnCancel:!1,content:_tr("To upgrade your account, please contact ")+"<a href='mailto:"+EMAILS.SUPPORT+"'>"+EMAILS.SUPPORT+"</a>.",contentClass:"updatePackage",windowClass:"small"};break;case"paymentResolved":g={title:_tr("Payment resolved"),scope:d,templateUrl:"subscriptionpayment.php",showTerm:!1,btnOk:!1,btnCancel:_tr("Ok"),windowClass:"small"};break;case"resubscribePackage":g={title:_tr("Resubscription Details"),scope:d,templateUrl:"subscriptionpayment.php",showTerm:!1,btnOk:_tr("Ok"),btnCancel:!1,windowClass:"small"},e=function(){q()}}h.confirm(g).then(e,f)},a.navigateTo=function(a){a&&""!=a&&window.location.assign(a)},a.getTotalSubscription=function(){var b=0;return angular.forEach(a.accountPackages,function(a){("INSTALLED"==a.status||"TRIAL"==a.status)&&(b+=a.subscriptionPrice)}),b},a.getTrialPeriod=function(a){return moment(a.endDate).add(-1,"day").format("Do, MMMM YYYY")},a.resubscribePackage=function(a){o(a)};var q=function(){var b=a.currentAccountPackage.preoPackage;i.start(),e.get({accountId:d},function(c){c.token&&null!=c.token&&g.save({accountId:d,packageId:b.id},function(b){"SUCCESS"===b.status?k(function(){b.invoiceId?j.get({accountId:d,invoiceId:b.invoiceId},function(b){i.complete(),a.showDialog("paymentResolved",!1,b)}):i.complete()}):(i.complete(),a.paymentFailedMessage=b.response,a.showDialog("paymentError"))},function(){i.complete(),p()})},function(b){b.data&&404===b.data.status?a.showDialog("paymentError"):p()})}}]),angular.module("accountSettings.controllers").controller("MenuCtrl",["$scope","$AjaxInterceptor",function(a,b){b.start(),a.Views={profile:0,subscription:1,paymentMethod:2,billingHistory:3},a.currentView=a.Views.profile,a.setSelected=function(b){a.currentView=b},a.finishLoading=function(){b.complete()}}]),angular.module("loaders",[]).service("$AjaxInterceptor",["$rootScope","$timeout",function(a,b){function c(){var a=document.getElementsByClassName(".loading-content");if(a.length>0){(new Spinner).spin(a[0])}}return{start:function(){++a.requests,c()},complete:function(){b(function(){a.requests>0&&--a.requests},100)},isRequesting:function(){return a.requests>0}}}]),angular.module("resources").factory("AccountFeature",["$resource",function(a){var b=a("/api/accounts/:accountId/features/:featureId",{accountId:"@accountId",featureId:"@featureId"},{save:{method:"POST",params:{accountId:"@accountId",featureId:"@featureId",userId:"@userId",venueId:"@venueId",code:"@code"}},put:{method:"PUT"},getPrice:{method:"GET",url:"/api/accounts/:accountId/features/:featureId/price"}});return b.prototype.getLink=function(){return this.feature&&this.feature.$link?this.feature.$link:!1},b.prototype.isInContractPeriod=function(){if(this.feature&&this.feature.contractMonths){var a=moment(this.startDate),b=a.add(this.feature.contractMonths,"month");if(moment().valueOf()<b.valueOf())return!0}return!1},b.prototype.getContractEnd=function(){var a=moment(this.startDate),b=a.add(this.feature.contractMonths,"month");return b.toDate()},b}]),angular.module("notification",["ngSanitize"]).controller("confirmModalController",["$scope","$modalInstance","data","deffered","$http","$templateCache","$compile","$sce","$timeout","AccountFeature","ACCOUNT_ID","VENUE_ID","USER_ID",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n="/code/notification/templates/";if(a.title=c.title||"",a.discountCode="",a.appliedDiscount=!1,c.hasOwnProperty("templateFullUrl")&&c.templateFullUrl)angular.extend(a,c.scope);else if(c.hasOwnProperty("templateUrl")&&c.templateUrl){a.templateUrl=c.templateUrl;var o=function(b){i(function(){angular.element("#contentPartial").html(g(b)(a))})},p=f.get(n+c.templateUrl);p?o(p):e.get(n+c.templateUrl).then(function(a){f.put(n+c.templateUrl,a.data),o(a.data)})}else a.content=c.content||"";c.hasOwnProperty("scope")&&c.scope&&(a=angular.extend(a,c.scope)),a.toTrusted=function(a){return h.trustAsHtml(a||"")},a.showTerm=c.showTerm||!1,a.acceptTerm=!1,a.contentClass=c.contentClass||"",a.modifyPositionButtons=c.modifyPositionButtons||!1,a.btnOk=c.btnOk===!1?!1:c.btnOk||_tr("OK"),c.btnCancel===!1?c.btnCancel=!1:a.btnCancel=c.btnCancel||_tr("CANCEL"),a.changeTerm=function(b){a.acceptTerm=b},a.send=function(){b.close();var c={acceptTerm:a.acceptTerm};a.appliedDiscount&&(c.discountCode=a.discountCode),d.resolve(c)},a.cancel=function(){b.close(),d.reject({acceptTerm:a.acceptTerm})},a.validateDiscountCode=function(){a.errorMsg="",a.discountCode||(a.errorMsg=_tr("Please enter a discount code")),j.getPrice({accountId:k,featureId:a.featureId,code:a.discountCode.toUpperCase(),venueId:l,userId:m},function(b){angular.extend(a,b),a.appliedDiscount=!0},function(b){400===b.status&&b.data&&(a.errorMsg=b.data.message)})}}]).service("$notification",["$modal","$q","$sce",function(a,b){var c="/code/notification/templates/",d=function(d){var e=b.defer();d=d||{},d.hasOwnProperty("templateFullUrl")&&d.templateFullUrl&&(d.templateFullUrl=c+d.templateFullUrl);var f=a.open({templateUrl:d.templateFullUrl||"/code/notification/notification.php",windowClass:"modal-preoday "+(d.windowClass||""),controller:"confirmModalController",resolve:{data:function(){return d},deffered:function(){return e}}});return f.opened.then(function(){setTimeout(function(){$(".modal-preoday").addClass("active")},400)}),e.promise};return{confirm:d}}]);