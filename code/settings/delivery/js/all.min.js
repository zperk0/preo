angular.module("delivery",["ngResource","ngRoute","delivery.resources","delivery.controllers","delivery.directives","constants"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"/code/settings/delivery/partials/delivery.php",controller:"deliveryController"}),a.when("/notifications",{templateUrl:"/code/settings/delivery/partials/notifications.php",controller:"notificationCtrl"}),a.otherwise({redirectTo:"/"})}]);var messagesAlert={notify:[{content:_tr("Your order is running 15 mins late"),name:_tr("Late Order"),type:"ORDER_NOTIFY"},{content:_tr("Your order is on its way"),name:_tr("En-route"),type:"ORDER_NOTIFY"},{content:_tr("There is a problem with your order. Please call us"),name:_tr("Call us"),type:"ORDER_NOTIFY"}],reject:[{content:_tr("Your address is out of our delivery zone"),name:_tr("Out of zone"),type:"ORDER_REJECT"},{content:_tr("Sorry, that item is out of stock"),name:_tr("Out of stock"),type:"ORDER_REJECT"},{content:_tr("Sorry, Your order has been rejected. Please call us"),name:_tr("Call us"),type:"ORDER_REJECT"}]};angular.module("delivery.resources",["ngResource"]).factory("Resources",["$resource",function(a){var b=a("/api/venues/:id",{id:"@id"},{put:{method:"PUT"}}),c=a("/api/venues/:id/settings",{id:"@id"},{put:{method:"PUT"}}),d=a("/api/venues/:venueId/messages/:id",{venueId:"@venueId",id:"@id"},{put:{method:"PUT"}});return{Venue:b,VenueSettings:c,VenueMessages:d}}]),angular.module("delivery.controllers",[]).controller("deliveryController",["$scope","$http","Resources","$q","VENUE_ID","$rootScope",function(a,b,c,d,e,f){function g(a){var b=new c.VenueMessages;return b.content=a.content,b.name=a.name,b.type=a.type,b.orderType=a.type,b.$save({venueId:e})}a.isPosting=!1,a.triedSubmit=!1,f.requests=2,a.venue=c.Venue.get({id:e},function(){--f.requests},function(){console.log("error",arguments)}),++f.requests;var h=0,i=!1;c.VenueMessages.query({venueId:e},function(a){h=a.length,--f.requests});var j=c.VenueSettings.get({id:e},function(b){a.venueSettings=b,--f.requests},function(){console.log("error",arguments)}),k=messagesAlert.notify.concat(messagesAlert.reject);a.processForm=function(){if(a.isPosting=!0,a.triedSubmit=!0,!a.deliveryForm.$valid)return a.isPosting=!1,!1;delete a.venue.ccySymbol;var b=[c.Venue.put({id:e},a.venue).$promise,c.VenueSettings.put({id:e},j).$promise];i&&1==a.venue.deliverFlag&&0==h&&(b.push(g(k[0]).$promise),b.push(g(k[1]).$promise),b.push(g(k[2]).$promise),b.push(g(k[3]).$promise),b.push(g(k[4]).$promise),b.push(g(k[5]).$promise),h=6),++f.requests,d.all(b).then(function(){--f.requests,a.isPosting=!1,noty({type:"success",layout:"topCenter",text:_tr("Successfully saved delivery settings.")})},function(){a.isPosting=!1,noty({type:"error",layout:"topCenter",text:_tr("Sorry, but there's been an error processing your request.")})})},a.onChangeDeliverFlag=function(){i=!0}}]).controller("notificationCtrl",["$scope","$http","Resources","$q","VENUE_ID","$rootScope",function(a,b,c,d,e,f){function g(a){return a.id?""!==a.name.trim()&&""!==a.content.trim()?a.$put():a.$remove():a.name&&""!=a.name.trim()&&a.content&&""!==a.content.trim()?a.$save({venueId:e}):!0}a.isPosting=!1,a.selected=1,a.triedSubmit=!1,f.requests=1;var h={notify:["ORDER_NOTIFY"],reject:["ORDER_REJECT"]};a.venue=c.Venue.get({id:e},function(){},function(){console.log("error",arguments)});c.VenueMessages.query({venueId:e},function(b){a.messages={notify:[],reject:[]};for(var d=0,e=0,g=0;6>g;g++)if(b.length>g){var i=b[g];console.log(i),h.notify.indexOf(i.type)>-1?(a.messages.notify.push(i),d++):(a.messages.reject.push(i),e++)}else if(3>d){var j=new c.VenueMessages({name:"",content:"",type:h.notify[0],active:0});d++,a.messages.notify.push(j)}else{var j=new c.VenueMessages({name:"",content:"",type:h.reject[0],active:0});e++,a.messages.reject.push(j)}f.requests=0,console.log(a.messages),a.finishedLoading=!0},function(){console.log("error",arguments)});a.validateMessage=function(b){var c=Boolean(b.content)?!Boolean(b.name):Boolean(b.name);return c&&a.triedSubmit},a.validateEmail=function(a){if(!a||!a.length)return!0;var b=new RegExp(/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/);return b.test(a)},a.validateActive=function(a){return a&&a.name&&a.content?""===a.name.trim()&&""===a.content.trim()?(a.active=0,!1):!0:(a.active=0,!1)},a.processForm=function(){if(a.isPosting=!0,a.triedSubmit=!0,!a.deliveryForm.$valid)return a.isPosting=!1,!1;if(a.venue.notificationEmailAddress&&!a.validateEmail(a.venue.notificationEmailAddress))return noty({type:"error",layout:"topCenter",text:_tr("Email is invalid")}),a.isPosting=!1,!1;var b=a.messages.reject.concat(a.messages.notify);for(var c in b)delete b[c].typeString,delete b[c].suppressed;delete a.venue.ccySymbol,d.all([a.venue.$put(),g(b[0]).$promise,g(b[1]).$promise,g(b[2]).$promise,g(b[3]).$promise,g(b[4]).$promise,g(b[5]).$promise]).then(function(){a.isPosting=!1,noty({type:"success",layout:"topCenter",text:_tr("Successfully saved delivery settings.")})},function(){a.isPosting=!1,noty({type:"error",layout:"topCenter",text:_tr("Sorry, but there's been an error processing your request.")})})},a.getPlaceholder=function(a,b){return messagesAlert[a][b]}}]);var directives=angular.module("delivery.directives",[]);directives.directive("percent",["$filter",function(a){var b=function(b){var c=b.match(/^(\d+)/);return null!==c?a("number")(parseFloat(b)/100):void 0},c=function(b){return a("number")(100*parseFloat(b))};return{require:"ngModel",link:function(a,d,e,f){f.$parsers.unshift(b),f.$formatters.unshift(c)}}}]),directives.directive("currency",function(){function a(a,c,d,e){function f(a){var b=Math.pow(10,k);return Math.round(a*b)/b}function g(a){return parseFloat(a).toFixed(k)}function h(a){return e.$isEmpty(a)?"":""+a}var i,j=parseFloat(d.min||0),k=parseFloat(d.precision||2);e.$parsers.push(function(a){0===a.indexOf(".")&&(a="0"+a),0===a.indexOf("-")&&(j>=0?(a=null,e.$setViewValue(""),e.$render()):"-"===a&&(a=""));var c=e.$isEmpty(a);return c||b.test(a)?i=""===a?null:c?a:parseFloat(a):(e.$setViewValue(h(i)),e.$render()),e.$setValidity("number",!0),i}),e.$formatters.push(h);var l=function(a){return!e.$isEmpty(a)&&j>a?void e.$setValidity("min",!1):(e.$setValidity("min",!0),a)};if(e.$parsers.push(l),e.$formatters.push(l),d.max){var m=parseFloat(d.max),n=function(a){return!e.$isEmpty(a)&&a>m?void e.$setValidity("max",!1):(e.$setValidity("max",!0),a)};e.$parsers.push(n),e.$formatters.push(n)}k>-1&&(e.$parsers.push(function(a){return a?f(a):a}),e.$formatters.push(function(a){return a?g(a):a})),c.bind("blur",function(){var a=e.$modelValue;a&&(e.$viewValue=g(a),e.$render())})}var b=/^\s*(\-|\+)?(\d+|(\d*(\.\d*)))\s*$/;return{restrict:"A",require:"ngModel",link:a}});